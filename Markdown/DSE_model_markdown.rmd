---
title: "Discrete Event Simulation - Kidney Stone Follow Up"
subtitle: "All Patients"
author: "R Geraghty"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
    fig_height: 10
    number_sections: true
    code_folding: TRUE
---

# Setup
```{r setup, include=FALSE}
library(gt)
library(gtExtras)
library(tidyverse)
library(DiagrammeR)
library(data.table)
library(janitor)
library(DataExplorer)
library(pROC)
library(ggplot2)
library(pracma)
library(glue)
library(cutpointr)
library(caret)
library(cowplot)
library(cutpointr)
library(ggsignif)
library(ggpubr)
library(broom)
```
\newpage

# Define Inputs
## Years of Follow-up
5 years of follow-up as per EAU guidance \
```{r}
follow_up_years <- 5
```
\newpage

## Define Recurrence metrics
### Recurrence rates as per UKB over 5 years 
```{r}
rec_prop <- 0.5
```
\newpage

### Recurrence (intervention or colic) rates from literature over 5 years
Estimated Recurrence rates as per SF status \
As per Tzelves et al. 2023, Eur Urol Focus - 5 year rates of recurrence: \
```{r}
sf_5yr_recurrence <- 0.25 # Sorensen et al. 2022 / Tzelves et al. 2023
less4_5yr_recurrence <- 0.425 # Tzelves et al. 2023
more4_5yr_recurrence <- 0.66 # Tzelves et al. 2023  

sf_prop <- 0.725
less4_prop <- 0.247
more4_prop <- 0.028


sf_5yr_event_rate <- 0.25
less4_5yr_event_rate <- 0.425
more4_5yr_event_rate <- 0.66
```
\newpage

### Estimate global 5 yr event rate
```{r}
global_rec_rate <- (sf_prop*sf_5yr_event_rate) + (less4_prop*less4_5yr_event_rate) + (more4_prop*more4_5yr_event_rate)
global_rec_rate <- round(global_rec_rate, digits = 3)
global_rec_rate
```
\newpage

### Define Risk Status Parameters as per UKB ####
```{r}
risk_status_proportion_low <- 0.36 # as per data from UKB
risk_status_proportion_high <- 0.64
```
\newpage

### Recurrence Rates from UKB
```{r}
recurrence_rate_low <- 0.44 # 44% recurrence for low-risk patients over 5 years
annual_recurrence_rate_low <- recurrence_rate_low / 5
recurrence_rate_high <- 0.53  # 53% recurrence for high-risk patients over 5 years
annual_recurrence_rate_high <- recurrence_rate_high / 5
annual_recurrence_rate <- 0.5 / 5
```
\newpage

## Population and Incidence Data
### Read in ONS data for England
```{r}
ons_population_estimates <- fread("~/Desktop/Sayer/Economics/population_estimates_ons.csv") %>% as_tibble() %>% janitor::clean_names()
ons_population_estimates <- ons_population_estimates %>% subset(laname23 == "ENGLAND") %>% subset(select = -c(ladcode23, laname23, country))
ons_population_estimates <- ons_population_estimates %>%
  mutate(across(
    .cols = matches("^population_\\d{4}$"),
    .fns = ~ as.numeric(gsub(",", "", .))
  ))
```
\newpage

### Calculate English Population per year
```{r}
total_population <- ons_population_estimates %>% mutate(
  total_pop_2011 = sum(population_2011),
  total_pop_2012 = sum(population_2012),
  total_pop_2013 = sum(population_2013),
  total_pop_2014 = sum(population_2014),
  total_pop_2015 = sum(population_2015),
  total_pop_2016 = sum(population_2016),
  total_pop_2017 = sum(population_2017),
  total_pop_2018 = sum(population_2018),
  total_pop_2019 = sum(population_2019),
  total_pop_2020 = sum(population_2020),
  total_pop_2021 = sum(population_2021),
  total_pop_2022 = sum(population_2022)
) %>% slice_head(n = 1) %>% subset(
  select = c(
    total_pop_2011,
    total_pop_2012,
    total_pop_2013,
    total_pop_2014,
    total_pop_2015,
    total_pop_2016,
    total_pop_2017,
    total_pop_2018,
    total_pop_2019,
    total_pop_2020,
    total_pop_2021,
    total_pop_2022
  )
)

total_population <- total_population %>%
  mutate(row_id = row_number()) %>%
  pivot_longer(-row_id, names_to = "column", values_to = "value") %>% separate(column, into = c("total", "pop", "year")) %>% subset(select = c(year, value)) %>% rbind(c(2023, 68265200))

ons_english_population_estimates <- fread("~/Desktop/Sayer/Economics/england_pop_mid_year_estimates_ons.csv") %>% as_tibble() %>% janitor::clean_names()
ons_english_population_estimates <- ons_english_population_estimates[-1:-7, ]
colnames(ons_english_population_estimates) <- c("year", "england_mye_population_estimate")
ons_english_population_estimates$england_mye_population_estimate <- as.numeric(ons_english_population_estimates$england_mye_population_estimate)
ons_english_population_estimates$year <- as.integer(ons_english_population_estimates$year)
```
\newpage

### Calculate Expected number of people with KSD per year with 1% incidence
```{r}
KSD_patients_total_n <- ons_english_population_estimates %>% subset(year > 2010) %>% mutate(total_patients = england_mye_population_estimate * 0.01) 

# Use lower estimate of 1% incidence)

KSD_patients_total_n %>% gt() %>% gt_theme_nytimes()
```
\newpage

## Numbers undergoing intervention as per HES data
### Read in HES data
```{r}
hes_data_elective <- fread("~/Desktop/Sayer/Economics/intervention_hes_data_elective.csv") %>%
  as_tibble() %>% 
  janitor::clean_names() %>% 
  subset(select = c(finy, urs, pcnl, eswl))

hes_data_elective_emergency <- fread("~/Desktop/Sayer/Economics/intervention_hes_data_elective_and_emergency.csv") %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  subset(select = c(finy, urs, pcnl, eswl)) %>% 
  slice_head(n = 13)


hes_data_elective_emergency <- hes_data_elective_emergency %>% 
  separate(finy, into = c("year",
                          "extra")) %>% 
  subset(select = -extra) %>% 
  mutate(total_treatment_n = urs + pcnl + eswl, 
         .keep = "all")

hes_data_elective_emergency$year <- as.integer(hes_data_elective_emergency$year)

hes_data_elective_emergency <- hes_data_elective_emergency %>% 
  left_join(KSD_patients_total_n, 
            by = c("year" = "year")) %>% 
  select(year,
         england_mye_population_estimate,
         total_patients,
         everything())
```
\newpage

### Intervention type distribution
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  eswl_proportion = eswl / total_treatment_n,
  urs_proportion = urs / total_treatment_n,
  pcnl_proportion = pcnl / total_treatment_n,
  .keep = "all"
)
```
\newpage

### Intervention outcomes
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  eswl_stone_free = eswl * 0.5,
  eswl_residual_stones = eswl * 0.5,
  .keep = "all"
)
```
\newpage

### Residual Stone/Fragments Outcomes
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  eswl_residual_asymptomatic = eswl_residual_stones * 0.5,
  eswl_residual_symptomatic = eswl_residual_stones * 0.5,
  urs_stone_free = urs * 0.6,
  urs_residual_stones = urs * 0.4,
  urs_residual_asymptomatic = urs_residual_stones * 0.5,
  urs_residual_symptomatic = urs_residual_stones * 0.5,
  pcnl_stone_free = pcnl * 0.74,
  pcnl_residual_stones = pcnl * 0.26,
  pcnl_residual_asymptomatic = pcnl_residual_stones * 0.5,
  pcnl_residual_symptomatic = pcnl_residual_stones * 0.5,
  .keep = "all"
)
```
\newpage

### Spontaneous passage numbers
Assume 50% of those with spontaneous passage are SF after \
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  spontaneous_passage_n = total_patients - total_treatment_n,
  spontaneous_passage_stone_free = spontaneous_passage_n * 0.74,
  total_sf_patients = spontaneous_passage_stone_free + pcnl_stone_free + urs_stone_free + eswl_stone_free,
  .keep = "all"
)
```
\newpage

### Calculate patients in each risk category
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  total_patients_low_risk = total_patients * risk_status_proportion_low,
  total_patients_high_risk = total_patients * risk_status_proportion_high,
  .keep = "all"
)
```
\newpage

### Recurrence Calculations
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% 
  mutate(
  patients_with_recurrence_low = total_patients_low_risk * recurrence_rate_low,
  patients_with_recurrence_high = total_patients_high_risk * recurrence_rate_high,
  .keep = "all"
)
```
\newpage

### Combine total recurrence
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% 
  mutate(
  patients_with_recurrence = patients_with_recurrence_low + patients_with_recurrence_high,
  .keep = "all"
)
```
\newpage

### Symptomatic vs Asymptomatic Breakdown
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  asymptomatic_patients_low = patients_with_recurrence_low * 0.7,
  symptomatic_patients_low = patients_with_recurrence_low * 0.3,
  asymptomatic_patients_high = patients_with_recurrence_high * 0.7,
  symptomatic_patients_high = patients_with_recurrence_high * 0.3,
  .keep = "all"
)
```
\newpage

### Combine symptomatic and asymptomatic patients
```{r}
hes_data_elective_emergency <- hes_data_elective_emergency %>% mutate(
  asymptomatic_patients = asymptomatic_patients_low + asymptomatic_patients_high,
  symptomatic_patients = symptomatic_patients_low + symptomatic_patients_high,
  .keep = "all"
)
```
\newpage

## Death rates
### Read in ONS data and define dataset
```{r}
death_rates_ons <- fread("~/Desktop/Sayer/Economics/death_rates_ons.csv") %>% as_tibble() %>% janitor::clean_names()

death_rates_ons <- death_rates_ons %>% cbind(
  Age_range = c(
    "<1",
    "1-4",
    "5-9",
    "10-14",
    "15-19",
    "20-24",
    "25-29",
    "30-34",
    "35-39",
    "40-44",
    "45-49",
    "50-54",
    "55-59",
    "60-64",
    "65-69",
    "70-74",
    "75-79",
    "80-84",
    "85-90",
    ">90"
  )
) %>% select(Age_range, sex, everything()) %>% subset(
  select = -c(
    age,
    x2013,
    x2014,
    x2015,
    x2016,
    x2017,
    x2018,
    x2019,
    x2020,
    x2021,
    x2022,
    x2023
  )
)

colnames(death_rates_ons) <- c(
  "Age_range",
  "sex",
  "thirteen",
  "fourteen",
  "fifteen",
  "sixteen",
  "seventeen",
  "eighteen",
  "nineteen",
  "twenty",
  "twentyone",
  "twentytwo",
  "twentythree"
)

death_rates_ons <- death_rates_ons %>% mutate(
  "thirteen" = thirteen / 100,
  "fourteen" = fourteen / 100,
  "fifteen" = fifteen / 100,
  "sixteen" = sixteen / 100,
  "seventeen" = seventeen / 100,
  "eighteen" = eighteen / 100,
  "nineteen" =  nineteen / 100,
  "twenty" = twenty / 100,
  "twentyone" = twentyone / 100,
  "twentytwo" = twentytwo / 100,
  "twentythree" = twentythree / 100
)

death_rates_ons <- death_rates_ons %>% subset(Age_range != "<1")

death_rates_ons$Age_range <- factor(
  death_rates_ons$Age_range,
  levels = c(
    "1-4",
    "5-9",
    "10-14",
    "15-19",
    "20-24",
    "25-29",
    "30-34",
    "35-39",
    "40-44",
    "45-49",
    "50-54",
    "55-59",
    "60-64",
    "65-69",
    "70-74",
    "75-79",
    "80-84",
    "85-90",
    ">90"
  ),
  ordered = TRUE
)

death_rates_ons$sex <- as.factor(death_rates_ons$sex)

death_rates_ons %>% gt() %>% gt_theme_nytimes()
```
\newpage

## Renal colic presentations without intervention
##### HES data from Jour et al. 2022 - PMID: 35306719 & Data on those NOT undergoing intervention from Schoenfeld et al. 2019 - PMID: 31790565 \

```{r}
hes_colic_data <- cbind(
  year = c(2016, 2017, 2018, 2019, 2020),
  colic_n = c(
    39941,
    #N20.1 Calculus of ureter + N20.2 Calculus of kidney and ureter + N23.X Unspecified renal colic
    40702,
    #Presume that those NOT undergoing emergency procedures are managed conservatively
    40524,
    41936,
    41556
  ),
  emergency_procedures_n = c(1897, 2118, 2274, 2334, 2659),
  elective_procedures_n = c(40403, 40898, 40985, 40857, 41199)
) %>% as_tibble() %>% mutate(
  conservative_mx_n = colic_n - emergency_procedures_n,
  conservative_mx_prop = conservative_mx_n / colic_n,
  .keep = "all"
)

hes_data_elective_emergency <- hes_data_elective_emergency %>% left_join(
  hes_colic_data, by = c("year" = "year")) %>% mutate(
    colic_sf = colic_n * 0.8, #from MIMIC
    colic_nsf = colic_n * 0.2,
    clinically_significant_n = colic_n + urs + pcnl + eswl,
    total_sf_clin_signif = colic_sf + urs_stone_free + pcnl_stone_free + eswl_stone_free
  )

```
\newpage

## Define total numbers entering models
Summarised from above \
```{r}
total_n_2016 <- 552890
total_n_2017 <- 556195
total_n_2018 <- 559245
total_n_2019 <- 562301
total_n_2020 <- 563260

total_sf_n_2016 <- 402558
total_sf_n_2017 <- 405095
total_sf_n_2018 <- 407516
total_sf_n_2019 <- 409571
total_sf_n_2020 <- 411895

clinically_signif_n_2016 <- 82581
clinically_signif_n_2017 <- 83701
clinically_signif_n_2018 <- 83620
clinically_signif_n_2019 <- 85501
clinically_signif_n_2020 <- 71902

clinically_signif_sf_n_2016 <- 56926
clinically_signif_sf_n_2017 <- 57891
clinically_signif_sf_n_2018 <- 57985
clinically_signif_sf_n_2019 <- 59255
clinically_signif_sf_n_2020 <- 50783
```
\newpage

## Costs
### Costs derived from NHS National tariff 2022-23 Annex A unless otherwise specified
\newpage

### Clinic costs
```{r}
initial_consultation_cost <- 145  # First appointment
clinic_review_cost <- 71  # Follow-up appointment
imaging_cost <- 27  # Direct access plain film X-ray (as per 22-23 non mandatory guide prices)
us_cost <- 43 # Ultrasound Scan with duration of less than 20 minutes, without Contrast (RD40Z)
ct_cost <-  69 # Computerised Tomography Scan of One Area, without Contrast, 19 years and over (RD20A)
urine_24_hr_cost <- 190.5 # From Gateshead Biochemistry lab
```
\newpage

### Intervention costs
```{r}
eswl_cost <- 445 * 2  # assume 2 ESWL treatments (LB36Z)
urs_cost <- 2386  # median cost for URS (LB65D)
pcnl_cost <- 4548  # cost for CC 0-2 (LB75B)
stent_cost <- 822 # intermediate endoscopic bladder procedures (LB14Z)
```
\newpage

### Acute presentation costs
```{r}
ed_presentation_cost <- 288 #  Category 3 Investigation with Category 1-3 Treatment
```
\newpage

### Follow-up costs for low risk disease
#### Costs associated with 'low risk' disease (as per EAU) - XR FU
```{r}
year_1_lr_sf_fu_cost_xr <- 2 * (clinic_review_cost + imaging_cost)
year_2_lr_sf_fu_cost_xr <- 0
year_3_lr_sf_fu_cost_xr <- 1 * (clinic_review_cost + imaging_cost)
year_4_lr_sf_fu_cost_xr <- 1 * (clinic_review_cost + imaging_cost)
year_5_lr_sf_fu_cost_xr <- 1 * (clinic_review_cost + imaging_cost)

year_1_lr_less4_fu_cost_xr <- 2 * (clinic_review_cost + imaging_cost)
year_2_lr_less4_fu_cost_xr <- clinic_review_cost + imaging_cost
year_3_lr_less4_fu_cost_xr <- clinic_review_cost + imaging_cost
year_4_lr_less4_fu_cost_xr <- clinic_review_cost + imaging_cost
year_5_lr_less4_fu_cost_xr <- clinic_review_cost + imaging_cost


year_1_lr_more4_fu_cost_xr <- 2 * (clinic_review_cost + imaging_cost)
year_2_lr_more4_fu_cost_xr <- 2 * (clinic_review_cost + imaging_cost)
year_3_lr_more4_fu_cost_xr <- clinic_review_cost + imaging_cost
year_4_lr_more4_fu_cost_xr <- clinic_review_cost + imaging_cost
year_5_lr_more4_fu_cost_xr <- clinic_review_cost + imaging_cost
```
\newpage

#### Costs associated with 'low risk' disease (as per EAU) - XR + US FU
```{r}
year_1_lr_sf_fu_cost_xr_us <- 2 * (clinic_review_cost + imaging_cost + us_cost)
year_2_lr_sf_fu_cost_xr_us <- 0
year_3_lr_sf_fu_cost_xr_us <- 1 * (clinic_review_cost + imaging_cost + us_cost)
year_4_lr_sf_fu_cost_xr_us <- 1 * (clinic_review_cost + imaging_cost + us_cost)
year_5_lr_sf_fu_cost_xr_us <- 1 * (clinic_review_cost + imaging_cost + us_cost)

year_1_lr_less4_fu_cost_xr_us <- 2 * (clinic_review_cost + imaging_cost + us_cost)
year_2_lr_less4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
year_3_lr_less4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
year_4_lr_less4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
year_5_lr_less4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost

year_1_lr_more4_fu_cost_xr_us <- 2 * (clinic_review_cost + imaging_cost + us_cost)
year_2_lr_more4_fu_cost_xr_us <- 2 * (clinic_review_cost + imaging_cost + us_cost)
year_3_lr_more4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
year_4_lr_more4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
year_5_lr_more4_fu_cost_xr_us <- clinic_review_cost + imaging_cost + us_cost
```
\newpage

#### Costs associated with 'low risk' disease (as per EAU) - CT FU
```{r}
year_1_lr_sf_fu_cost_ct <- 2 * (clinic_review_cost + ct_cost)
year_2_lr_sf_fu_cost_ct <- 0
year_3_lr_sf_fu_cost_ct <- 1 * (clinic_review_cost + ct_cost)
year_4_lr_sf_fu_cost_ct <- 1 * (clinic_review_cost + ct_cost)
year_5_lr_sf_fu_cost_ct <- 1 * (clinic_review_cost + ct_cost)

year_1_lr_less4_fu_cost_ct <- 2 * (clinic_review_cost + ct_cost)
year_2_lr_less4_fu_cost_ct <- clinic_review_cost + ct_cost
year_3_lr_less4_fu_cost_ct <- clinic_review_cost + ct_cost
year_4_lr_less4_fu_cost_ct <- clinic_review_cost + ct_cost
year_5_lr_less4_fu_cost_ct <- clinic_review_cost + ct_cost

year_1_lr_more4_fu_cost_ct <- 2 * (clinic_review_cost + ct_cost)
year_2_lr_more4_fu_cost_ct <- 2 * (clinic_review_cost + ct_cost)
year_3_lr_more4_fu_cost_ct <- clinic_review_cost + ct_cost
year_4_lr_more4_fu_cost_ct <- clinic_review_cost + ct_cost
year_5_lr_more4_fu_cost_ct <- clinic_review_cost + ct_cost
```
\newpage

### Follow-up costs for high risk disease
#### XR FU
```{r}
year_1_hr_sf_fu_cost_current_xr <- 2 * (clinic_review_cost + imaging_cost) + urine_24_hr_cost
year_1_hr_sf_fu_cost_eau_xr <- 2 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)

year_2_hr_sf_fu_cost_current_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_2_hr_sf_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)

year_3_onwards_hr_sf_fu_cost_current_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_3_onwards_hr_sf_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)

year_3_hr_sf_fu_cost_current_xr <- 2 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_3_hr_sf_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_4_hr_sf_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_5_hr_sf_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_xr <- 2 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_2_hr_less4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_3_hr_less4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_4_hr_less4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_5_hr_less4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_xr <- 2 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_2_hr_more4_fu_cost_eau_xr <- 2 * (clinic_review_cost + imaging_cost) + urine_24_hr_cost
year_3_hr_more4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_4_hr_more4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
year_5_hr_more4_fu_cost_eau_xr <- 1 * (clinic_review_cost + imaging_cost + urine_24_hr_cost)
```
\newpage

#### XR + US FU
```{r}
# Assume 80% will have XR and 20% will have US
# Assume all will have XR to determine lucency then radiolucent will go on to have US

year_1_hr_sf_fu_cost_current_xr_us <- 2 * (clinic_review_cost + us_cost) + urine_24_hr_cost
year_1_hr_sf_fu_cost_eau_xr_us <- 2 * (clinic_review_cost + us_cost + urine_24_hr_cost)

year_2_hr_sf_fu_cost_current_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_2_hr_sf_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)

year_3_onwards_hr_sf_fu_cost_current_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_3_onwards_hr_sf_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)

year_3_hr_sf_fu_cost_current_xr_us <- 2 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_3_hr_sf_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_4_hr_sf_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_5_hr_sf_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_xr_us <- 2 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_2_hr_less4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_3_hr_less4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_4_hr_less4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_5_hr_less4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_xr_us <- 2 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_2_hr_more4_fu_cost_eau_xr_us <- 2 * (clinic_review_cost  + us_cost) + urine_24_hr_cost
year_3_hr_more4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_4_hr_more4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
year_5_hr_more4_fu_cost_eau_xr_us <- 1 * (clinic_review_cost  + us_cost + urine_24_hr_cost)
```
\newpage

#### CT FU
```{r}
year_1_hr_sf_fu_cost_current_ct <- 2 * (clinic_review_cost + ct_cost) + urine_24_hr_cost
year_1_hr_sf_fu_cost_eau_ct <- 2 * (clinic_review_cost + ct_cost + urine_24_hr_cost)

year_2_hr_sf_fu_cost_current_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_2_hr_sf_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)

year_3_onwards_hr_sf_fu_cost_current_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_3_onwards_hr_sf_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)

year_3_hr_sf_fu_cost_current_ct <- 2 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_3_hr_sf_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_4_hr_sf_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_5_hr_sf_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_ct <- 2 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_2_hr_less4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_3_hr_less4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_4_hr_less4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_5_hr_less4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)

year_1_hr_less4_fu_cost_eau_ct <- 2 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_2_hr_more4_fu_cost_eau_ct <- 2 * (clinic_review_cost + ct_cost) + urine_24_hr_cost
year_3_hr_more4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_4_hr_more4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
year_5_hr_more4_fu_cost_eau_ct <- 1 * (clinic_review_cost + ct_cost + urine_24_hr_cost)
```
\newpage

#### Create tibble with all costs and types of FU
```{r}
fu_costs <- as_tibble(cbind(
  cost = c(
    year_1_lr_sf_fu_cost_xr,
    year_2_lr_sf_fu_cost_xr,
    year_3_lr_sf_fu_cost_xr,
    year_4_lr_sf_fu_cost_xr,
    year_5_lr_sf_fu_cost_xr,
    year_1_lr_less4_fu_cost_xr,
    year_2_lr_less4_fu_cost_xr,
    year_3_lr_less4_fu_cost_xr,
    year_4_lr_less4_fu_cost_xr,
    year_5_lr_less4_fu_cost_xr,
    year_1_lr_more4_fu_cost_xr,
    year_2_lr_more4_fu_cost_xr,
    year_3_lr_more4_fu_cost_xr,
    year_4_lr_more4_fu_cost_xr,
    year_5_lr_more4_fu_cost_xr,
    year_1_hr_sf_fu_cost_current_xr,
    year_1_hr_sf_fu_cost_eau_xr,
    year_2_hr_sf_fu_cost_current_xr,
    year_2_hr_sf_fu_cost_eau_xr,
    year_3_onwards_hr_sf_fu_cost_current_xr,
    year_3_onwards_hr_sf_fu_cost_eau_xr,
    year_3_hr_sf_fu_cost_current_xr,
    year_3_hr_sf_fu_cost_eau_xr,
    year_4_hr_sf_fu_cost_eau_xr,
    year_5_hr_sf_fu_cost_eau_xr,
    year_1_hr_less4_fu_cost_eau_xr,
    year_2_hr_less4_fu_cost_eau_xr,
    year_3_hr_less4_fu_cost_eau_xr,
    year_4_hr_less4_fu_cost_eau_xr,
    year_5_hr_less4_fu_cost_eau_xr,
    year_1_hr_less4_fu_cost_eau_xr,
    year_2_hr_more4_fu_cost_eau_xr,
    year_3_hr_more4_fu_cost_eau_xr,
    year_4_hr_more4_fu_cost_eau_xr,
    year_5_hr_more4_fu_cost_eau_xr
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_cost",
    "year_2_lr_sf_fu_cost",
    "year_3_lr_sf_fu_cost",
    "year_4_lr_sf_fu_cost",
    "year_5_lr_sf_fu_cost",
    "year_1_lr_less4_fu_cost",
    "year_2_lr_less4_fu_cost",
    "year_3_lr_less4_fu_cost",
    "year_4_lr_less4_fu_cost",
    "year_5_lr_less4_fu_cost",
    "year_1_lr_more4_fu_cost",
    "year_2_lr_more4_fu_cost",
    "year_3_lr_more4_fu_cost",
    "year_4_lr_more4_fu_cost",
    "year_5_lr_more4_fu_cost",
    "year_1_hr_sf_fu_cost_current",
    "year_1_hr_sf_fu_cost_eau",
    "year_2_hr_sf_fu_cost_current",
    "year_2_hr_sf_fu_cost_eau",
    "year_3_onwards_hr_sf_fu_cost_current",
    "year_3_onwards_hr_sf_fu_cost_eau",
    "year_3_hr_sf_fu_cost_current",
    "year_3_hr_sf_fu_cost_eau",
    "year_4_hr_sf_fu_cost_eau",
    "year_5_hr_sf_fu_cost_eau",
    "year_1_hr_less4_fu_cost_eau",
    "year_2_hr_less4_fu_cost_eau",
    "year_3_hr_less4_fu_cost_eau",
    "year_4_hr_less4_fu_cost_eau",
    "year_5_hr_less4_fu_cost_eau",
    "year_1_hr_more4_fu_cost_eau",
    "year_2_hr_more4_fu_cost_eau",
    "year_3_hr_more4_fu_cost_eau",
    "year_4_hr_more4_fu_cost_eau",
    "year_5_hr_more4_fu_cost_eau"
  ),
  imaging_type = "xr"
)) %>% rbind(cbind(
  cost = c(
    year_1_lr_sf_fu_cost_xr_us,
    year_2_lr_sf_fu_cost_xr_us,
    year_3_lr_sf_fu_cost_xr_us,
    year_4_lr_sf_fu_cost_xr_us,
    year_5_lr_sf_fu_cost_xr_us,
    year_1_lr_less4_fu_cost_xr_us,
    year_2_lr_less4_fu_cost_xr_us,
    year_3_lr_less4_fu_cost_xr_us,
    year_4_lr_less4_fu_cost_xr_us,
    year_5_lr_less4_fu_cost_xr_us,
    year_1_lr_more4_fu_cost_xr_us,
    year_2_lr_more4_fu_cost_xr_us,
    year_3_lr_more4_fu_cost_xr_us,
    year_4_lr_more4_fu_cost_xr_us,
    year_5_lr_more4_fu_cost_xr_us,
    year_1_hr_sf_fu_cost_current_xr_us,
    year_1_hr_sf_fu_cost_eau_xr_us,
    year_2_hr_sf_fu_cost_current_xr_us,
    year_2_hr_sf_fu_cost_eau_xr_us,
    year_3_onwards_hr_sf_fu_cost_current_xr_us,
    year_3_onwards_hr_sf_fu_cost_eau_xr_us,
    year_3_hr_sf_fu_cost_current_xr_us,
    year_3_hr_sf_fu_cost_eau_xr_us,
    year_4_hr_sf_fu_cost_eau_xr_us,
    year_5_hr_sf_fu_cost_eau_xr_us,
    year_1_hr_less4_fu_cost_eau_xr_us,
    year_2_hr_less4_fu_cost_eau_xr_us,
    year_3_hr_less4_fu_cost_eau_xr_us,
    year_4_hr_less4_fu_cost_eau_xr_us,
    year_5_hr_less4_fu_cost_eau_xr_us,
    year_1_hr_less4_fu_cost_eau_xr_us,
    year_2_hr_more4_fu_cost_eau_xr_us,
    year_3_hr_more4_fu_cost_eau_xr_us,
    year_4_hr_more4_fu_cost_eau_xr_us,
    year_5_hr_more4_fu_cost_eau_xr_us
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_cost",
    "year_2_lr_sf_fu_cost",
    "year_3_lr_sf_fu_cost",
    "year_4_lr_sf_fu_cost",
    "year_5_lr_sf_fu_cost",
    "year_1_lr_less4_fu_cost",
    "year_2_lr_less4_fu_cost",
    "year_3_lr_less4_fu_cost",
    "year_4_lr_less4_fu_cost",
    "year_5_lr_less4_fu_cost",
    "year_1_lr_more4_fu_cost",
    "year_2_lr_more4_fu_cost",
    "year_3_lr_more4_fu_cost",
    "year_4_lr_more4_fu_cost",
    "year_5_lr_more4_fu_cost",
    "year_1_hr_sf_fu_cost_current",
    "year_1_hr_sf_fu_cost_eau",
    "year_2_hr_sf_fu_cost_current",
    "year_2_hr_sf_fu_cost_eau",
    "year_3_onwards_hr_sf_fu_cost_current",
    "year_3_onwards_hr_sf_fu_cost_eau",
    "year_3_hr_sf_fu_cost_current",
    "year_3_hr_sf_fu_cost_eau",
    "year_4_hr_sf_fu_cost_eau",
    "year_5_hr_sf_fu_cost_eau",
    "year_1_hr_less4_fu_cost_eau",
    "year_2_hr_less4_fu_cost_eau",
    "year_3_hr_less4_fu_cost_eau",
    "year_4_hr_less4_fu_cost_eau",
    "year_5_hr_less4_fu_cost_eau",
    "year_1_hr_more4_fu_cost_eau",
    "year_2_hr_more4_fu_cost_eau",
    "year_3_hr_more4_fu_cost_eau",
    "year_4_hr_more4_fu_cost_eau",
    "year_5_hr_more4_fu_cost_eau"
  ),
  imaging_type = "xr_us"
)) %>% rbind(cbind(
  cost = c(
    year_1_lr_sf_fu_cost_ct,
    year_2_lr_sf_fu_cost_ct,
    year_3_lr_sf_fu_cost_ct,
    year_4_lr_sf_fu_cost_ct,
    year_5_lr_sf_fu_cost_ct,
    year_1_lr_less4_fu_cost_ct,
    year_2_lr_less4_fu_cost_ct,
    year_3_lr_less4_fu_cost_ct,
    year_4_lr_less4_fu_cost_ct,
    year_5_lr_less4_fu_cost_ct,
    year_1_lr_more4_fu_cost_ct,
    year_2_lr_more4_fu_cost_ct,
    year_3_lr_more4_fu_cost_ct,
    year_4_lr_more4_fu_cost_ct,
    year_5_lr_more4_fu_cost_ct,
    year_1_hr_sf_fu_cost_current_ct,
    year_1_hr_sf_fu_cost_eau_ct,
    year_2_hr_sf_fu_cost_current_ct,
    year_2_hr_sf_fu_cost_eau_ct,
    year_3_onwards_hr_sf_fu_cost_current_ct,
    year_3_onwards_hr_sf_fu_cost_eau_ct,
    year_3_hr_sf_fu_cost_current_ct,
    year_3_hr_sf_fu_cost_eau_ct,
    year_4_hr_sf_fu_cost_eau_ct,
    year_5_hr_sf_fu_cost_eau_ct,
    year_1_hr_less4_fu_cost_eau_ct,
    year_2_hr_less4_fu_cost_eau_ct,
    year_3_hr_less4_fu_cost_eau_ct,
    year_4_hr_less4_fu_cost_eau_ct,
    year_5_hr_less4_fu_cost_eau_ct,
    year_1_hr_less4_fu_cost_eau_ct,
    year_2_hr_more4_fu_cost_eau_ct,
    year_3_hr_more4_fu_cost_eau_ct,
    year_4_hr_more4_fu_cost_eau_ct,
    year_5_hr_more4_fu_cost_eau_ct
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_cost",
    "year_2_lr_sf_fu_cost",
    "year_3_lr_sf_fu_cost",
    "year_4_lr_sf_fu_cost",
    "year_5_lr_sf_fu_cost",
    "year_1_lr_less4_fu_cost",
    "year_2_lr_less4_fu_cost",
    "year_3_lr_less4_fu_cost",
    "year_4_lr_less4_fu_cost",
    "year_5_lr_less4_fu_cost",
    "year_1_lr_more4_fu_cost",
    "year_2_lr_more4_fu_cost",
    "year_3_lr_more4_fu_cost",
    "year_4_lr_more4_fu_cost",
    "year_5_lr_more4_fu_cost",
    "year_1_hr_sf_fu_cost_current",
    "year_1_hr_sf_fu_cost_eau",
    "year_2_hr_sf_fu_cost_current",
    "year_2_hr_sf_fu_cost_eau",
    "year_3_onwards_hr_sf_fu_cost_current",
    "year_3_onwards_hr_sf_fu_cost_eau",
    "year_3_hr_sf_fu_cost_current",
    "year_3_hr_sf_fu_cost_eau",
    "year_4_hr_sf_fu_cost_eau",
    "year_5_hr_sf_fu_cost_eau",
    "year_1_hr_less4_fu_cost_eau",
    "year_2_hr_less4_fu_cost_eau",
    "year_3_hr_less4_fu_cost_eau",
    "year_4_hr_less4_fu_cost_eau",
    "year_5_hr_less4_fu_cost_eau",
    "year_1_hr_more4_fu_cost_eau",
    "year_2_hr_more4_fu_cost_eau",
    "year_3_hr_more4_fu_cost_eau",
    "year_4_hr_more4_fu_cost_eau",
    "year_5_hr_more4_fu_cost_eau"
  ),
  imaging_type = "ct"
)) %>% select(point_and_type_of_fu, imaging_type, cost)
```
\newpage

### Define recurrence costs
#### Minimum costs associated with recurrence
```{r}
rec_cost_eswl <- clinic_review_cost + ct_cost + (eswl_cost * 2) # assume 2 sessions of ESWL
rec_cost_urs <- clinic_review_cost + ct_cost + urs_cost
rec_cost_pcnl <- clinic_review_cost + ct_cost + pcnl_cost 

rec_cost_colic <- ed_presentation_cost + ct_cost  #Assume acute presentation with colic + spontaneous passage

rec_appt_colic <- 0
rec_appt_eswl <- 0
rec_appt_urs <- 0
rec_appt_pcnl <- 0
```
\newpage

#### Recurrence metrics / proportions
```{r}
sf_1yr_disease_progression <- 0.25 / 5 #Tzelves et al. 2023 - for those not stone free at this point
sf_1yr_intervention <- (0.25 / 2) / 5 #Sorensen et al. 2022 - 5% at 5 years - however very small numbers hence used estimate from Tzelves et al.
sf_1yr_colic <- (0.25 / 2) / 5  #Sorensen et al. 2022 - 5% at 5 years - seems to be equal split between intervention and colic for these patients so use this to divide overall disease progression

less4_1yr_disease_progression <- 0.34 / (35/12) #Tzelves et al. 2023 - 35 months
less4_1yr_intervention <- 0.29 / (34/12) # 34 months
less4_1yr_colic <- less4_1yr_disease_progression - less4_1yr_intervention # Subtract intervention from disease progression

more4_1yr_disease_progression <- 0.67 / 5 #Tzelves et al. 2023
more4_1yr_intervention <- 0.66 / 5
more4_1yr_colic <- 0.01 / 5
```
\newpage

## Radiation Doses in mSv
```{r}
xr_dose <- 0.7
us_dose <- 0
ct_dose <- 10
uldct_dose <- 1.8

pcnl_dose <- 6.6
urs_dose <- 2.1
swl_dose <- 2.4

xr_sens <- 0.67
xr_spec <- 0.98
us_sens <- 0.54
us_spec <- 0.91
ct_sens <- 0.99
ct_spec <- 0.99
uldct_sens <- 0.90
uldct_spec <- 0.93
```
\newpage

## Clinician time
### Clinic time in minutes
```{r}
# Clinic times in minutes
initial_consultation_time <- 30  # First appointment time
clinic_review_time <- 15  # Follow-up appointment time
imaging_time <- 10 + 10 # appointment time + interpretation  
us_time <- 15 + 10 # appointment time + interpretation 
ct_time <-  10 + 10 # appointment time + interpretation 
urine_24_hr_time <- 190.5

# Intervention times
eswl_time <- 30 * 2  # assume 2 ESWL treatments 
urs_time <- 90  # time for URS 
pcnl_time <- 120  # time for PCNL
stent_time <- 30 # time for stent

# Acute presentation time
ed_presentation_time <- 4 * 12 #  ~4 hours
```
\newpage

### Calculate times
```{r}
# times associated with 'low risk' disease (as per EAU) - XR FU
year_1_lr_sf_fu_time_xr <- 2 * (clinic_review_time + imaging_time)
year_2_lr_sf_fu_time_xr <- 0
year_3_lr_sf_fu_time_xr <- 1 * (clinic_review_time + imaging_time)
year_4_lr_sf_fu_time_xr <- 1 * (clinic_review_time + imaging_time)
year_5_lr_sf_fu_time_xr <- 1 * (clinic_review_time + imaging_time)

year_1_lr_less4_fu_time_xr <- 2 * (clinic_review_time + imaging_time)
year_2_lr_less4_fu_time_xr <- clinic_review_time + imaging_time
year_3_lr_less4_fu_time_xr <- clinic_review_time + imaging_time
year_4_lr_less4_fu_time_xr <- clinic_review_time + imaging_time
year_5_lr_less4_fu_time_xr <- clinic_review_time + imaging_time

year_1_lr_more4_fu_time_xr <- 2 * (clinic_review_time + imaging_time)
year_2_lr_more4_fu_time_xr <- 2 * (clinic_review_time + imaging_time)
year_3_lr_more4_fu_time_xr <- clinic_review_time + imaging_time
year_4_lr_more4_fu_time_xr <- clinic_review_time + imaging_time
year_5_lr_more4_fu_time_xr <- clinic_review_time + imaging_time

# times associated with 'low risk' disease (as per EAU) - XR + US FU
year_1_lr_sf_fu_time_xr_us <- 2 * (clinic_review_time + imaging_time + us_time)
year_2_lr_sf_fu_time_xr_us <- 0
year_3_lr_sf_fu_time_xr_us <- 1 * (clinic_review_time + imaging_time + us_time)
year_4_lr_sf_fu_time_xr_us <- 1 * (clinic_review_time + imaging_time + us_time)
year_5_lr_sf_fu_time_xr_us <- 1 * (clinic_review_time + imaging_time + us_time)

year_1_lr_less4_fu_time_xr_us <- 2 * (clinic_review_time + imaging_time + us_time)
year_2_lr_less4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time
year_3_lr_less4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time
year_4_lr_less4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time
year_5_lr_less4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time

year_1_lr_more4_fu_time_xr_us <- 2 * (clinic_review_time + imaging_time + us_time)
year_2_lr_more4_fu_time_xr_us <- 2 * (clinic_review_time + imaging_time + us_time)
year_3_lr_more4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time
year_4_lr_more4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time
year_5_lr_more4_fu_time_xr_us <- clinic_review_time + imaging_time + us_time

# times associated with 'low risk' disease (as per EAU) - CT FU
year_1_lr_sf_fu_time_ct <- 2 * (clinic_review_time + ct_time)
year_2_lr_sf_fu_time_ct <- 0
year_3_lr_sf_fu_time_ct <- 1 * (clinic_review_time + ct_time)
year_4_lr_sf_fu_time_ct <- 1 * (clinic_review_time + ct_time)
year_5_lr_sf_fu_time_ct <- 1 * (clinic_review_time + ct_time)

year_1_lr_less4_fu_time_ct <- 2 * (clinic_review_time + ct_time)
year_2_lr_less4_fu_time_ct <- clinic_review_time + ct_time
year_3_lr_less4_fu_time_ct <- clinic_review_time + ct_time
year_4_lr_less4_fu_time_ct <- clinic_review_time + ct_time
year_5_lr_less4_fu_time_ct <- clinic_review_time + ct_time

year_1_lr_more4_fu_time_ct <- 2 * (clinic_review_time + ct_time)
year_2_lr_more4_fu_time_ct <- 2 * (clinic_review_time + ct_time)
year_3_lr_more4_fu_time_ct <- clinic_review_time + ct_time
year_4_lr_more4_fu_time_ct <- clinic_review_time + ct_time
year_5_lr_more4_fu_time_ct <- clinic_review_time + ct_time


# times associated with 'high risk' disease
## XR FU
year_1_hr_sf_fu_time_current_xr <- 2 * (clinic_review_time + imaging_time) + urine_24_hr_time
year_1_hr_sf_fu_time_eau_xr <- 2 * (clinic_review_time + imaging_time + urine_24_hr_time)

year_2_hr_sf_fu_time_current_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_2_hr_sf_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)

year_3_onwards_hr_sf_fu_time_current_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_3_onwards_hr_sf_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)

year_3_hr_sf_fu_time_current_xr <- 2 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_3_hr_sf_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_4_hr_sf_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_5_hr_sf_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_xr <- 2 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_2_hr_less4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_3_hr_less4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_4_hr_less4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_5_hr_less4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_xr <- 2 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_2_hr_more4_fu_time_eau_xr <- 2 * (clinic_review_time + imaging_time) + urine_24_hr_time
year_3_hr_more4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_4_hr_more4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)
year_5_hr_more4_fu_time_eau_xr <- 1 * (clinic_review_time + imaging_time + urine_24_hr_time)

## XR + US FU
year_1_hr_sf_fu_time_current_xr_us <- 2 * (clinic_review_time + imaging_time + us_time) + urine_24_hr_time
year_1_hr_sf_fu_time_eau_xr_us <- 2 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

year_2_hr_sf_fu_time_current_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_2_hr_sf_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

year_3_onwards_hr_sf_fu_time_current_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_3_onwards_hr_sf_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

year_3_hr_sf_fu_time_current_xr_us <- 2 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_3_hr_sf_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_4_hr_sf_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_5_hr_sf_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_xr_us <- 2 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_2_hr_less4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_3_hr_less4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_4_hr_less4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_5_hr_less4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_xr_us <- 2 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_2_hr_more4_fu_time_eau_xr_us <- 2 * (clinic_review_time + imaging_time + us_time) + urine_24_hr_time
year_3_hr_more4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_4_hr_more4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)
year_5_hr_more4_fu_time_eau_xr_us <- 1 * (clinic_review_time + imaging_time + us_time + urine_24_hr_time)

## CT FU
year_1_hr_sf_fu_time_current_ct <- 2 * (clinic_review_time + ct_time) + urine_24_hr_time
year_1_hr_sf_fu_time_eau_ct <- 2 * (clinic_review_time + ct_time + urine_24_hr_time)

year_2_hr_sf_fu_time_current_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_2_hr_sf_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)

year_3_onwards_hr_sf_fu_time_current_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_3_onwards_hr_sf_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)

year_3_hr_sf_fu_time_current_ct <- 2 * (clinic_review_time + ct_time + urine_24_hr_time)
year_3_hr_sf_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_4_hr_sf_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_5_hr_sf_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_ct <- 2 * (clinic_review_time + ct_time + urine_24_hr_time)
year_2_hr_less4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_3_hr_less4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_4_hr_less4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_5_hr_less4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)

year_1_hr_less4_fu_time_eau_ct <- 2 * (clinic_review_time + ct_time + urine_24_hr_time)
year_2_hr_more4_fu_time_eau_ct <- 2 * (clinic_review_time + ct_time) + urine_24_hr_time
year_3_hr_more4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_4_hr_more4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
year_5_hr_more4_fu_time_eau_ct <- 1 * (clinic_review_time + ct_time + urine_24_hr_time)
```
\newpage

### Number of appts
```{r}
# appts associated with 'low risk' disease (as per EAU) - XR FU
year_1_lr_sf_fu_appts_xr <- 4
year_2_lr_sf_fu_appts_xr <- 0
year_3_lr_sf_fu_appts_xr <- 2
year_4_lr_sf_fu_appts_xr <- 2
year_5_lr_sf_fu_appts_xr <- 2

year_1_lr_less4_fu_appts_xr <- 2 * (2)
year_2_lr_less4_fu_appts_xr <- 2
year_3_lr_less4_fu_appts_xr <- 2
year_4_lr_less4_fu_appts_xr <- 2
year_5_lr_less4_fu_appts_xr <- 2

year_1_lr_more4_fu_appts_xr <- 2 * (2)
year_2_lr_more4_fu_appts_xr <- 2 * (2)
year_3_lr_more4_fu_appts_xr <- 2
year_4_lr_more4_fu_appts_xr <- 2
year_5_lr_more4_fu_appts_xr <- 2

# appts associated with 'low risk' disease (as per EAU) - XR + US FU
year_1_lr_sf_fu_appts_xr_us <- 2 * (2 )
year_2_lr_sf_fu_appts_xr_us <- 0
year_3_lr_sf_fu_appts_xr_us <- 1 * (2 )
year_4_lr_sf_fu_appts_xr_us <- 1 * (2 )
year_5_lr_sf_fu_appts_xr_us <- 1 * (2 )

year_1_lr_less4_fu_appts_xr_us <- 2 * (2 )
year_2_lr_less4_fu_appts_xr_us <- 2 
year_3_lr_less4_fu_appts_xr_us <- 2 
year_4_lr_less4_fu_appts_xr_us <- 2 
year_5_lr_less4_fu_appts_xr_us <- 2 

year_1_lr_more4_fu_appts_xr_us <- 2 * (2 )
year_2_lr_more4_fu_appts_xr_us <- 2 * (2 )
year_3_lr_more4_fu_appts_xr_us <- 2 
year_4_lr_more4_fu_appts_xr_us <- 2 
year_5_lr_more4_fu_appts_xr_us <- 2 

# appts associated with 'low risk' disease (as per EAU) - CT FU
year_1_lr_sf_fu_appts_ct <- 2 * (2)
year_2_lr_sf_fu_appts_ct <- 0
year_3_lr_sf_fu_appts_ct <- 1 * (2)
year_4_lr_sf_fu_appts_ct <- 1 * (2)
year_5_lr_sf_fu_appts_ct <- 1 * (2)

year_1_lr_less4_fu_appts_ct <- 2 * (2)
year_2_lr_less4_fu_appts_ct <- 2
year_3_lr_less4_fu_appts_ct <- 2
year_4_lr_less4_fu_appts_ct <- 2
year_5_lr_less4_fu_appts_ct <- 2

year_1_lr_more4_fu_appts_ct <- 2 * (2)
year_2_lr_more4_fu_appts_ct <- 2 * (2)
year_3_lr_more4_fu_appts_ct <- 2
year_4_lr_more4_fu_appts_ct <- 2
year_5_lr_more4_fu_appts_ct <- 2


# appts associated with 'high risk' disease
## XR FU
year_1_hr_sf_fu_appts_current_xr <- 2 * (2+ 1)
year_1_hr_sf_fu_appts_eau_xr <- 2 * (2+ 1)

year_2_hr_sf_fu_appts_current_xr <- 1 * (2+ 1)
year_2_hr_sf_fu_appts_eau_xr <- 1 * (2+ 1)

year_3_onwards_hr_sf_fu_appts_current_xr <- 1 * (2+ 1)
year_3_onwards_hr_sf_fu_appts_eau_xr <- 1 * (2+ 1)

year_3_hr_sf_fu_appts_current_xr <- 2 * (2+ 1)
year_3_hr_sf_fu_appts_eau_xr <- 1 * (2+ 1)
year_4_hr_sf_fu_appts_eau_xr <- 1 * (2+ 1)
year_5_hr_sf_fu_appts_eau_xr <- 1 * (2+ 1)

year_1_hr_less4_fu_appts_eau_xr <- 2 * (2+ 1)
year_2_hr_less4_fu_appts_eau_xr <- 1 * (2+ 1)
year_3_hr_less4_fu_appts_eau_xr <- 1 * (2+ 1)
year_4_hr_less4_fu_appts_eau_xr <- 1 * (2+ 1)
year_5_hr_less4_fu_appts_eau_xr <- 1 * (2+ 1)

year_1_hr_less4_fu_appts_eau_xr <- 2 * (2+ 1)
year_2_hr_more4_fu_appts_eau_xr <- 2 * (2)+ 1
year_3_hr_more4_fu_appts_eau_xr <- 1 * (2+ 1)
year_4_hr_more4_fu_appts_eau_xr <- 1 * (2+ 1)
year_5_hr_more4_fu_appts_eau_xr <- 1 * (2+ 1)

## XR + US FU
year_1_hr_sf_fu_appts_current_xr_us <- 2 * (2 + 1)
year_1_hr_sf_fu_appts_eau_xr_us <- 2 * (2 + 1)

year_2_hr_sf_fu_appts_current_xr_us <- 1 * (2 + 1)
year_2_hr_sf_fu_appts_eau_xr_us <- 1 * (2 + 1)

year_3_onwards_hr_sf_fu_appts_current_xr_us <- 1 * (2 + 1)
year_3_onwards_hr_sf_fu_appts_eau_xr_us <- 1 * (2 + 1)

year_3_hr_sf_fu_appts_current_xr_us <- 2 * (2 + 1)
year_3_hr_sf_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_4_hr_sf_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_5_hr_sf_fu_appts_eau_xr_us <- 1 * (2 + 1)

year_1_hr_less4_fu_appts_eau_xr_us <- 2 * (2 + 1)
year_2_hr_less4_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_3_hr_less4_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_4_hr_less4_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_5_hr_less4_fu_appts_eau_xr_us <- 1 * (2 + 1)

year_1_hr_less4_fu_appts_eau_xr_us <- 2 * (2 + 1)
year_2_hr_more4_fu_appts_eau_xr_us <- 2 * (2 + 1)
year_3_hr_more4_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_4_hr_more4_fu_appts_eau_xr_us <- 1 * (2 + 1)
year_5_hr_more4_fu_appts_eau_xr_us <- 1 * (2 + 1)

## CT FU
year_1_hr_sf_fu_appts_current_ct <- 2 * (2+ 1)
year_1_hr_sf_fu_appts_eau_ct <- 2 * (2+ 1)

year_2_hr_sf_fu_appts_current_ct <- 1 * (2+ 1)
year_2_hr_sf_fu_appts_eau_ct <- 1 * (2+ 1)

year_3_onwards_hr_sf_fu_appts_current_ct <- 1 * (2+ 1)
year_3_onwards_hr_sf_fu_appts_eau_ct <- 1 * (2+ 1)

year_3_hr_sf_fu_appts_current_ct <- 2 * (2+ 1)
year_3_hr_sf_fu_appts_eau_ct <- 1 * (2+ 1)
year_4_hr_sf_fu_appts_eau_ct <- 1 * (2+ 1)
year_5_hr_sf_fu_appts_eau_ct <- 1 * (2+ 1)

year_1_hr_less4_fu_appts_eau_ct <- 2 * (2+ 1)
year_2_hr_less4_fu_appts_eau_ct <- 1 * (2+ 1)
year_3_hr_less4_fu_appts_eau_ct <- 1 * (2+ 1)
year_4_hr_less4_fu_appts_eau_ct <- 1 * (2+ 1)
year_5_hr_less4_fu_appts_eau_ct <- 1 * (2+ 1)

year_1_hr_less4_fu_appts_eau_ct <- 2 * (2+ 1)
year_2_hr_more4_fu_appts_eau_ct <- 2 * (2)+ 1
year_3_hr_more4_fu_appts_eau_ct <- 1 * (2+ 1)
year_4_hr_more4_fu_appts_eau_ct <- 1 * (2+ 1)
year_5_hr_more4_fu_appts_eau_ct <- 1 * (2+ 1)
```
\newpage

### Compile tibble with all times
```{r}
fu_appts <- as_tibble(cbind(
  appts = c(
    year_1_lr_sf_fu_appts_xr,
    year_2_lr_sf_fu_appts_xr,
    year_3_lr_sf_fu_appts_xr,
    year_4_lr_sf_fu_appts_xr,
    year_5_lr_sf_fu_appts_xr,
    year_1_lr_less4_fu_appts_xr,
    year_2_lr_less4_fu_appts_xr,
    year_3_lr_less4_fu_appts_xr,
    year_4_lr_less4_fu_appts_xr,
    year_5_lr_less4_fu_appts_xr,
    year_1_lr_more4_fu_appts_xr,
    year_2_lr_more4_fu_appts_xr,
    year_3_lr_more4_fu_appts_xr,
    year_4_lr_more4_fu_appts_xr,
    year_5_lr_more4_fu_appts_xr,
    year_1_hr_sf_fu_appts_current_xr,
    year_1_hr_sf_fu_appts_eau_xr,
    year_2_hr_sf_fu_appts_current_xr,
    year_2_hr_sf_fu_appts_eau_xr,
    year_3_onwards_hr_sf_fu_appts_current_xr,
    year_3_onwards_hr_sf_fu_appts_eau_xr,
    year_3_hr_sf_fu_appts_current_xr,
    year_3_hr_sf_fu_appts_eau_xr,
    year_4_hr_sf_fu_appts_eau_xr,
    year_5_hr_sf_fu_appts_eau_xr,
    year_1_hr_less4_fu_appts_eau_xr,
    year_2_hr_less4_fu_appts_eau_xr,
    year_3_hr_less4_fu_appts_eau_xr,
    year_4_hr_less4_fu_appts_eau_xr,
    year_5_hr_less4_fu_appts_eau_xr,
    year_1_hr_less4_fu_appts_eau_xr,
    year_2_hr_more4_fu_appts_eau_xr,
    year_3_hr_more4_fu_appts_eau_xr,
    year_4_hr_more4_fu_appts_eau_xr,
    year_5_hr_more4_fu_appts_eau_xr
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_appts",
    "year_2_lr_sf_fu_appts",
    "year_3_lr_sf_fu_appts",
    "year_4_lr_sf_fu_appts",
    "year_5_lr_sf_fu_appts",
    "year_1_lr_less4_fu_appts",
    "year_2_lr_less4_fu_appts",
    "year_3_lr_less4_fu_appts",
    "year_4_lr_less4_fu_appts",
    "year_5_lr_less4_fu_appts",
    "year_1_lr_more4_fu_appts",
    "year_2_lr_more4_fu_appts",
    "year_3_lr_more4_fu_appts",
    "year_4_lr_more4_fu_appts",
    "year_5_lr_more4_fu_appts",
    "year_1_hr_sf_fu_appts_current",
    "year_1_hr_sf_fu_appts_eau",
    "year_2_hr_sf_fu_appts_current",
    "year_2_hr_sf_fu_appts_eau",
    "year_3_onwards_hr_sf_fu_appts_current",
    "year_3_onwards_hr_sf_fu_appts_eau",
    "year_3_hr_sf_fu_appts_current",
    "year_3_hr_sf_fu_appts_eau",
    "year_4_hr_sf_fu_appts_eau",
    "year_5_hr_sf_fu_appts_eau",
    "year_1_hr_less4_fu_appts_eau",
    "year_2_hr_less4_fu_appts_eau",
    "year_3_hr_less4_fu_appts_eau",
    "year_4_hr_less4_fu_appts_eau",
    "year_5_hr_less4_fu_appts_eau",
    "year_1_hr_more4_fu_appts_eau",
    "year_2_hr_more4_fu_appts_eau",
    "year_3_hr_more4_fu_appts_eau",
    "year_4_hr_more4_fu_appts_eau",
    "year_5_hr_more4_fu_appts_eau"
  ),
  imaging_type = "xr"
)) %>% rbind(cbind(
  appts = c(
    year_1_lr_sf_fu_appts_xr_us,
    year_2_lr_sf_fu_appts_xr_us,
    year_3_lr_sf_fu_appts_xr_us,
    year_4_lr_sf_fu_appts_xr_us,
    year_5_lr_sf_fu_appts_xr_us,
    year_1_lr_less4_fu_appts_xr_us,
    year_2_lr_less4_fu_appts_xr_us,
    year_3_lr_less4_fu_appts_xr_us,
    year_4_lr_less4_fu_appts_xr_us,
    year_5_lr_less4_fu_appts_xr_us,
    year_1_lr_more4_fu_appts_xr_us,
    year_2_lr_more4_fu_appts_xr_us,
    year_3_lr_more4_fu_appts_xr_us,
    year_4_lr_more4_fu_appts_xr_us,
    year_5_lr_more4_fu_appts_xr_us,
    year_1_hr_sf_fu_appts_current_xr_us,
    year_1_hr_sf_fu_appts_eau_xr_us,
    year_2_hr_sf_fu_appts_current_xr_us,
    year_2_hr_sf_fu_appts_eau_xr_us,
    year_3_onwards_hr_sf_fu_appts_current_xr_us,
    year_3_onwards_hr_sf_fu_appts_eau_xr_us,
    year_3_hr_sf_fu_appts_current_xr_us,
    year_3_hr_sf_fu_appts_eau_xr_us,
    year_4_hr_sf_fu_appts_eau_xr_us,
    year_5_hr_sf_fu_appts_eau_xr_us,
    year_1_hr_less4_fu_appts_eau_xr_us,
    year_2_hr_less4_fu_appts_eau_xr_us,
    year_3_hr_less4_fu_appts_eau_xr_us,
    year_4_hr_less4_fu_appts_eau_xr_us,
    year_5_hr_less4_fu_appts_eau_xr_us,
    year_1_hr_less4_fu_appts_eau_xr_us,
    year_2_hr_more4_fu_appts_eau_xr_us,
    year_3_hr_more4_fu_appts_eau_xr_us,
    year_4_hr_more4_fu_appts_eau_xr_us,
    year_5_hr_more4_fu_appts_eau_xr_us
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_appts",
    "year_2_lr_sf_fu_appts",
    "year_3_lr_sf_fu_appts",
    "year_4_lr_sf_fu_appts",
    "year_5_lr_sf_fu_appts",
    "year_1_lr_less4_fu_appts",
    "year_2_lr_less4_fu_appts",
    "year_3_lr_less4_fu_appts",
    "year_4_lr_less4_fu_appts",
    "year_5_lr_less4_fu_appts",
    "year_1_lr_more4_fu_appts",
    "year_2_lr_more4_fu_appts",
    "year_3_lr_more4_fu_appts",
    "year_4_lr_more4_fu_appts",
    "year_5_lr_more4_fu_appts",
    "year_1_hr_sf_fu_appts_current",
    "year_1_hr_sf_fu_appts_eau",
    "year_2_hr_sf_fu_appts_current",
    "year_2_hr_sf_fu_appts_eau",
    "year_3_onwards_hr_sf_fu_appts_current",
    "year_3_onwards_hr_sf_fu_appts_eau",
    "year_3_hr_sf_fu_appts_current",
    "year_3_hr_sf_fu_appts_eau",
    "year_4_hr_sf_fu_appts_eau",
    "year_5_hr_sf_fu_appts_eau",
    "year_1_hr_less4_fu_appts_eau",
    "year_2_hr_less4_fu_appts_eau",
    "year_3_hr_less4_fu_appts_eau",
    "year_4_hr_less4_fu_appts_eau",
    "year_5_hr_less4_fu_appts_eau",
    "year_1_hr_more4_fu_appts_eau",
    "year_2_hr_more4_fu_appts_eau",
    "year_3_hr_more4_fu_appts_eau",
    "year_4_hr_more4_fu_appts_eau",
    "year_5_hr_more4_fu_appts_eau"
  ),
  imaging_type = "xr_us"
)) %>% rbind(cbind(
  appts = c(
    year_1_lr_sf_fu_appts_ct,
    year_2_lr_sf_fu_appts_ct,
    year_3_lr_sf_fu_appts_ct,
    year_4_lr_sf_fu_appts_ct,
    year_5_lr_sf_fu_appts_ct,
    year_1_lr_less4_fu_appts_ct,
    year_2_lr_less4_fu_appts_ct,
    year_3_lr_less4_fu_appts_ct,
    year_4_lr_less4_fu_appts_ct,
    year_5_lr_less4_fu_appts_ct,
    year_1_lr_more4_fu_appts_ct,
    year_2_lr_more4_fu_appts_ct,
    year_3_lr_more4_fu_appts_ct,
    year_4_lr_more4_fu_appts_ct,
    year_5_lr_more4_fu_appts_ct,
    year_1_hr_sf_fu_appts_current_ct,
    year_1_hr_sf_fu_appts_eau_ct,
    year_2_hr_sf_fu_appts_current_ct,
    year_2_hr_sf_fu_appts_eau_ct,
    year_3_onwards_hr_sf_fu_appts_current_ct,
    year_3_onwards_hr_sf_fu_appts_eau_ct,
    year_3_hr_sf_fu_appts_current_ct,
    year_3_hr_sf_fu_appts_eau_ct,
    year_4_hr_sf_fu_appts_eau_ct,
    year_5_hr_sf_fu_appts_eau_ct,
    year_1_hr_less4_fu_appts_eau_ct,
    year_2_hr_less4_fu_appts_eau_ct,
    year_3_hr_less4_fu_appts_eau_ct,
    year_4_hr_less4_fu_appts_eau_ct,
    year_5_hr_less4_fu_appts_eau_ct,
    year_1_hr_less4_fu_appts_eau_ct,
    year_2_hr_more4_fu_appts_eau_ct,
    year_3_hr_more4_fu_appts_eau_ct,
    year_4_hr_more4_fu_appts_eau_ct,
    year_5_hr_more4_fu_appts_eau_ct
  ),
  point_and_type_of_fu = c(
    "year_1_lr_sf_fu_appts",
    "year_2_lr_sf_fu_appts",
    "year_3_lr_sf_fu_appts",
    "year_4_lr_sf_fu_appts",
    "year_5_lr_sf_fu_appts",
    "year_1_lr_less4_fu_appts",
    "year_2_lr_less4_fu_appts",
    "year_3_lr_less4_fu_appts",
    "year_4_lr_less4_fu_appts",
    "year_5_lr_less4_fu_appts",
    "year_1_lr_more4_fu_appts",
    "year_2_lr_more4_fu_appts",
    "year_3_lr_more4_fu_appts",
    "year_4_lr_more4_fu_appts",
    "year_5_lr_more4_fu_appts",
    "year_1_hr_sf_fu_appts_current",
    "year_1_hr_sf_fu_appts_eau",
    "year_2_hr_sf_fu_appts_current",
    "year_2_hr_sf_fu_appts_eau",
    "year_3_onwards_hr_sf_fu_appts_current",
    "year_3_onwards_hr_sf_fu_appts_eau",
    "year_3_hr_sf_fu_appts_current",
    "year_3_hr_sf_fu_appts_eau",
    "year_4_hr_sf_fu_appts_eau",
    "year_5_hr_sf_fu_appts_eau",
    "year_1_hr_less4_fu_appts_eau",
    "year_2_hr_less4_fu_appts_eau",
    "year_3_hr_less4_fu_appts_eau",
    "year_4_hr_less4_fu_appts_eau",
    "year_5_hr_less4_fu_appts_eau",
    "year_1_hr_more4_fu_appts_eau",
    "year_2_hr_more4_fu_appts_eau",
    "year_3_hr_more4_fu_appts_eau",
    "year_4_hr_more4_fu_appts_eau",
    "year_5_hr_more4_fu_appts_eau"
  ),
  imaging_type = "ct"
)) %>% select(point_and_type_of_fu, imaging_type, appts)
```
\newpage

# Visualise Model
```{r}
grViz(
  "
digraph MarkovModel {
  graph [layout = dot, rankdir = LR, bgcolor = 'white']

  # Nodes for model states with colors
  { rank = same; StoneFree; less_4mm; more_4mm }
   StoneFree -> less_4mm -> more_4mm [style=invis]
  { rank = same; HighRisk; LowRisk }
  LowRisk -> HighRisk [style=invis]
  { rank = same; NoRecurrence; Recurrence }
  NoRecurrence -> Recurrence [style=invis]
  
  { rank = same; FollowUp; Death }
  FollowUp -> Death [style=invis]
  
  StoneFree [shape = oval, label = 'Stone Free',
             style = filled, fillcolor = 'lightblue', color = 'darkblue']

  less_4mm [shape = oval, label = '<4mm Fragments',
             style = filled, fillcolor = 'lightblue', color = 'darkblue']

  more_4mm [shape = oval, label = '>/=4mm Fragments',
             style = filled, fillcolor = 'lightblue', color = 'darkblue']

  LowRisk [shape = rectangle, label = 'Low Risk',
           style = filled, fillcolor = 'chartreuse3', color = 'darkgreen']

  HighRisk [shape = rectangle, label = 'High Risk',
            style = filled, fillcolor = 'orange', color = 'darkorange']

  NoRecurrence [shape = rectangle, label = 'No Stone Events',
                style = filled, fillcolor = 'chartreuse3', color = 'darkgreen']

  Recurrence [shape = diamond, label = 'Stone Event',
              style = filled, fillcolor = 'salmon', color = 'red']

  FollowUp [shape = oval, label = 'No Further Stone Events\\nover Follow-up',
            style = filled, fillcolor = 'lightcyan', color = 'teal']

  Death [shape = hexagon, label = 'Death', rank = same,
         style = filled, fillcolor = 'black', color = 'black', fontcolor = 'white']

  ESWL [shape = diamond, label = 'ESWL', rank = same,
                style = filled, fillcolor = 'gold', color = 'orange']

  PCNL [shape = diamond, label = 'PCNL', rank = same,
                style = filled, fillcolor = 'gold', color = 'orange']

  URS [shape = diamond, label = 'URS', rank = same,
                style = filled, fillcolor = 'gold', color = 'orange']

  Observation [shape = diamond, label = 'Observation', rank = same,
                style = filled, fillcolor = 'gold', color = 'orange']

  # Transitions and probabilities with colored edges
  StoneFree -> LowRisk [color = 'green', fontcolor = 'darkgreen']
  StoneFree -> HighRisk [color = 'orange', fontcolor = 'darkorange']

  less_4mm -> LowRisk [color = 'green', fontcolor = 'darkgreen']
  less_4mm -> HighRisk [color = 'orange', fontcolor = 'darkorange']
  more_4mm -> LowRisk [color = 'green', fontcolor = 'darkgreen']
  more_4mm -> HighRisk [color = 'orange', fontcolor = 'darkorange']

  LowRisk -> Recurrence [color = 'red', fontcolor = 'red']
  HighRisk -> Recurrence [color = 'red', fontcolor = 'red']
  LowRisk -> NoRecurrence [color = 'darkgreen', fontcolor = 'darkgreen']
  HighRisk -> NoRecurrence [color = 'darkgreen', fontcolor = 'darkgreen']

  NoRecurrence -> FollowUp [label = 'Continue Follow-Up', color = 'teal', fontcolor = 'teal']
  Recurrence -> ESWL [label = 'ESWL (39%)', color = 'gold', fontcolor = 'orange']
  Recurrence -> PCNL [label = 'PCNL (16%)', color = 'gold', fontcolor = 'orange']
  Recurrence -> URS [label = 'URS (25%)', color = 'gold', fontcolor = 'orange']
  Recurrence -> Observation [label = 'Observation (20%)', color = 'gold', fontcolor = 'orange']

  Observation -> StoneFree [label = 'Stone Free (10%)', color = 'gold', fontcolor = 'orange']
  Observation -> less_4mm [label = 'Not Stone Free (80%)', color = 'blue', fontcolor = 'blue']
  Observation -> more_4mm [label = 'Not Stone Free (20%)', color = 'blue', fontcolor = 'blue']

  ESWL -> StoneFree [label = 'Stone Free (50%)', color = 'gold', fontcolor = 'orange']
  ESWL -> less_4mm [label = 'Not Stone Free (40%)', color = 'blue', fontcolor = 'blue']
  ESWL -> more_4mm [label = 'Not Stone Free (10%)', color = 'blue', fontcolor = 'blue']

  PCNL -> StoneFree [label = 'Stone Free (74%)', color = 'gold', fontcolor = 'orange']
  PCNL -> less_4mm [label = 'Not Stone Free (18%)', color = 'blue', fontcolor = 'blue']
  PCNL -> more_4mm [label = 'Not Stone Free (8%)', color = 'blue', fontcolor = 'blue']

  URS -> StoneFree [label = 'Stone Free (60%)', color = 'gold', fontcolor = 'orange']
  URS -> less_4mm [label = 'Not Stone Free (30%)', color = 'blue', fontcolor = 'blue']
  URS -> more_4mm [label = 'Not Stone Free (10%)', color = 'blue', fontcolor = 'blue']

  # Death state transitions with consistent styling
  HighRisk -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  LowRisk -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  Recurrence -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  NoRecurrence -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  ESWL -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  URS -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  PCNL -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  Observation -> Death [label = 'Mortality Rate', color = 'black', fontcolor = 'black', style = 'dashed']
  Death -> Death [color = 'black', fontcolor = 'black', style = 'dashed']
}
")
```
\newpage

# Total Cost Calculation Functions for SF patients for EAU Risk Stratification
## Calculate total cost function - XR F/U 
Use UKB data to estimate risk status distribution
```{r}
calculate_total_sf_cost_xr_fu <- function(data) {
  # Initial Costs
  data <- data %>% mutate(initial_costs = (total_sf_patients * (
    initial_consultation_cost + 2 * (clinic_review_cost + imaging_cost) + (total_sf_patients * 0.5 * urine_24_hr_cost)
  )),
  .keep = "all")
  
  # Follow-up Costs
  data <- data %>% mutate(
    lr_annual_follow_up_costs = (total_sf_patients * 0.5) * (clinic_review_cost + imaging_cost),
    #low risk patients
    hr_annual_follow_up_costs = (total_sf_patients *
                                   0.5) * (clinic_review_cost + imaging_cost + urine_24_hr_cost),
    # high risk patients
    .keep = "all"
  )
  
  # Additional Intervention for Residual Stones
  data <- data %>% mutate(
    residual_stone_intervention_patients = eswl_residual_symptomatic + urs_residual_symptomatic + pcnl_residual_symptomatic,
    eswl_reintervention_patients = residual_stone_intervention_patients * eswl_proportion,
    urs_reintervention_patients = residual_stone_intervention_patients * urs_proportion,
    pcnl_reintervention_patients = residual_stone_intervention_patients * pcnl_proportion,
    residual_stone_intervention_costs = eswl_reintervention_patients * eswl_cost +
      urs_reintervention_patients * urs_cost +
      pcnl_reintervention_patients * pcnl_cost,
    .keep = "all"
  )
  
  # Total Costs
  total_cost <- data %>% mutate(
    total_cost = initial_costs + (3 * lr_annual_follow_up_costs) + (4 * hr_annual_follow_up_costs) + residual_stone_intervention_costs
  )
  return(total_cost)
}
```
\newpage

## Calculate total cost function - CT F/U 
```{r}
calculate_total_sf_cost_ct_fu <- function(data) {
  # Initial Costs
  data <- data %>% mutate(initial_costs = (total_sf_patients * (
    initial_consultation_cost + 2 * (clinic_review_cost + ct_cost) + (total_sf_patients * 0.5 * urine_24_hr_cost)
  )),
  .keep = "all")
  
  # Follow-up Costs
  data <- data %>% mutate(
    lr_annual_follow_up_costs = (total_sf_patients * 0.5) * (clinic_review_cost + ct_cost),
    #low risk patients
    hr_annual_follow_up_costs = (total_sf_patients *
                                   0.5) * (clinic_review_cost + ct_cost + urine_24_hr_cost),
    # high risk patients
    .keep = "all"
  )
  
  
  # Additional Intervention for Residual Stones
  data <- data %>% mutate(
    residual_stone_intervention_patients = eswl_residual_symptomatic + urs_residual_symptomatic + pcnl_residual_symptomatic,
    eswl_reintervention_patients = residual_stone_intervention_patients * eswl_proportion,
    urs_reintervention_patients = residual_stone_intervention_patients * urs_proportion,
    pcnl_reintervention_patients = residual_stone_intervention_patients * pcnl_proportion,
    residual_stone_intervention_costs = eswl_reintervention_patients * eswl_cost +
      urs_reintervention_patients * urs_cost +
      pcnl_reintervention_patients * pcnl_cost,
    .keep = "all"
  )
  
  # Total Costs
  total_cost <- data %>% mutate(
    total_cost = initial_costs + (3 * lr_annual_follow_up_costs) + (4 * hr_annual_follow_up_costs) + residual_stone_intervention_costs
  )
  return(total_cost)
}
```
\newpage

## Cost Calculation Function - CT for those having had an intervention otherwise XR
```{r}
calculate_total_sf_cost_ct_xr_fu <- function(data) {
  # Initial Costs
  data <- data %>% mutate(initial_costs = (((elective_procedures_n + emergency_procedures_n) * (
    initial_consultation_cost + (clinic_review_cost + ct_cost) + (clinic_review_cost + imaging_cost)
  )
  ) + (
    total_sf_patients - (elective_procedures_n + emergency_procedures_n)
  ) * (initial_consultation_cost + 2 * (clinic_review_cost + ct_cost)) + (total_sf_patients * 0.5 * urine_24_hr_cost)
  ), .keep = "all")
  
  # Follow-up Costs
  data <- data %>% mutate(
    lr_annual_follow_up_costs = (total_sf_patients * 0.5) * (clinic_review_cost + ct_cost),
    #low risk patients
    hr_annual_follow_up_costs = (total_sf_patients *
                                   0.5) * (clinic_review_cost + ct_cost + urine_24_hr_cost),
    # high risk patients
    .keep = "all"
  )
  
  
  # Additional Intervention for Residual Stones
  data <- data %>% mutate(
    residual_stone_intervention_patients = eswl_residual_symptomatic + urs_residual_symptomatic + pcnl_residual_symptomatic,
    eswl_reintervention_patients = residual_stone_intervention_patients * eswl_proportion,
    urs_reintervention_patients = residual_stone_intervention_patients * urs_proportion,
    pcnl_reintervention_patients = residual_stone_intervention_patients * pcnl_proportion,
    residual_stone_intervention_costs = eswl_reintervention_patients * eswl_cost +
      urs_reintervention_patients * urs_cost +
      pcnl_reintervention_patients * pcnl_cost,
    .keep = "all"
  )
  
  # Total Costs
  total_cost <- data %>% mutate(
    total_cost = initial_costs + (3 * lr_annual_follow_up_costs) + (4 * hr_annual_follow_up_costs) + residual_stone_intervention_costs
  )
  return(total_cost)
}
```
\newpage

# Complete Model Functions
## Display Estimated 5 year event rate from Literature
```{r}
global_rec_rate %>%
  as_tibble() %>%
  mutate("Percentage (%)" = value * 100,
         .keep = "unused") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage

## Test score simulation and ROC curves
```{r}
simulate_and_plot_roc <- function(auc_targets, 
                                  noise_sds,  
                                  event_rate = global_rec_rate, # Estimated Global 5 year event rate calculated from Tzelves et al. 2023 Eur Urol Focus
                                  bins = 100, 
                                  year,
                                  total_or_clinically_significant = c("clinically_significant", "total"),
                                  seed = 123,
                                  max_iterations = 100,
                                  tolerance = 0.001,
                                  monte_carlo = TRUE,
                                  mc_iterations = 1000,
                                  return_individual_scores = TRUE) {
  set.seed(seed)
  
  # Helper function to calculate AUC given beta parameters
  calculate_auc_from_beta <- function(alpha_event, beta_event, alpha_nonevent, beta_nonevent, 
                                     n_events, n_nonevents, temp_seed = NULL) {
    if (!is.null(temp_seed)) set.seed(temp_seed)
    scores_event_temp <- rbeta(n_events, shape1 = alpha_event, shape2 = beta_event)
    scores_nonevent_temp <- rbeta(n_nonevents, shape1 = alpha_nonevent, shape2 = beta_nonevent)
    labels_temp <- c(rep(1, n_events), rep(0, n_nonevents))
    scores_temp <- c(scores_event_temp, scores_nonevent_temp)
    wilcox_result <- suppressWarnings(wilcox.test(scores_event_temp, scores_nonevent_temp))
    auc_temp <- wilcox_result$statistic / (n_events * n_nonevents)
    return(as.numeric(auc_temp))
  }
  
  # Optimization function to find best beta parameters
  optimize_beta_params <- function(target_auc, base_shape, n_events, n_nonevents) {
    
    # Objective function to minimize
    objective <- function(noise_sd) {
      alpha_event <- noise_sd[1]
      beta_event <- noise_sd[2] 
      alpha_nonevent <- noise_sd[3]
      beta_nonevent <- noise_sd[4]
      
      # Ensure parameters are positive
      if (any(noise_sd <= 0.01)) return(1000)
      
      # Calculate AUC with these parameters
      auc_calc <- calculate_auc_from_beta(alpha_event, beta_event, alpha_nonevent, beta_nonevent,
                                         n_events, n_nonevents, temp_seed = seed + 999)
      
      # Return squared difference from target
      return((auc_calc - target_auc)^2)
    }
    
    # Initial parameter guess based on target AUC and base shape
    separation_factor <- 2 * (target_auc - 0.5)
    
    initial_params <- c(
      alpha_event = base_shape + separation_factor * base_shape,
      beta_event = max(base_shape - separation_factor * base_shape * 0.5, 0.1),
      alpha_nonevent = max(base_shape - separation_factor * base_shape * 0.5, 0.1), 
      beta_nonevent = base_shape + separation_factor * base_shape
    )
    
    # Optimize using optim
    result <- optim(par = initial_params, 
                   fn = objective,
                   method = "L-BFGS-B",
                   lower = rep(0.01, 4),
                   upper = rep(100, 4),
                   control = list(maxit = max_iterations))
    
    return(list(
      alpha_event = result$par[1],
      beta_event = result$par[2],
      alpha_nonevent = result$par[3], 
      beta_nonevent = result$par[4],
      final_error = sqrt(result$value),
      convergence = result$convergence
    ))
  }
  
  # Monte Carlo simulation function
  run_monte_carlo <- function(alpha_event, beta_event, alpha_nonevent, beta_nonevent,
                             n_events_sf, n_events_less4, n_events_more4,
                             non_events_sf, non_events_less4, non_events_more4,
                             mc_iterations, base_seed) {
    
    mc_results <- list()
    individual_scores_all <- list()
    
    total_individuals <- n_events_sf + n_events_less4 + n_events_more4 + 
                        non_events_sf + non_events_less4 + non_events_more4
    
    # Create individual IDs and fixed characteristics
    individual_data <- tibble(
      individual_id = 1:total_individuals,
      stone_free_status = c(rep("SF", n_events_sf + non_events_sf),
                           rep("less4", n_events_less4 + non_events_less4),
                           rep("more4", n_events_more4 + non_events_more4)),
      true_outcome = c(rep(1, n_events_sf), rep(0, non_events_sf),
                      rep(1, n_events_less4), rep(0, non_events_less4), 
                      rep(1, n_events_more4), rep(0, non_events_more4)),
      group = c(rep("event", n_events_sf + n_events_less4 + n_events_more4),
               rep("nonevent", non_events_sf + non_events_less4 + non_events_more4))
    )
    
    # Store scores for each individual across all MC iterations
    if (return_individual_scores) {
      individual_scores_matrix <- matrix(nrow = total_individuals, ncol = mc_iterations)
    }
    
    cat("Running Monte Carlo simulation with", mc_iterations, "iterations...\n")
    pb <- txtProgressBar(min = 0, max = mc_iterations, style = 3)
    
    for (iter in 1:mc_iterations) {
      set.seed(base_seed + iter)
      
      # Generate scores for this iteration
      n_events_total <- n_events_sf + n_events_less4 + n_events_more4
      n_nonevents_total <- non_events_sf + non_events_less4 + non_events_more4
      
      scores_event <- rbeta(n_events_total, shape1 = alpha_event, shape2 = beta_event)
      scores_nonevent <- rbeta(n_nonevents_total, shape1 = alpha_nonevent, shape2 = beta_nonevent)
      
      all_scores <- c(scores_event, scores_nonevent)
      all_labels <- c(rep(1, n_events_total), rep(0, n_nonevents_total))
      
      # Store individual scores
      if (return_individual_scores) {
        individual_scores_matrix[, iter] <- all_scores
      }
      
      # Calculate AUC for this iteration
      roc_obj_iter <- pROC::roc(response = all_labels, predictor = all_scores, quiet = TRUE)
      auc_iter <- as.numeric(roc_obj_iter$auc)
      
      # Get optimal threshold and calculate metrics
      best_thresh_iter <- coords(roc_obj_iter, "best", ret = "threshold", best.method = "youden")$threshold[1]
      predictions_iter <- ifelse(all_scores > best_thresh_iter, 1, 0)
      
      # Calculate performance metrics
      conf_matrix_iter <- confusionMatrix(as.factor(predictions_iter), as.factor(all_labels), positive = "1")
      
      mc_results[[iter]] <- list(
        iteration = iter,
        auc = auc_iter,
        threshold = best_thresh_iter,
        sensitivity = conf_matrix_iter$byClass["Sensitivity"],
        specificity = conf_matrix_iter$byClass["Specificity"],
        ppv = conf_matrix_iter$byClass["Pos Pred Value"],
        npv = conf_matrix_iter$byClass["Neg Pred Value"],
        accuracy = conf_matrix_iter$overall["Accuracy"],
        scores_mean_event = mean(scores_event),
        scores_mean_nonevent = mean(scores_nonevent),
        scores_sd_event = sd(scores_event),
        scores_sd_nonevent = sd(scores_nonevent)
      )
      
      setTxtProgressBar(pb, iter)
    }
    close(pb)
    
    # Compile MC results into summary statistics
    mc_summary <- bind_rows(mc_results) %>%
      summarise(
        iterations = n(),
        auc_mean = mean(auc, na.rm = TRUE),
        auc_sd = sd(auc, na.rm = TRUE),
        auc_median = median(auc, na.rm = TRUE),
        auc_q25 = quantile(auc, 0.25, na.rm = TRUE),
        auc_q75 = quantile(auc, 0.75, na.rm = TRUE),
        threshold_mean = mean(threshold, na.rm = TRUE),
        threshold_sd = sd(threshold, na.rm = TRUE),
        sensitivity_mean = mean(sensitivity, na.rm = TRUE),
        sensitivity_sd = sd(sensitivity, na.rm = TRUE),
        specificity_mean = mean(specificity, na.rm = TRUE),
        specificity_sd = sd(specificity, na.rm = TRUE),
        accuracy_mean = mean(accuracy, na.rm = TRUE),
        accuracy_sd = sd(accuracy, na.rm = TRUE),
        scores_event_mean_avg = mean(scores_mean_event, na.rm = TRUE),
        scores_nonevent_mean_avg = mean(scores_mean_nonevent, na.rm = TRUE)
      )
    
    # Individual score statistics
    individual_score_stats <- NULL
    if (return_individual_scores) {
      individual_score_stats <- individual_data %>%
        mutate(
          score_mean = rowMeans(individual_scores_matrix, na.rm = TRUE),
          score_sd = apply(individual_scores_matrix, 1, sd, na.rm = TRUE),
          score_median = apply(individual_scores_matrix, 1, median, na.rm = TRUE),
          score_q25 = apply(individual_scores_matrix, 1, quantile, 0.25, na.rm = TRUE),
          score_q75 = apply(individual_scores_matrix, 1, quantile, 0.75, na.rm = TRUE),
          score_min = apply(individual_scores_matrix, 1, min, na.rm = TRUE),
          score_max = apply(individual_scores_matrix, 1, max, na.rm = TRUE)
        )
    }
    
    return(list(
      mc_summary = mc_summary,
      mc_detailed = bind_rows(mc_results),
      individual_scores = individual_score_stats,
      individual_data = individual_data
    ))
  }
  
  results <- list()
  i <- 1
  
  for (auc_target in auc_targets) {
    for (noise_sd in noise_sds) {
      
      # Calculate n
      year_rates <- hes_data_elective_emergency %>% filter(year == !!year)
      
      if (total_or_clinically_significant == "clinically_significant") {
        n <- year_rates$clinically_significant_n
        total_sf_patients <- round(year_rates$total_sf_clin_signif, digits = 0)
      } else {
        n <- year_rates$total_patients
        total_sf_patients <- round(year_rates$total_sf_patients, digits = 0)
      }
      
      n_events <- round(n * event_rate)
      n_nonevents <- n - n_events
      
      # Simulate stone free status
      sf_patients <- round(total_sf_patients, digits = 0)
      nsf_patients <- n - sf_patients
      more4_patients <- round(nsf_patients * 0.1)
      less4_patients <- nsf_patients - more4_patients
      
      # Calculate event rates
      n_events_sf <- round(sf_patients * sf_5yr_event_rate, digits = 0)
      n_events_less4 <- round(less4_patients * less4_5yr_event_rate, digits = 0)
      n_events_more4 <- round(more4_patients * more4_5yr_event_rate, digits = 0)
      n_events_recalculated <- round((n_events_sf + n_events_less4 + n_events_more4), digits = 0)
      
      # Calculate non event rates
      non_events_sf <- sf_patients - n_events_sf
      non_events_less4 <- less4_patients - n_events_less4
      non_events_more4 <- more4_patients - n_events_more4
      n_nonevents_recalculated <- non_events_sf + non_events_less4 + non_events_more4
      
      # Optimize beta parameters to achieve target AUC
      cat("\n--- Optimizing parameters for Simulation", i, "---\n")
      cat("Target AUC:", auc_target, ", Shape Parameter:", noise_sd, "\n")
      cat("Optimizing beta distribution parameters...\n")
      
      opt_result <- optimize_beta_params(auc_target, noise_sd, 
                                        n_events_recalculated, n_nonevents_recalculated)
      
      alpha_event <- opt_result$alpha_event
      beta_event <- opt_result$beta_event
      alpha_nonevent <- opt_result$alpha_nonevent
      beta_nonevent <- opt_result$beta_nonevent
      
      cat("Optimization converged:", opt_result$convergence == 0, 
          "| Final error:", round(opt_result$final_error, 4), "\n")
      
      # Run Monte Carlo simulation if requested
      mc_results <- NULL
      if (monte_carlo) {
        cat("Starting Monte Carlo simulation...\n")
        mc_results <- run_monte_carlo(alpha_event, beta_event, alpha_nonevent, beta_nonevent,
                                     n_events_sf, n_events_less4, n_events_more4,
                                     non_events_sf, non_events_less4, non_events_more4,
                                     mc_iterations, seed)
      }
      
      # Generate single realization for plotting (using original seed)
      set.seed(seed)
      scores_event <- rbeta(n_events_recalculated, shape1 = alpha_event, shape2 = beta_event)
      scores_nonevent <- rbeta(n_nonevents_recalculated, shape1 = alpha_nonevent, shape2 = beta_nonevent)
      
      # Combine scores
      scores <- c(scores_event, scores_nonevent)
      stone_free_status <- c(rep("SF", n_events_sf), rep("less4", n_events_less4), rep("more4", n_events_more4),
                           rep("SF", non_events_sf), rep("less4", non_events_less4), rep("more4", non_events_more4))
      labels <- c(rep(1, n_events_sf), rep(1, n_events_less4), rep(1, n_events_more4),
                 rep(0, non_events_sf), rep(0, non_events_less4), rep(0, non_events_more4))
      
      scores_rescaled <- scores
      
      data_for_roc <- tibble(
        labels = factor(labels),
        scores_rescaled = scores_rescaled,
        scores = scores,
        stone_free_status = factor(stone_free_status, levels = c("SF", "less4", "more4"))
      ) 
      
      # Create ROC object
      roc_obj <- pROC::roc(response = data_for_roc$labels, predictor = data_for_roc$scores_rescaled)
      auc_actual <- round(as.numeric(roc_obj$auc), digits = 3) 
      auc_error <- abs(auc_actual - auc_target)
      
      # ROC plot with Monte Carlo info if available
      annotation_text <- paste0("Target AUC = ", round(auc_target, 3), 
                               "\nSingle Run AUC = ", round(auc_actual, 3),
                               "\nError = ", round(auc_error, 4))
      
      if (monte_carlo && !is.null(mc_results)) {
        annotation_text <- paste0(annotation_text,
                                 "\n--- Monte Carlo (n=", mc_iterations, ") ---",
                                 "\nMean AUC = ", round(mc_results$mc_summary$auc_mean, 3),
                                 "\nAUC SD = ", round(mc_results$mc_summary$auc_sd, 4),
                                 "\nAUC 95% CI = [", round(mc_results$mc_summary$auc_q25, 3), 
                                 ", ", round(mc_results$mc_summary$auc_q75, 3), "]")
      }
      
      p_roc <- ggroc(roc_obj) +
        geom_abline(intercept = 1, slope = 1, color = "gray", linetype = "dashed") +
        ggtitle(paste0("ROC Curve with Monte Carlo Simulation\n(Target AUC = ", 
                      round(auc_target, 3), ", Shape = ", noise_sd, ")")) +
        theme_minimal() +
        annotate("text", x = 0.6, y = 0.3, label = annotation_text, size = 3, hjust = 0)
      
      # Get best threshold and confusion matrix for single run
      best_thresh <- coords(roc_obj, "best", ret = "threshold", best.method = "youden") %>% slice_head(n=1)
      data_for_roc <- data_for_roc %>% mutate(predictions = ifelse(scores_rescaled > best_thresh$threshold, 1, 0))
      conf_matrix <- confusionMatrix(as.factor(data_for_roc$predictions), as.factor(data_for_roc$labels))
      
      # Print results
      cat("Target AUC:", auc_target, "| Single Run AUC:", auc_actual, "| Error:", round(auc_error, 4), "\n")
      if (monte_carlo && !is.null(mc_results)) {
        cat("Monte Carlo Results (", mc_iterations, " iterations):\n")
        cat("  Mean AUC:", round(mc_results$mc_summary$auc_mean, 4), 
            " SD:", round(mc_results$mc_summary$auc_sd, 4), "\n")
        cat("  AUC Range: [", round(mc_results$mc_summary$auc_q25, 3), ", ", 
            round(mc_results$mc_summary$auc_q75, 3), "]\n")
        cat("  Mean Accuracy:", round(mc_results$mc_summary$accuracy_mean, 4), 
            " SD:", round(mc_results$mc_summary$accuracy_sd, 4), "\n")
      }
      
      # Calculate theoretical means of the beta distributions
      mean_event <- alpha_event / (alpha_event + beta_event)
      mean_nonevent <- alpha_nonevent / (alpha_nonevent + beta_nonevent)
      
      # Enhanced density plot
      plot_title <- paste0("Target AUC:", auc_target)
      
      p_density <- ggplot(data_for_roc, aes(x = scores, fill = labels)) +
        geom_density(alpha = 0.5) +
        labs(title = plot_title,
             x = "Score (0-1)", y = "Density") +
        theme_minimal() +
        xlim(0, 1)
      
      # Histogram of scores by label
      p_hist <- ggplot(data_for_roc, aes(x = scores, fill = labels)) +
        geom_histogram(position = "identity", alpha = 0.5, bins = bins) +
        labs(title = "Histogram of Scores",
             x = "Score (0-1)", y = "Count") +
        theme_minimal() +
        xlim(0, 1)
      
      results[[i]] <- list(
        scores = (data_for_roc %>% cbind(auc_target = auc_target)),
        auc_target = auc_target,
        auc_actual = auc_actual,
        auc_error = auc_error,
        noise_sd = noise_sd,
        alpha_event = alpha_event,
        beta_event = beta_event,
        alpha_nonevent = alpha_nonevent,
        beta_nonevent = beta_nonevent,
        mean_event = mean_event,
        mean_nonevent = mean_nonevent,
        optimization_converged = opt_result$convergence == 0,
        monte_carlo = monte_carlo,
        mc_iterations = ifelse(monte_carlo, mc_iterations, 0),
        mc_results = mc_results,
        roc_plot = p_roc,
        density_plot = p_density,
        histogram_plot = p_hist,
        confusion_matrix = conf_matrix,
        roc_obj = roc_obj
      )
      
      i <- i + 1
    }
  }
  
  return(results)
}
```
\newpage

## Complete Initial Population simulation
```{r}
simulate_complete_population_distribution <- function(total_patients,
                                                      total_sf_patients,
                                                      prevalence = 0.5,
                                                      verbose = TRUE) {
  if (verbose) cat("Starting simulation...\n")
  
  # Calculate group sizes
  sf_patients <- total_sf_patients
  nsf_patients <- total_patients - total_sf_patients
  more4_patients <- round(nsf_patients * 0.1)
  less4_patients <- nsf_patients - more4_patients
  
  # Assuming 50:50 sex split
  counts <- list(
    n_f_sf = round(sf_patients * 0.5),
    n_m_sf = sf_patients - round(sf_patients * 0.5),
    n_f_nsf_less4 = round(less4_patients * 0.5),
    n_m_nsf_less4 = less4_patients - round(less4_patients * 0.5),
    n_f_nsf_more4 = round(more4_patients * 0.5),
    n_m_nsf_more4 = more4_patients - round(more4_patients * 0.5)
  )
  
  if (verbose) cat("Generating age distributions...\n")
  
  generate_age <- function(n, mean, sd) {
    if (n > 0) {
      ages <- pmax(round(rnorm(n, mean = mean, sd = sd)), 1)
      if (verbose) cat(sprintf("  Generating %d ages (mean = %.1f, sd = %.1f)...\n", n, mean, sd))
      return(ages)
    } else {
      return(numeric(0))
    }
  }
  
  age_values <- list(
    generate_age(counts$n_f_sf, 39.3, 18.1),
    generate_age(counts$n_m_sf, 38.1, 18),
    generate_age(counts$n_f_nsf_less4, 39.3, 18.1),
    generate_age(counts$n_m_nsf_less4, 38.1, 18),
    generate_age(counts$n_f_nsf_more4, 39.3, 18.1),
    generate_age(counts$n_m_nsf_more4, 38.1, 18)
  )
  
  sex_labels <- c(
    rep("female", counts$n_f_sf),
    rep("male", counts$n_m_sf),
    rep("female", counts$n_f_nsf_less4),
    rep("male", counts$n_m_nsf_less4),
    rep("female", counts$n_f_nsf_more4),
    rep("male", counts$n_m_nsf_more4)
  )
  
  sf_labels <- c(
    rep("SF", counts$n_f_sf + counts$n_m_sf),
    rep("less4", counts$n_f_nsf_less4 + counts$n_m_nsf_less4),
    rep("more4", counts$n_f_nsf_more4 + counts$n_m_nsf_more4)
  )
  
  age_vector <- unlist(age_values)
  
  if (verbose) cat("Constructing final population tibble...\n")
  
  population <- tibble(
    sex = factor(sex_labels),
    age = age_vector,
    stone_free_status = factor(sf_labels, levels = c("SF", "less4", "more4"))
  )
  
  if (verbose) cat("Simulation complete.\n")
  return(population)
}
```
\newpage

## Complete Population Simulation over time
```{r}
complete_fu_simulation_over_time <- function(original_data,
                                             score_data_auc,
                                             target_auc = c(0.55, 0.6, 0.65),
                                             years = 5,
                                             death_rates_ons,
                                             base_year) {
  set.seed(1234)  
  
  results_list <- list()
  
  for (auc in target_auc) {
    message("Simulating for AUC: ", auc)
    
    # Filter score_data_auc for auc_target
    index <- ifelse(auc == 0.55, 1,
                    ifelse(auc == 0.6, 2,
                           ifelse(auc == 0.65, 3,
                                  ifelse(auc == 0.7, 4,
                                         ifelse(auc == 0.75, 5,
                                                ifelse(auc == 0.8, 6,
                                                       ifelse(auc == 0.85, 7,
                                                              ifelse(auc == 0.9, 8,
                                                                     ifelse(auc == 0.95, 9, NA)))))))))
    filtered_scores <- score_data_auc[[index]]$scores %>% as_tibble()
    filtered_scores$stone_free_status <- factor(filtered_scores$stone_free_status, 
                                                levels = c("SF",
                                                           "less4",
                                                           "more4"))
    
    # Combine original data with scores 
    original_data_sorted <- original_data %>%
      arrange(stone_free_status) %>% subset(select = -stone_free_status)
    
    filtered_scores_sorted <- filtered_scores %>%
      arrange(stone_free_status)
    
    sim_data <- bind_cols(original_data_sorted, filtered_scores_sorted)
    
    sim_data <- sim_data %>%
      mutate(
        prediction = ifelse(predictions == 1,
                            "Yes", "No"),
        score = scores,
        true_rec_5yr = ifelse(labels == 1,
                              "Yes", "No"),
        .keep = "unused"
      ) %>%
      mutate(
        recurrence_year_0 = "No",
        death_year_0 = "No"
      )
    
    sim_data$true_rec_5yr <- as.factor(sim_data$true_rec_5yr)
    
    # Sort Recurrence rates as per SF status
    # As per Tzelves et al. 2023, Eur Urol Focus - annual rates of recurrence:
    # SF: 5% (CT SF)
    # <4mm: 8.5% (Disease progression rate - lowest heterogeneity + highest no. studies)
    # =/>4mm: 13.2% (Intervention rate - lowest heterogeneity + highest no. studies)

      
      # Define rows with "Yes" to recurrence
      total_n <- nrow(sim_data %>% filter(true_rec_5yr == "Yes"))
      
      # Subset those with no recurrence
      sim_data_no_rec <- sim_data %>% filter(true_rec_5yr == "No") %>% 
        mutate(
          recurrence_year_5 = "No",
          recurrence_year_4 = "No",
          recurrence_year_3 = "No",
          recurrence_year_2 = "No",
          recurrence_year_1 = "No"
        )
      
      # 5yr recurrence rate known - so assign 80% of those to 4yr recurrence
      
    sim_data_rec_4yr <- sim_data %>% filter(true_rec_5yr == "Yes") %>%
      mutate(
        recurrence_year_5 = "Yes",
        recurrence_year_4 = {
          n_yes <- round(total_n * 0.8)
          n <- n()
          yes_indices <- sample(n, n_yes)
          rec <- rep("No", n)
          rec[yes_indices] <- "Yes"
          rec
        },
        recurrence_year_3 = NA
      )
    
    # Now separate the 4yr recurrence data into rec + no rec
    sim_data_no_rec_4yr <- sim_data_rec_4yr %>% filter(recurrence_year_4 == "No") %>% mutate(
      recurrence_year_3 = "No"
    )
    
    sim_data_rec_3yr <- sim_data_rec_4yr %>% filter(recurrence_year_4 == "Yes") %>% mutate(
      recurrence_year_3 = {
        n_yes <- round(total_n * 0.6)
        n <- n()
        yes_indices <- sample(n, n_yes)
        rec <- rep("No", n)
        rec[yes_indices] <- "Yes"
        rec
      }
    ) 
    
    sim_data_3yr <- sim_data_rec_3yr %>% rbind(sim_data_no_rec_4yr)
    
    # Now separate the 3yr recurrence data into rec + no rec
    sim_data_no_rec_3yr <- sim_data_3yr %>% filter(recurrence_year_3 == "No") %>% mutate(
      recurrence_year_2 = "No"
    )
    
    sim_data_rec_2yr <- sim_data_3yr %>% filter(recurrence_year_3 == "Yes") %>% mutate(
      recurrence_year_2 = {
        n_yes <- round(total_n * 0.4)
        n <- n()
        yes_indices <- sample(n, n_yes)
        rec <- rep("No", n)
        rec[yes_indices] <- "Yes"
        rec
      }
    ) 
    
    sim_data_2yr <- sim_data_rec_2yr %>% rbind(sim_data_no_rec_3yr)
    
    # Now separate the 2yr recurrence data into rec + no rec
    sim_data_no_rec_2yr <- sim_data_2yr %>% filter(recurrence_year_2 == "No") %>% mutate(
      recurrence_year_1 = "No"
    )
    
    sim_data_rec_1yr <- sim_data_2yr %>% filter(recurrence_year_2 == "Yes") %>% mutate(
      recurrence_year_1 = {
        n_yes <- round(total_n * 0.2)
        n <- n()
        yes_indices <- sample(n, n_yes)
        rec <- rep("No", n)
        rec[yes_indices] <- "Yes"
        rec
      }
    ) 
    sim_data_rec <- sim_data_rec_1yr %>% rbind(sim_data_no_rec_2yr)
    
    sim_data <- rbind(sim_data_rec,
                        sim_data_no_rec)
   
    # Simulate year by year
    for (year in 1:years) {
      current_year <- 2010 + base_year + year - 1
      message("  Year: ", current_year)
      death_col <- paste0("death_year_", year)
      
      # Assign age bands
      sim_data <- sim_data %>%
        dplyr::mutate(age_band = dplyr::case_when(
          age < 5 ~ "1-4",
          age >= 5 & age < 10 ~ "5-9",
          age >= 10 & age < 15 ~ "10-14",
          age >= 15 & age < 20 ~ "15-19",
          age >= 20 & age < 25 ~ "20-24",
          age >= 25 & age < 30 ~ "25-29",
          age >= 30 & age < 35 ~ "30-34",
          age >= 35 & age < 40 ~ "35-39",
          age >= 40 & age < 45 ~ "40-44",
          age >= 45 & age < 50 ~ "45-49",
          age >= 50 & age < 55 ~ "50-54",
          age >= 55 & age < 60 ~ "55-59",
          age >= 60 & age < 65 ~ "60-64",
          age >= 65 & age < 70 ~ "65-69",
          age >= 70 & age < 75 ~ "70-74",
          age >= 75 & age < 80 ~ "75-79",
          age >= 80 & age < 85 ~ "80-84",
          age >= 85 & age <= 90 ~ "85-90",
          age > 90 ~ ">90"
        ))
      
      # Death rates
      male_annual_death_rate <- death_rates_ons[, 1:2] %>%
        cbind("Male_death_rate" = death_rates_ons[, base_year]) %>%
        filter(sex == "Male")
      
      female_annual_death_rate <- death_rates_ons[, 1:2] %>%
        cbind("Female_death_rate" = death_rates_ons[, base_year]) %>%
        filter(sex == "Female")
      
      death_rate <- male_annual_death_rate %>%
        left_join(female_annual_death_rate, by = c("Age_range" = "Age_range")) %>%
        mutate(gender = sex.x, .keep = "all") %>%
        subset(select = -c(sex.x, sex.y))
      
      sim_data <- simulate_death_for_year(sim_data, death_rate, year)

      
      # Age the population by 1 year
      sim_data <- sim_data %>%
        mutate(
          age = age + 1
        ) 
    }
    
    sim_data$auc_target <- auc
    
    sim_data <- sim_data %>% 
      mutate(
        adjusted_recurrence_year_0 = "No",
        adjusted_recurrence_year_1 = case_when(
          death_year_1 == "No" & recurrence_year_1 == "Yes" ~ "Yes",
          death_year_1 == "No" & recurrence_year_1 == "No" ~ "No",
          death_year_1 == "Yes" ~ "No", 
          TRUE ~ NA_character_
        ),
        adjusted_recurrence_year_2 = case_when(
          death_year_2 == "No" & recurrence_year_2 == "Yes" ~ "Yes",
          death_year_2 == "No" & recurrence_year_2 == "No" ~ "No",
          death_year_2 == "Yes" ~ "No",  
          TRUE ~ NA_character_
        ),
        adjusted_recurrence_year_3 = case_when(
          death_year_3 == "No" & recurrence_year_3 == "Yes" ~ "Yes",
          death_year_3 == "No" & recurrence_year_3 == "No" ~ "No",
          death_year_3 == "Yes" ~ "No",  
          TRUE ~ NA_character_
        ),
        adjusted_recurrence_year_4 = case_when(
          death_year_4 == "No" & recurrence_year_4 == "Yes" ~ "Yes",
          death_year_4 == "No" & recurrence_year_4 == "No" ~ "No",
          death_year_4 == "Yes" ~ "No",  
          TRUE ~ NA_character_
        ),
        adjusted_recurrence_year_5 = case_when(
          death_year_4 == "No" & recurrence_year_4 == "Yes" ~ "Yes",
          death_year_4 == "No" & recurrence_year_4 == "No" ~ "No",
          death_year_4 == "Yes" ~ "No",  
          TRUE ~ NA_character_
        ),
      )
    
    
    results_list[[as.character(auc)]] <- sim_data
  }
  
  final_simulation <- dplyr::bind_rows(results_list)
  return(final_simulation)
}

# Function to assign death rates to individuals each year
simulate_death_for_year <- function(sim_data, death_rate, year) {
  sim_data <- sim_data %>%
    mutate(death_prev = ifelse(year == 1, "No", .[[paste0("death_year_", year - 1)]])) %>%
    group_by(sex, age_band) %>%
    group_split() %>%
    map_dfr(~{
      group <- .
      n <- nrow(group)
      
      # Get the correct death rate
      rate_row <- death_rate %>%
        filter(Age_range == unique(group$age_band)) %>%
        slice(1)  
      
      rate <- if (tolower(unique(group$sex)) == "male") {
        rate_row$Male_death_rate
      } else {
        rate_row$Female_death_rate
      }
      
      # Determine how many to assign "Yes" if they are still alive
      eligible <- group$death_prev == "No"
      num_eligible <- sum(eligible)
      num_deaths <- round(num_eligible * rate)
      
      # Randomly assign death
      death_status <- rep("No", n)
      if (num_deaths > 0) {
        death_indices <- sample(which(eligible), num_deaths)
        death_status[death_indices] <- "Yes"
      }
      
      group[[paste0("death_year_", year)]] <- ifelse(group$death_prev == "Yes", "Yes", death_status)
      group
    }) %>%
    select(-death_prev) 
  
  return(sim_data)
}

# Function to update dataset based on death rates
update_dataset_with_death_rates <- function(data, data_with_death_rates) {
  # First, create age_band in your main data to match the death rates tibble
  data <- data %>%
    mutate(
      age_band = case_when(
        age >= 1 & age <= 4 ~ "1-4",
        age >= 5 & age <= 9 ~ "5-9",
        age >= 10 & age <= 14 ~ "10-14",
        age >= 15 & age <= 19 ~ "15-19",
        age >= 20 & age <= 24 ~ "20-24",
        age >= 25 & age <= 29 ~ "25-29",
        age >= 30 & age <= 34 ~ "30-34",
        age >= 35 & age <= 39 ~ "35-39",
        age >= 40 & age <= 44 ~ "40-44",
        age >= 45 & age <= 49 ~ "45-49",
        age >= 50 & age <= 54 ~ "50-54",
        age >= 55 & age <= 59 ~ "55-59",
        age >= 60 & age <= 64 ~ "60-64",
        age >= 65 & age <= 69 ~ "65-69",
        age >= 70 & age <= 74 ~ "70-74",
        age >= 75 & age <= 79 ~ "75-79",
        age >= 80 & age <= 84 ~ "80-84",
        age >= 85 & age <= 90 ~ "85-90",
        age > 90 ~ ">90"
      )
    )
  
  # Calculate survival probabilities for each group
  survival_probs <- data_with_death_rates %>%
    mutate(survival_rate = survivors / n)
  
  # Join survival rates to your main data
  data_updated <- data %>%
    left_join(
      survival_probs %>% select(age_band, sex, survival_rate),
      by = c("age_band", "sex")
    ) %>%
    # Generate random numbers and keep survivors
    mutate(random_draw = runif(n())) %>%
    filter(random_draw <= survival_rate) %>%
    select(-random_draw, -survival_rate, -age_band)
  
  return(data_updated)
}
```
\newpage

## Function to Update Population with Colic and Intervention
```{r}
colic_intervention_rates_function <- function(population,
                                              auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95),
                                              year) {
  result <- list()
  
  for (auc_target in auc_targets)  
{
    message("Colic/Intervention rates for AUC: ", auc_target)
    subpopulation <- population %>% filter(auc_target == !!auc_target)
    
    # Calculate surviving people within each stone_free_status category
    n_sf <- nrow(subpopulation %>% filter(stone_free_status == "SF"))
    
    n_less4 <- nrow(subpopulation %>% filter(stone_free_status == "less4"))
    
    n_more4 <- nrow(subpopulation %>% filter(stone_free_status == "more4"))
    
    message("Colic/Intervention rates for SF patients, AUC: ", auc_target)
    # Stone free patients
    subpopulation_sf <- subpopulation %>% filter(stone_free_status == "SF") %>% mutate(
      colic_intervention_year_0 = "No",
      colic_intervention_year_1 = case_when(
        recurrence_year_1 == "Yes" ~ {
          n_colic <- round(n_sf * 0.5)
          n_intervention <- round(n_sf * 0.5)
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_2 = case_when(
        colic_intervention_year_1 == "Colic" ~ "Colic",
        colic_intervention_year_1 == "Intervention" ~ "Intervention",
        recurrence_year_2 == "Yes" & colic_intervention_year_1 == "No" ~ {
          n_colic <- round(n_sf * 0.5)
          n_intervention <- round(n_sf * 0.5)
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_3 = case_when(
        colic_intervention_year_2 == "Colic" ~ "Colic",
        colic_intervention_year_2 == "Intervention" ~ "Intervention",
        recurrence_year_3 == "Yes" & colic_intervention_year_2 == "No" ~ {
          n_colic <- round(n_sf * 0.5)
          n_intervention <- round(n_sf * 0.5)
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_4 = case_when(
        colic_intervention_year_3 == "Colic" ~ "Colic",
        colic_intervention_year_3 == "Intervention" ~ "Intervention",
        recurrence_year_4 == "Yes" & colic_intervention_year_3 == "No" ~ {
          n_colic <- round(n_sf * 0.5)
          n_intervention <- round(n_sf * 0.5)
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_5 = case_when(
        colic_intervention_year_4 == "Colic" ~ "Colic",
        colic_intervention_year_4 == "Intervention" ~ "Intervention",
        recurrence_year_5 == "Yes" & colic_intervention_year_4 == "No" ~ {
          n_colic <- round(n_sf * 0.5)
          n_intervention <- round(n_sf * 0.5)
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
    )
    
    message("Colic/Intervention rates for <4mm Fragments, AUC: ", auc_target)
    # <4mm fragments patients
    subpopulation_less4 <- subpopulation %>% filter(stone_free_status == "less4") %>% mutate(
      colic_intervention_year_0 = "No",
      colic_intervention_year_1 = case_when(
        recurrence_year_1 == "Yes" ~ {
          n_colic <- round(n_less4 * (1-0.88))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_2 = case_when(
        colic_intervention_year_1 == "Colic" ~ "Colic",
        colic_intervention_year_1 == "Intervention" ~ "Intervention",
        recurrence_year_2 == "Yes" & colic_intervention_year_1 == "No" ~ {
          n_colic <- round(n_less4 * (1-0.88))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_3 = case_when(
        colic_intervention_year_2 == "Colic" ~ "Colic",
        colic_intervention_year_2 == "Intervention" ~ "Intervention",
        recurrence_year_3 == "Yes" & colic_intervention_year_2 == "No" ~ {
          n_colic <- round(n_less4 * (1-0.88))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_4 = case_when(
        colic_intervention_year_3 == "Colic" ~ "Colic",
        colic_intervention_year_3 == "Intervention" ~ "Intervention",
        recurrence_year_4 == "Yes" & colic_intervention_year_3 == "No" ~ {
          n_colic <- round(n_less4 * (1-0.88))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_5 = case_when(
        colic_intervention_year_4 == "Colic" ~ "Colic",
        colic_intervention_year_4 == "Intervention" ~ "Intervention",
        recurrence_year_5 == "Yes" & colic_intervention_year_4 == "No" ~ {
          n_colic <- round(n_less4 * (1-0.88))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
    )
    
    message("Colic/Intervention rates for >=4mm Fragments, AUC: ", auc_target)
    # >=4mm fragments patients
    subpopulation_more4 <- subpopulation %>% filter(stone_free_status == "more4") %>% mutate(
      colic_intervention_year_0 = "No",
      colic_intervention_year_1 = case_when(
        recurrence_year_1 == "Yes" ~ {
          n_colic <- round(n_more4 * (1-0.985))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_2 = case_when(
        colic_intervention_year_1 == "Colic" ~ "Colic",
        colic_intervention_year_1 == "Intervention" ~ "Intervention",
        recurrence_year_2 == "Yes" & colic_intervention_year_1 == "No" ~ {
          n_colic <- round(n_more4 * (1-0.985))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_3 = case_when(
        colic_intervention_year_2 == "Colic" ~ "Colic",
        colic_intervention_year_2 == "Intervention" ~ "Intervention",
        recurrence_year_3 == "Yes" & colic_intervention_year_2 == "No" ~ {
          n_colic <- round(n_more4 * (1-0.985))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_4 = case_when(
        colic_intervention_year_3 == "Colic" ~ "Colic",
        colic_intervention_year_3 == "Intervention" ~ "Intervention",
        recurrence_year_4 == "Yes" & colic_intervention_year_3 == "No" ~ {
          n_colic <- round(n_more4 * (1-0.985))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
      colic_intervention_year_5 = case_when(
        colic_intervention_year_4 == "Colic" ~ "Colic",
        colic_intervention_year_4 == "Intervention" ~ "Intervention",
        recurrence_year_5 == "Yes" & colic_intervention_year_4 == "No" ~ {
          n_colic <- round(n_more4 * (1-0.985))
          n <- n()
          colic_indices <- sample(n, n_colic)
          rec <- rep("Intervention", n)
          rec[colic_indices] <- "Colic"
          rec
        },
        TRUE ~ "No"
      ),
    )
    
    subpopulation <- rbind(
      subpopulation_sf,
      subpopulation_less4,
      subpopulation_more4
    ) %>% as_tibble() %>% mutate(
      id = 1:n()
    ) %>% select(id, everything())
    
    
    message("Intervention types, AUC: ", auc_target)
    # Get intervention types
    years <- c(year,
              year + 1,
              year + 2,
              year + 3,
              year + 4,
              year + 5)
    
    yr_5 <- year + 5
    
    intervention_props <- hes_data_elective_emergency %>% filter(year %in% years) %>% subset(
      select = c(year, eswl_proportion, urs_proportion, pcnl_proportion)
    )
    
    years <- years %>% as_tibble() %>% mutate(year = value,
                                              .keep = "unused")
    

    
    intervention_props <- years %>% left_join(intervention_props,
                                                           by = c("year" = "year")) %>% mutate(
      eswl_proportion = case_when(is.na(eswl_proportion) ~ 0.432,
                                  TRUE ~ eswl_proportion),
      urs_proportion = case_when(is.na(urs_proportion) ~ 0.451,
                                 TRUE ~ urs_proportion),
      pcnl_proportion = case_when(is.na(pcnl_proportion) ~ 0.117,
                                  TRUE ~ pcnl_proportion),
      .keep = "all"
    )
    
    eswl_proportion <- (intervention_props %>% filter(year == yr_5))$eswl_proportion
    urs_proportion <- (intervention_props %>% filter(year == yr_5))$urs_proportion
    pcnl_proportion <- (intervention_props %>% filter(year == yr_5))$pcnl_proportion
    

    
    total_n_intervention <- nrow(subpopulation %>% filter(colic_intervention_year_5 == "Intervention"))
    
    n_swl <- round(total_n_intervention * eswl_proportion, digits = 0)
    n_urs <- round(total_n_intervention * urs_proportion, digits = 0)
    n_pcnl <- round(total_n_intervention * pcnl_proportion, digits = 0)
    
    subpopulation_swl_yr_5 <- subpopulation %>% filter(colic_intervention_year_5 == "Intervention") %>% slice_sample(
      n = n_swl
    ) %>% mutate(
      intervention_type = "ESWL",
      .keep = "all"
    ) %>% subset(select = c(id, intervention_type))
    
    subpopulation_urs_yr_5 <- subpopulation %>% filter(colic_intervention_year_5 == "Intervention" & !id %in% subpopulation_swl_yr_5$id) %>% slice_sample(
      n = n_urs
    ) %>% mutate(
      intervention_type = "URS",
      .keep = "all"
    ) %>% subset(select = c(id, intervention_type))
    
    subpopulation_pcnl_yr_5 <- subpopulation %>% filter(colic_intervention_year_5 == "Intervention" & !id %in% subpopulation_swl_yr_5$id & !id %in% subpopulation_urs_yr_5$id) %>% slice_sample(
      n = n_pcnl
    ) %>% mutate(
      intervention_type = "PCNL",
      .keep = "all"
    ) %>% subset(select = c(id, intervention_type))
    
    subpopulation_interventions_yr_5 <- rbind(subpopulation_swl_yr_5,
                                              subpopulation_urs_yr_5,
                                              subpopulation_pcnl_yr_5) 
    
    subpopulation <- subpopulation %>% left_join(subpopulation_interventions_yr_5, by = c("id" = "id")) 
      
    subpopulation <- subpopulation %>% mutate(
      intervention_type = as.factor(ifelse(is.na(intervention_type), 
                                 "None",
                                 intervention_type))
    )
    
    subpopulation$intervention_type <- factor(subpopulation$intervention_type,
                                              levels = c("ESWL",
                                                         "URS",
                                                         "PCNL",
                                                         "None"))
    
    subpopulation <- subpopulation %>% mutate(
      colic_intervention_type_year_0 = case_when(colic_intervention_year_0 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_0 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_0 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_0 == "Colic" ~ "Colic",
                                                 colic_intervention_year_0 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
      colic_intervention_type_year_1 = case_when(colic_intervention_year_1 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_1 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_1 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_1 == "Colic" ~ "Colic",
                                                 colic_intervention_year_1 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
      colic_intervention_type_year_2 = case_when(colic_intervention_year_2 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_2 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_2 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_2 == "Colic" ~ "Colic",
                                                 colic_intervention_year_2 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
      colic_intervention_type_year_3 = case_when(colic_intervention_year_3 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_3 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_3 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_3 == "Colic" ~ "Colic",
                                                 colic_intervention_year_3 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
      colic_intervention_type_year_4 = case_when(colic_intervention_year_4 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_4 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_4 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_4 == "Colic" ~ "Colic",
                                                 colic_intervention_year_4 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
      colic_intervention_type_year_5 = case_when(colic_intervention_year_5 == "Intervention" & intervention_type == "ESWL"  ~ "ESWL",
                                                 colic_intervention_year_5 == "Intervention" & intervention_type == "URS" ~ "URS",
                                                 colic_intervention_year_5 == "Intervention" & intervention_type == "PCNL" ~ "PCNL",
                                                 colic_intervention_year_5 == "Colic" ~ "Colic",
                                                 colic_intervention_year_5 == "No" ~ "No",
                                                 TRUE ~ NA_character_),
    )
    
    result[[as.character(auc_target)]] <- subpopulation
  }
# Combine all into one dataframe
final_result <- bind_rows(result)
return(final_result)
}
```
\newpage

# Run Complete Model
## Simulate Diagnostic Accuracy
### Simulate ROC curves
#### 2016
```{r}
scores_2016 <- simulate_and_plot_roc(auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                  noise_sds = c(2), 
                                  year = 2016,
                                  total_or_clinically_significant = "clinically_significant", 
                                  event_rate = global_rec_rate, 
                                  bins = 100, 
                                  seed = 123)
```
\newpage

#### 2017
```{r}
scores_2017 <- simulate_and_plot_roc(auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                     noise_sds = c(2), 
                                     year = 2017,
                                     total_or_clinically_significant = "clinically_significant", 
                                     event_rate = global_rec_rate, 
                                     bins = 100, 
                                     seed = 123)
```
\newpage

#### 2018
```{r}
scores_2018 <- simulate_and_plot_roc(auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                     noise_sds = c(2), 
                                     year = 2018,
                                     total_or_clinically_significant = "clinically_significant", 
                                     event_rate = global_rec_rate, 
                                     bins = 100, 
                                     seed = 123)
```
\newpage

#### 2019
```{r}
scores_2019 <- simulate_and_plot_roc(auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                     noise_sds = c(2), 
                                     year = 2019,
                                     total_or_clinically_significant = "clinically_significant", 
                                     event_rate = global_rec_rate, 
                                     bins = 100, 
                                     seed = 123)

```
\newpage

#### 2020
```{r}
scores_2020 <- simulate_and_plot_roc(auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                     noise_sds = c(2), 
                                     year = 2020,
                                     total_or_clinically_significant = "clinically_significant", 
                                     event_rate = global_rec_rate, 
                                     bins = 100, 
                                     seed = 123)
```
\newpage

### Plot ROC curves
```{r}
roc_data <- map_df(scores_2016, function(sim) {
  data.frame(
    specificity = rev(sim$roc_obj$specificities),
    sensitivity = rev(sim$roc_obj$sensitivities),
    auc_target = sim$auc_target,
    noise_sd = sim$noise_sd
  )
}) %>%
  mutate(
    auc_target = factor(auc_target),
    noise_sd = factor(noise_sd)
  )

auc_labels <- map_df(scores_2016, function(sim) {
  tibble(
    auc_target = factor(sim$auc_target),
    noise_sd = factor(sim$noise_sd),
    auc_actual = as.numeric(sim$roc_obj$auc)
  )
}) %>%
  distinct()

# Place labels near bottom right corner of each facet
label_positions <- auc_labels %>%
  mutate(
    x = 0.6,
    y = 0.2,
    label = paste0("Target AUC = ", round(as.numeric(auc_target), 2),
                   "\nActual AUC = ", round(auc_actual, 3))
  )

# Plot with facets and AUC labels
ggplot(roc_data, aes(x = 1 - specificity, y = sensitivity, color = auc_target)) +
  geom_line(size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  labs(
    title = "Simulated ROC Curves",
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    color = "Target AUC"
  ) +
  facet_wrap(~ noise_sd) +
  theme_minimal() +
  theme(legend.position = "bottom")

roc_plot <- ggplot(roc_data, aes(x = 1 - specificity, y = sensitivity, color = auc_target)) +
  geom_line(size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  labs(
    title = "Simulated ROC Curves",
    x = "False Positive Rate (1 - Specificity)",
    y = "True Positive Rate (Sensitivity)",
    color = "Target AUC"
  ) +
  facet_wrap(~ noise_sd) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
\newpage

### Plot Density Plots
```{r}
plots <- lapply(1:9, function(i) scores_2016[[i]]$density_plot)
plot_grid(plotlist = plots, ncol = 3)

density_plots <- plot_grid(plotlist = plots, ncol = 3)
```
\newpage

# Simulate Population
## Simulate Initial Population
### 2016
```{r}
complete_2016_pop <- simulate_complete_population_distribution(
  total_patients = clinically_signif_n_2016,
  total_sf_patients = clinically_signif_sf_n_2016,
  prevalence = 0.5,
  verbose = TRUE
)
```
\newpage

### 2017
```{r}
complete_2017_pop <- simulate_complete_population_distribution(
  total_patients = clinically_signif_n_2017,
  total_sf_patients = clinically_signif_sf_n_2017,
  prevalence = 0.5,
  verbose = TRUE
)
```
\newpage

### 2018
```{r}
complete_2018_pop <- simulate_complete_population_distribution(
  total_patients = clinically_signif_n_2018,
  total_sf_patients = clinically_signif_sf_n_2018,
  prevalence = 0.5,
  verbose = TRUE
)
```
\newpage

### 2019
```{r}
complete_2019_pop <- simulate_complete_population_distribution(
  total_patients = clinically_signif_n_2019,
  total_sf_patients = clinically_signif_sf_n_2019,
  prevalence = 0.5,
  verbose = TRUE
)

```
\newpage

### 2020
```{r}
complete_2020_pop <- simulate_complete_population_distribution(
  total_patients = clinically_signif_n_2020,
  total_sf_patients = clinically_signif_sf_n_2020,
  prevalence = 0.5,
  verbose = TRUE
)
```
\newpage

## Simulate Follow-up & Colic/Intervention
### 2016
```{r}
complete_pop_2016_fu <- complete_fu_simulation_over_time(
  original_data = complete_2016_pop,
  score_data_auc = scores_2016,
  target_auc = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  years = 5,
  death_rates_ons,
  base_year = 6
)

complete_pop_2016_fu <- colic_intervention_rates_function(complete_pop_2016_fu,
                                                          c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                          year = 2016) 
```
\newpage

### 2017
```{r}
complete_pop_2017_fu <- complete_fu_simulation_over_time(
  original_data = complete_2017_pop,
  score_data_auc = scores_2017,
  target_auc = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  years = 5,
  death_rates_ons,
  base_year = 7
)

complete_pop_2017_fu <- colic_intervention_rates_function(complete_pop_2017_fu,
                                                          c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                          year = 2017) 
```
\newpage

### 2018
```{r}
complete_pop_2018_fu <- complete_fu_simulation_over_time(
  original_data = complete_2018_pop,
  score_data_auc = scores_2018,
  target_auc = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  years = 5,
  death_rates_ons,
  base_year = 8
)

complete_pop_2018_fu <- colic_intervention_rates_function(complete_pop_2018_fu,
                                                          c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                          year = 2018) 
```
\newpage

### 2019
```{r}
complete_pop_2019_fu <- complete_fu_simulation_over_time(
  original_data = complete_2019_pop,
  score_data_auc = scores_2019,
  target_auc = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  years = 5,
  death_rates_ons,
  base_year = 9
)

complete_pop_2019_fu <- colic_intervention_rates_function(complete_pop_2019_fu,
                                                          c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                          year = 2019) 
```
\newpage

### 2020
```{r}
complete_pop_2020_fu <- complete_fu_simulation_over_time(
  original_data = complete_2020_pop,
  score_data_auc = scores_2020,
  target_auc = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  years = 5,
  death_rates_ons,
  base_year = 10
)

complete_pop_2020_fu <- colic_intervention_rates_function(complete_pop_2020_fu,
                                                          c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                          year = 2020)

```
\newpage

## Plot Outputs
### Recurrence/Survivors
#### Function to get recurrence/survivors percentages
```{r}
process_auc_group <- function(df) {
  cp <- cutpointr(df, x = score, class = recurrence_year_5, 
                  method = maximize_metric, metric = sum_sens_spec)
  cutpoint <- cp$optimal_cutpoint
  
  df <- df %>%
    mutate(risk_status = if_else(score >= cutpoint, "HR", "LR"))
  
  # Pivot to long format for recurrence and death
  long_df <- df %>%
    pivot_longer(
      cols = starts_with("recurrence_year_"),
      names_to = "year",
      names_pattern = "recurrence_year_(\\d)",
      values_to = "recurrence"
    ) %>%
    left_join(
      df %>%
        pivot_longer(
          cols = starts_with("death_year_"),
          names_to = "year_death",
          names_pattern = "death_year_(\\d)",
          values_to = "death"
        ),
      by = c("risk_status", "year" = "year_death", "sex", "age", "score", "stone_free_status", "prediction", "true_rec_5yr", "age_band", "auc_target")
    ) %>%
    mutate(
      year = as.integer(year),
      survivor = if_else(death == "No", "Yes", "No")
    )
  
  # Summarize recurrence and survivors by year and risk group
  summary_data <- long_df %>%
    group_by(risk_status, year) %>%
    summarise(
      recurrence = sum(recurrence == "Yes"),
      survivors = sum(survivor == "Yes"),
      total = n(),
      .groups = "drop"
    ) %>%
    group_by(risk_status) %>%
    mutate(
      initial_n = total[year == 0],
      recurrence_pct = recurrence / initial_n * 100,
      survivors_pct = survivors / initial_n * 100,
      auc_target = unique(df$auc_target)
    ) %>%
    pivot_longer(
      cols = c(recurrence_pct, survivors_pct),
      names_to = "status",
      values_to = "percentage"
    ) %>%
    mutate(
      status = recode(status,
                      "recurrence_pct" = "Recurrence",
                      "survivors_pct" = "Survivors")
    )
  
  return(summary_data)
}
```
\newpage

#### 2016
```{r}
final_summary <- complete_pop_2016_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)

ggplot(final_summary, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Recurrence / Survivors Over Time by AUC and Risk Group for 2016",
    subtitle = "Risk defined by cutpoint on predicted score",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2017
```{r}
final_summary <- complete_pop_2017_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)

ggplot(final_summary, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Recurrence / Survivors Over Time by AUC and Risk Group for 2017",
    subtitle = "Risk defined by cutpoint on predicted score",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2018
```{r}
final_summary <- complete_pop_2018_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)

ggplot(final_summary, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Recurrence / Survivors Over Time by AUC and Risk Group for 2018",
    subtitle = "Risk defined by cutpoint on predicted score",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2019
```{r}
final_summary <- complete_pop_2019_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)

ggplot(final_summary, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Recurrence / Survivors Over Time by AUC and Risk Group for 2019",
    subtitle = "Risk defined by cutpoint on predicted score",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2020
```{r}
final_summary <- complete_pop_2020_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)

ggplot(final_summary, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Recurrence / Survivors Over Time by AUC and Risk Group for 2020",
    subtitle = "Risk defined by cutpoint on predicted score",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

### Cumulative recurrence/survivors percentages
#### Function
```{r}
process_auc_group <- function(df) {
  cp <- cutpointr(df, x = score, class = recurrence_year_5, 
                  method = maximize_metric, metric = sum_sens_spec)
  cutpoint <- cp$optimal_cutpoint
  
  df <- df %>%
    mutate(risk_status = if_else(score >= cutpoint, "HR", "LR"))
  
  # Long format for recurrence and death
  long_df <- df %>%
    pivot_longer(
      cols = matches("^recurrence_year_\\d$"),
      names_to = "year",
      names_pattern = "recurrence_year_(\\d)",
      values_to = "recurrence"
    ) %>%
    left_join(
      df %>%
        pivot_longer(
          cols = matches("^death_year_\\d$"),
          names_to = "year_death",
          names_pattern = "death_year_(\\d)",
          values_to = "death"
        ),
      by = c("risk_status", "year" = "year_death", "sex", "age", "score", "stone_free_status", "prediction", "true_rec_5yr", "age_band", "auc_target")
    ) %>%
    mutate(
      year = as.integer(year),
      recurrence = recurrence == "Yes",
      death = death == "Yes"
    ) %>%
    group_by(risk_status, score) %>%
    arrange(year, .by_group = TRUE) %>%
    mutate(
      cumulative_recurrence = cumsum(recurrence) > 0,
      survivor = !death
    ) %>%
    ungroup()
  
  # Summarize cumulative recurrence and survivors
  summary_data <- long_df %>%
    group_by(risk_status, year) %>%
    summarise(
      cumulative_recurrence = sum(cumulative_recurrence),
      survivors = sum(survivor),
      total = n(),
      .groups = "drop"
    ) %>%
    group_by(risk_status) %>%
    mutate(
      initial_n = total[year == 0],
      cumrec_pct = cumulative_recurrence / initial_n * 100,
      survivors_pct = survivors / initial_n * 100,
      auc_target = unique(df$auc_target)
    ) %>%
    pivot_longer(
      cols = c(cumrec_pct, survivors_pct),
      names_to = "status",
      values_to = "percentage"
    ) %>%
    mutate(
      status = recode(status,
                      "cumrec_pct" = "Cumulative Recurrence",
                      "survivors_pct" = "Survivors")
    )
  
  return(list(
    summary_data = summary_data,
    cutpoint = cutpoint
  ))
}
```
\newpage

#### 2016 
```{r}
grouped_data <- complete_pop_2016_fu %>% group_by(auc_target)
keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()
results_list <- map(split_data, process_auc_group)
final_summary_2016 <- map_dfr(results_list, "summary_data")
cutpoints_2016 <- map2_dfr(
  .x = results_list,
  .y = keys[[1]],  # extract vector of auc_target values
  .f = function(result, auc_target_value) {
    tibble(auc_target = auc_target_value, cutpoint = result$cutpoint)
  }
)

ggplot(final_summary_2016, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2016 - Cumulative Recurrence and Survivors Over Time by AUC and Risk Group",
    subtitle = "Risk defined by Score Cutpoint",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2017
```{r}
grouped_data <- complete_pop_2017_fu %>% group_by(auc_target)
keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()
results_list <- map(split_data, process_auc_group)
final_summary_2017 <- map_dfr(results_list, "summary_data")
cutpoints_2017 <- map2_dfr(
  .x = results_list,
  .y = keys[[1]],  # extract vector of auc_target values
  .f = function(result, auc_target_value) {
    tibble(auc_target = auc_target_value, cutpoint = result$cutpoint)
  }
)

ggplot(final_summary_2017, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2017 - Cumulative Recurrence and Survivors Over Time by AUC and Risk Group",
    subtitle = "Risk defined by Score Cutpoint",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2018
```{r}
grouped_data <- complete_pop_2018_fu %>% group_by(auc_target)
keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()
results_list <- map(split_data, process_auc_group)
final_summary_2018 <- map_dfr(results_list, "summary_data")
cutpoints_2018 <- map2_dfr(
  .x = results_list,
  .y = keys[[1]],  # extract vector of auc_target values
  .f = function(result, auc_target_value) {
    tibble(auc_target = auc_target_value, cutpoint = result$cutpoint)
  }
)

ggplot(final_summary_2018, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2018 - Cumulative Recurrence and Survivors Over Time by AUC and Risk Group",
    subtitle = "Risk defined by Score Cutpoint",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2019
```{r}
grouped_data <- complete_pop_2019_fu %>% group_by(auc_target)
keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()
results_list <- map(split_data, process_auc_group)
final_summary_2019 <- map_dfr(results_list, "summary_data")
cutpoints_2019 <- map2_dfr(
  .x = results_list,
  .y = keys[[1]],  # extract vector of auc_target values
  .f = function(result, auc_target_value) {
    tibble(auc_target = auc_target_value, cutpoint = result$cutpoint)
  }
)

ggplot(final_summary_2019, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2019 - Cumulative Recurrence and Survivors Over Time by AUC and Risk Group",
    subtitle = "Risk defined by Score Cutpoint",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

#### 2020
##### Plot Recurrences over time
```{r}
grouped_data <- complete_pop_2020_fu %>% group_by(auc_target)
keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()
results_list <- map(split_data, process_auc_group)
final_summary_2020 <- map_dfr(results_list, "summary_data")
cutpoints_2020 <- map2_dfr(
  .x = results_list,
  .y = keys[[1]],  # extract vector of auc_target values
  .f = function(result, auc_target_value) {
    tibble(auc_target = auc_target_value, cutpoint = result$cutpoint)
  }
)

ggplot(final_summary_2020, aes(x = year, y = percentage, color = status, shape = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(aes(linetype = risk_status), linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2020 - Cumulative Recurrence and Survivors Over Time by AUC and Risk Group",
    subtitle = "Risk defined by Score Cutpoint",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom"
  )
```
\newpage

##### Plot Recurrences over time split by Stone Free status
```{r}
grouped_data <- complete_pop_2020_fu %>% 
  group_by(auc_target, stone_free_status)

keys <- grouped_data %>% group_keys()
split_data <- grouped_data %>% group_split()

# Process each group (you'll need to modify process_auc_group function if needed)
results_list <- map(split_data, process_auc_group)

# Combine results with stone_free_status information
final_summary_2020_combined <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)

# Create the modified plot focusing on risk groups
ggplot(final_summary_2020_combined, 
       aes(x = year, y = percentage, 
           color = status, 
           shape = combined_risk_group,
           linetype = combined_risk_group)) +
  geom_point(size = 2.5) +
  geom_line(linewidth = 0.8) +
  facet_wrap(~ auc_target, ncol = 3, labeller = label_both) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  # You may want to define specific shapes and linetypes for each combination
  scale_shape_manual(values = c(16, 17, 15, 18, 8, 11)) + # Adjust based on your combinations
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash", "longdash", "twodash")) +
  labs(
    title = "2020 - Cumulative Recurrence and Survivors by Stone-Free Status and Risk Group",
    subtitle = "Combined Risk Groups: Stone-Free Status + Risk Classification",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Stone-Free Status + Risk Group",
    linetype = "Stone-Free Status + Risk Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "bottom",
    legend.box = "horizontal"
  )
```
\newpage

##### Facet by Stone Free Status
```{r}
# separate facets for stone_free_status
ggplot(final_summary_2020_combined, 
       aes(x = year, y = percentage, 
           color = status, 
           shape = risk_status,
           linetype = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(linewidth = 0.8) +
  facet_grid(stone_free_status ~ auc_target, 
             labeller = labeller(
               stone_free_status = label_both,
               auc_target = label_both
             )) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "2020 - Cumulative Recurrence and Survivors by Stone-Free Status and Risk Group",
    subtitle = "Stratified by Stone-Free Status and AUC Target",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 10),
    legend.position = "bottom"
  )

simulation_over_time_plot <- ggplot(final_summary_2020_combined, 
       aes(x = year, y = percentage, 
           color = status, 
           shape = risk_status,
           linetype = risk_status)) +
  geom_point(size = 2.5) +
  geom_line(linewidth = 0.8) +
  facet_grid(stone_free_status ~ auc_target, 
             labeller = labeller(
               stone_free_status = "SF Status: ",
               auc_target = "AUC: "
             )) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "Cumulative Recurrence and Survivors by Stone-Free Status and Risk Group",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 10),
    legend.position = "bottom"
  )
```
\newpage

## Cowplot for paper
```{r}
top_row <- plot_grid(roc_plot, density_plots,
                     labels = c("A",
                                "B"),
                     label_x = 0, label_y = 0,
                     hjust = -0.5, vjust = -0.5)

overall_simulation_plot <- plot_grid(top_row, simulation_over_time_plot,
                        labels = c("",
                                   "C"),
                        nrow = 2,
                        label_x = 0, label_y = 0,
                        hjust = -0.5, vjust = -0.5)

overall_simulation_plot
```
\newpage


# Outcomes
## Radiation Dose
### Radiation Dose per Year
#### Radiation dose per year function
```{r}
calculate_radiation_doses <- function(complete_pop_yr_fu, 
                                      cutpoints_yr, 
                                      auc_targets = c(0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9, 0.95), 
                                      fu_type = "min",
                                      imaging_fu_type = "xr",
                                      xr_sens = 0.67, xr_spec = 0.98,
                                      us_sens = 0.54, us_spec = 0.91) {
  
  # Initialize list to store results for each AUC target
  results_list <- list()
  
  for (auc_target in auc_targets) {
    
    # Get cutpoint for current AUC target
    cutpoint <- (cutpoints_yr %>% filter(auc_target == !!auc_target))$cutpoint
    imaging <- sym(paste0(imaging_fu_type, "_dose"))
    complete_pop_yr_fu <- complete_pop_yr_fu %>% mutate(
      risk_status = ifelse(score < cutpoint, "LR", "HR")
    )
    
    not_sf_props <- complete_pop_yr_fu %>%
      filter(stone_free_status %in% c("less4", "more4")) %>%
      count(stone_free_status) %>%
      mutate(prop = n / sum(n)) %>%
      select(stone_free_status, prop)
    
    less4_prob <- not_sf_props$prop[not_sf_props$stone_free_status == "less4"]
    
    # Distribute SF status as determined by imaging
    if (imaging_fu_type == "xr") {
      # Get CT + XR doses for recurrence
      ct_dose <- ct_dose + xr_dose
      
      # Generate random numbers once
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= xr_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > xr_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= xr_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > xr_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original 
          ),
          .keep = "all"
        )
    } else if (imaging_fu_type == "xr_us") {
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      # Get CT + XR doses for recurrence
      ct_dose <- ct_dose + xr_dose
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= us_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > us_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= us_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > us_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original
          ),
          .keep = "all"
        )
    } else {
      # For CT imaging, no sensitivity/specificity adjustment needed as gold standard
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = stone_free_status,
          .keep = "all"
        )
      
      ct_dose <- ct_dose
    }
    
    # SF patients with minimum follow-up strategy
    if (fu_type == "min") {
      fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          rad_dose_year_0 = case_when(
            death_year_0 == "No" & recurrence_year_0 == "No" ~ 0,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_1 = case_when(
            death_year_1 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ ct_dose + (2 * swl_dose),
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ ct_dose + urs_dose,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ ct_dose + pcnl_dose,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_2 = case_when(
            # Separate Yr 2 FU into High / Low risk
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ 0,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ !!imaging,
            # Death
            death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No" ~ ct_dose + urs_dose,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence - Presumed to be SF
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging * 2,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_3 = case_when(
            # Separate Yr 3 FU into High / Low risk
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ !!imaging,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ !!imaging,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ !!imaging,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_4 = case_when(
            # Separate Yr 4 FU into High / Low risk
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ !!imaging,
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
            # FU Yr 3 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_5 = case_when(
            # Separate Yr 5 FU into High / Low risk
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ !!imaging,
            # Death
            death_year_5 == "Yes" |death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_5 == "No" & colic_intervention_type_year_5 == "Colic" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
            death_year_5 == "No" & colic_intervention_type_year_5 == "ESWL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_5 == "No" & colic_intervention_type_year_5 == "URS" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
            death_year_5 == "No" & colic_intervention_type_year_5 == "PCNL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
            # FU Yr 3 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging,
            # FU Yr 4 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
            TRUE ~ NA_real_
          )
        )
    } else {
      # SF patients with maximum follow-up strategy
      fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          rad_dose_year_0 = case_when(
            death_year_0 == "No" & recurrence_year_0 == "No" ~ 0,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_1 = case_when(
            # FU Yr 1
            death_year_1 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ ct_dose + (2 * swl_dose),
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ ct_dose + urs_dose,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ ct_dose + pcnl_dose,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_2 = case_when(
            # Separate Yr 2 FU into High / Low risk
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ 0,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ !!imaging,
            # Death
            death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No" ~ ct_dose + urs_dose,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging * 2,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_3 = case_when(
            # Separate Yr 3 FU into High / Low risk
            death_year_3 == "No" & recurrence_year_3 == "No" ~ !!imaging,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ !!imaging,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_4 = case_when(
            # Separate Yr 4 FU into High / Low risk
            death_year_4 == "No" & recurrence_year_4 == "No" ~ !!imaging,
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
            # FU Yr 3 for those with recurrence
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
            TRUE ~ NA_real_
          ),
          
          rad_dose_year_5 = case_when(
            # Separate Yr 5 FU into High / Low risk
            death_year_5 == "No" & recurrence_year_5 == "No" ~ !!imaging,
            # Death
            death_year_5 == "Yes" |death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_5 == "No" & colic_intervention_type_year_5 == "Colic" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
            death_year_5 == "No" & colic_intervention_type_year_5 == "ESWL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + (2 * swl_dose),
            death_year_5 == "No" & colic_intervention_type_year_5 == "URS" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
            death_year_5 == "No" & colic_intervention_type_year_5 == "PCNL" &
              recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + pcnl_dose,
            # FU Yr 1 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
            # FU Yr 2 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
            # FU Yr 3 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging,
            # FU Yr 4 for those with recurrence
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
            TRUE ~ NA_real_
          )
        )
    }
    
    # Less than 4mm stones
    fu_less4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "less4" & auc_target == !!auc_target) %>%
      mutate(
        rad_dose_year_0 = case_when(
          death_year_0 == "No" & recurrence_year_0 == "No" ~ 0,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_1 = case_when(
          death_year_1 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ ct_dose + (2 * swl_dose),
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ ct_dose + urs_dose,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ ct_dose + pcnl_dose,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_2 = case_when(
          death_year_2 == "No" & recurrence_year_2 == "No" ~ !!imaging,
          # Death
          death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No" ~ ct_dose + urs_dose,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging * 2,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_3 = case_when(
          death_year_3 == "No" & recurrence_year_3 == "No" ~ !!imaging,
          # Death
          death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ !!imaging,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_4 = case_when(
          death_year_4 == "No" & recurrence_year_4 == "No" ~ !!imaging,
          # Death
          death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
          # Yr 3 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_5 = case_when(
          death_year_5 == "No" & recurrence_year_5 == "No" ~ !!imaging,
          # Death
          death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_5 == "No" & colic_intervention_type_year_5 == "Colic" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
          death_year_5 == "No" & colic_intervention_type_year_5 == "ESWL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_5 == "No" & colic_intervention_type_year_5 == "URS" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
          death_year_5 == "No" & colic_intervention_type_year_5 == "PCNL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
          # Yr 3 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging,
          # Yr 4 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
          TRUE ~ NA_real_
        )
      )
    
    # More than 4mm stones
    fu_more4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "more4" & auc_target == !!auc_target) %>%
      mutate(
        rad_dose_year_0 = case_when(
          death_year_0 == "No" & recurrence_year_0 == "No" ~ 0,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_1 = case_when(
          death_year_1 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ ct_dose + (2 * swl_dose),
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ ct_dose + urs_dose,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ ct_dose + pcnl_dose,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_2 = case_when(
          death_year_2 == "No" & recurrence_year_2 == "No" ~ !!imaging * 2,
          # Death
          death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" ~ ct_dose + urs_dose, #Minimum radiation would be 1o URS
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No" ~ ct_dose + urs_dose,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 of FU for those with recurrence
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging * 2,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_3 = case_when(
          death_year_3 == "No" & recurrence_year_3 == "No" ~ !!imaging,
          # Death
          death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + urs_dose,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_1 == "No" & recurrence_year_2 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ !!imaging,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_4 = case_when(
          death_year_4 == "No" & recurrence_year_4 == "No" ~ !!imaging,
          # Death
          death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + urs_dose,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ !!imaging,
          # Yr 3 FU for those with recurrence
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
          TRUE ~ NA_real_
        ),
        
        rad_dose_year_5 = case_when(
          death_year_5 == "No" & recurrence_year_5 == "No" ~ !!imaging,
          # Death
          death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_5 == "No" & colic_intervention_type_year_5 == "Colic" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
          death_year_5 == "No" & colic_intervention_type_year_5 == "ESWL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + (2 * swl_dose),
          death_year_5 == "No" & colic_intervention_type_year_5 == "URS" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + urs_dose,
          death_year_5 == "No" & colic_intervention_type_year_5 == "PCNL" &
            recurrence_year_1 == "No" & recurrence_year_2 == "No" & recurrence_year_3 == "No" & recurrence_year_4 == "No" ~ ct_dose + pcnl_dose,
          # Yr 1 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" ~ !!imaging * 2,
          # Yr 2 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ 0,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No"  & risk_status == "HR" ~ !!imaging,
          # Yr 3 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" ~ !!imaging,
          # Yr 4 FU for those with recurrence
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" ~ !!imaging,
          TRUE ~ NA_real_
        )
      )
    
    # Combine all stone status groups for this AUC target
    combined_result <- rbind(fu_sf, fu_less4, fu_more4) %>% 
      as_tibble() %>%
      mutate(auc_target = auc_target, cutpoint = cutpoint)
    
    # Store result in list with named element
    results_list[[paste0("auc_", auc_target)]] <- combined_result
  }
  
  # Return results
  if (length(auc_targets) == 1) {
    return(results_list[[1]])
  } else {
    return(results_list)
  }
}
```
\newpage

#### Radiation dose per year plotting function
```{r}
create_radiation_dose_barplot <- function(results_list, title, cohort) {
  # Process data
  processed_data <- map_dfr(results_list, function(df) {
    auc_target <- unique(df$auc_target)[1]
    cutpoint <- unique(df$cutpoint)[1]
    
    df_with_risk <- df %>%
      filter(auc_target == !!auc_target) %>%
      mutate(
        risk_group = case_when(
          score < cutpoint ~ "Low Risk",
          score >= cutpoint ~ "High Risk",
          TRUE ~ NA_character_
        )
      ) %>%
      filter(!is.na(risk_group))
    
    df_long <- df_with_risk %>%
      select(auc_target, cutpoint, risk_group, starts_with("rad_dose_year_")) %>%
      pivot_longer(
        cols = starts_with("rad_dose_year_"),
        names_to = "year",
        values_to = "radiation_dose",
        names_prefix = "rad_dose_year_"
      ) %>%
      mutate(year = as.numeric(year))
    
    df_summary <- df_long %>%
      group_by(auc_target, risk_group, year) %>%
      summarise(
        mean_dose = mean(radiation_dose, na.rm = TRUE),
        se = sd(radiation_dose, na.rm = TRUE) / sqrt(n()),
        n = sum(!is.na(radiation_dose)),
        .groups = "drop"
      ) %>%
      filter(n > 0)
    
    return(df_summary)
  })
  
  # Long-format full data
  df_long_all <- map_dfr(results_list, function(df) {
    auc_target <- unique(df$auc_target)[1]
    cutpoint <- unique(df$cutpoint)[1]
    
    df_with_risk <- df %>%
      filter(auc_target == !!auc_target) %>%
      mutate(
        risk_group = case_when(
          score < cutpoint ~ "Low Risk",
          score >= cutpoint ~ "High Risk",
          TRUE ~ NA_character_
        )
      ) %>%
      filter(!is.na(risk_group)) %>%
      select(auc_target, cutpoint, risk_group, starts_with("rad_dose_year_")) %>%
      pivot_longer(
        cols = starts_with("rad_dose_year_"),
        names_to = "year",
        values_to = "radiation_dose",
        names_prefix = "rad_dose_year_"
      ) %>%
      mutate(year = as.numeric(year))
    
    return(df_with_risk)
  })
  
  # Unadjusted p-values
  pval_data <- df_long_all %>%
    group_by(auc_target, year) %>%
    summarise(
      p = tryCatch(t.test(radiation_dose ~ risk_group)$p.value, error = function(e) NA_real_),
      .groups = "drop"
    )
  
  # Apply FDR correction
  pval_data <- pval_data %>%
    mutate(p_fdr = p.adjust(p, method = "fdr")) 
  
  # Merge into processed data
  processed_data <- processed_data %>%
    left_join(pval_data, by = c("auc_target", "year"))
  
  # y-position for labels and brackets
  label_data <- processed_data %>%
    group_by(auc_target, year) %>%
    summarise(
      y_position = max(mean_dose + se, na.rm = TRUE) + 1,
      p_fdr = unique(p_fdr),
      .groups = "drop"
    )  %>%
    mutate(
      signif_label = case_when(
        is.na(p_fdr)     ~ "ns",
        p_fdr <= 0.001   ~ "***",
        p_fdr <= 0.01    ~ "**",
        p_fdr <= 0.05    ~ "*",
        TRUE             ~ "ns"
      ),
      # Convert year to factor positions for x coordinates
      x_pos = as.numeric(factor(year)),
      start = x_pos - 0.2,
      end = x_pos + 0.2,
      group = paste0("AUC Target: ", auc_target)
    ) %>%
    filter(signif_label != "ns")  # keep only significant
  
  # Now plot
  p <- processed_data %>%
    ggplot(aes(
      x = factor(year),
      y = mean_dose,
      fill = risk_group
    )) +
    geom_col(
      position = position_dodge(width = 0.7),
      alpha = 0.8,
      width = 0.7
    ) +
    geom_errorbar(
      aes(ymin = mean_dose - se, ymax = mean_dose + se),
      position = position_dodge(width = 0.7),
      width = 0.2
    ) +
    facet_wrap(~ paste0("AUC Target: ", auc_target),
               scales = "free_y",
               ncol = 3) +
    scale_fill_manual(
      values = c(
        "Low Risk" = "#2E86AB",
        "High Risk" = "#A23B72"
      ),
      name = "Risk Group"
    ) +
    labs(
      title = paste0("Mean Radiation Dose by Follow-up Year and Risk Group for Cohort: ", cohort),
      subtitle = title,
      x = "Follow-up Year",
      y = "Radiation Dose (mSv)",
      caption = "Significance shown after FDR correction"
    ) + 
    ylim(c(0, 11)) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray60"),
      strip.text = element_text(size = 10, face = "bold"),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      legend.title = element_text(size = 11, face = "bold"),
      legend.text = element_text(size = 10),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank()
    )
  
  # Add significance annotations using geom_text and geom_segment
  if (nrow(label_data) > 0) {
    p <- p + 
      geom_segment(data = label_data,
                   aes(x = start, xend = end, y = y_position, yend = y_position),
                   inherit.aes = FALSE, color = "black") +
      geom_segment(data = label_data,
                   aes(x = start, xend = start, y = y_position, yend = y_position - 0.2),
                   inherit.aes = FALSE, color = "black") +
      geom_segment(data = label_data,
                   aes(x = end, xend = end, y = y_position, yend = y_position - 0.2),
                   inherit.aes = FALSE, color = "black") +
      geom_text(data = label_data,
                aes(x = (start + end) / 2, y = y_position + 0.3, label = signif_label),
                inherit.aes = FALSE, size = 3, vjust = 0.5)
  }
  
  return(p)
}
```
\newpage

#### 2016
##### Minimum Follow-up, XR 
```{r}
rad_doses_2016_cohort_min_xr <- calculate_radiation_doses(complete_pop_2016_fu, 
                                                       cutpoints_2016, 
                                                       fu_type = "min",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2016_cohort_min_xr,
                              title = "XR only, Minimum EAU Follow-up",
                              cohort = 2016)
```
\newpage

##### Maximum Follow-up, XR 
```{r}
rad_doses_2016_cohort_max_xr <- calculate_radiation_doses(complete_pop_2016_fu, 
                                                       cutpoints_2016, 
                                                       fu_type = "max",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2016_cohort_max_xr,
                              title = "XR only, Maximum EAU Follow-up",
                              cohort = 2016)
```
\newpage

##### Minimum Follow-up, ULDCT
```{r}
rad_doses_2016_cohort_min_ct <- calculate_radiation_doses(complete_pop_2016_fu, 
                                                          cutpoints_2016, 
                                                          fu_type = "min",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2016_cohort_min_ct,
                              title = "ULDCT only, Minimum EAU Follow-up",
                              cohort = 2016)
```
\newpage

##### Maximum Follow-up, ULDCT
```{r}
rad_doses_2016_cohort_max_ct <- calculate_radiation_doses(complete_pop_2016_fu, 
                                                          cutpoints_2016, 
                                                          fu_type = "max",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2016_cohort_max_ct,
                              title = "ULDCT only, Maximum EAU Follow-up",
                              cohort = 2016)
```
\newpage

#### 2017
##### Minimum Follow-up, XR 
```{r}
rad_doses_2017_cohort_min_xr <- calculate_radiation_doses(complete_pop_2017_fu, 
                                                       cutpoints_2017, 
                                                       fu_type = "min",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2017_cohort_min_xr,
                              title = "XR only, Minimum EAU Follow-up",
                              cohort = 2017)
```
\newpage

##### Maximum Follow-up, XR 
```{r}
rad_doses_2017_cohort_max_xr <- calculate_radiation_doses(complete_pop_2017_fu, 
                                                       cutpoints_2017, 
                                                       fu_type = "max",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2017_cohort_max_xr,
                              title = "XR only, Maximum EAU Follow-up",
                              cohort = 2017)
```
\newpage

##### Minimum Follow-up, ULDCT
```{r}
rad_doses_2017_cohort_min_ct <- calculate_radiation_doses(complete_pop_2017_fu, 
                                                          cutpoints_2017, 
                                                          fu_type = "min",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2017_cohort_min_ct,
                              title = "ULDCT only, Minimum EAU Follow-up",
                              cohort = 2017)
```
\newpage

##### Maximum Follow-up, ULDCT
```{r}
rad_doses_2017_cohort_max_ct <- calculate_radiation_doses(complete_pop_2017_fu, 
                                                          cutpoints_2017, 
                                                          fu_type = "max",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2017_cohort_max_ct,
                              title = "ULDCT only, Maximum EAU Follow-up",
                              cohort = 2017)
```
\newpage

#### 2018
##### Minimum Follow-up, XR 
```{r}
rad_doses_2018_cohort_min_xr <- calculate_radiation_doses(complete_pop_2018_fu, 
                                                       cutpoints_2018, 
                                                       fu_type = "min",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2018_cohort_min_xr,
                              title = "XR only, Minimum EAU Follow-up",
                              cohort = 2018)
```
\newpage

##### Maximum Follow-up, XR 
```{r}
rad_doses_2018_cohort_max_xr <- calculate_radiation_doses(complete_pop_2018_fu, 
                                                       cutpoints_2018, 
                                                       fu_type = "max",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2018_cohort_max_xr,
                              title = "XR only, Maximum EAU Follow-up",
                              cohort = 2018)
```
\newpage

##### Minimum Follow-up, ULDCT
```{r}
rad_doses_2018_cohort_min_ct <- calculate_radiation_doses(complete_pop_2018_fu, 
                                                          cutpoints_2018, 
                                                          fu_type = "min",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2018_cohort_min_ct,
                              title = "ULDCT only, Minimum EAU Follow-up",
                              cohort = 2018)
```
\newpage

##### Maximum Follow-up, ULDCT
```{r}
rad_doses_2018_cohort_max_ct <- calculate_radiation_doses(complete_pop_2018_fu, 
                                                          cutpoints_2018, 
                                                          fu_type = "max",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2018_cohort_max_ct,
                              title = "ULDCT only, Maximum EAU Follow-up",
                              cohort = 2018)
```
\newpage

#### 2019
##### Minimum Follow-up, XR 
```{r}
rad_doses_2019_cohort_min_xr <- calculate_radiation_doses(complete_pop_2019_fu, 
                                                       cutpoints_2019, 
                                                       fu_type = "min",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2019_cohort_min_xr,
                              title = "XR only, Minimum EAU Follow-up",
                              cohort = 2019)
```
\newpage

##### Maximum Follow-up, XR 
```{r}
rad_doses_2019_cohort_max_xr <- calculate_radiation_doses(complete_pop_2019_fu, 
                                                       cutpoints_2019, 
                                                       fu_type = "max",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2019_cohort_max_xr,
                              title = "XR only, Maximum EAU Follow-up",
                              cohort = 2019)
```
\newpage

##### Minimum Follow-up, ULDCT
```{r}
rad_doses_2019_cohort_min_ct <- calculate_radiation_doses(complete_pop_2019_fu, 
                                                          cutpoints_2019, 
                                                          fu_type = "min",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2019_cohort_min_ct,
                              title = "ULDCT only, Minimum EAU Follow-up",
                              cohort = 2019)
```
\newpage

##### Maximum Follow-up, ULDCT
```{r}
rad_doses_2019_cohort_max_ct <- calculate_radiation_doses(complete_pop_2019_fu, 
                                                          cutpoints_2019, 
                                                          fu_type = "max",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2019_cohort_max_ct,
                              title = "ULDCT only, Maximum EAU Follow-up",
                              cohort = 2019)
```
\newpage

#### 2020
##### Minimum Follow-up, XR 
```{r}
rad_doses_2020_cohort_min_xr <- calculate_radiation_doses(complete_pop_2020_fu, 
                                                       cutpoints_2020, 
                                                       fu_type = "min",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2020_cohort_min_xr,
                              title = "XR only, Minimum EAU Follow-up",
                              cohort = 2020)
```
\newpage

##### Maximum Follow-up, XR 
```{r}
rad_doses_2020_cohort_max_xr <- calculate_radiation_doses(complete_pop_2020_fu, 
                                                       cutpoints_2020, 
                                                       fu_type = "max",
                                                       imaging_fu_type = "xr")

create_radiation_dose_barplot(rad_doses_2020_cohort_max_xr,
                              title = "XR only, Maximum EAU Follow-up",
                              cohort = 2020)
```
\newpage

##### Minimum Follow-up, ULDCT
```{r}
rad_doses_2020_cohort_min_ct <- calculate_radiation_doses(complete_pop_2020_fu, 
                                                          cutpoints_2020, 
                                                          fu_type = "min",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2020_cohort_min_ct,
                              title = "ULDCT only, Minimum EAU Follow-up",
                              cohort = 2020)
```
\newpage

##### Maximum Follow-up, ULDCT
```{r}
rad_doses_2020_cohort_max_ct <- calculate_radiation_doses(complete_pop_2020_fu, 
                                                          cutpoints_2020, 
                                                          fu_type = "max",
                                                          imaging_fu_type = "uldct")

create_radiation_dose_barplot(rad_doses_2020_cohort_max_ct,
                              title = "ULDCT only, Maximum EAU Follow-up",
                              cohort = 2020)
```
\newpage

### Radiation Dose over 5 years
#### Function to aggregate cohorts
```{r}
aggregate_radiation_cohorts <- function(auc_target = c(1,2,3,4,5,6,7,8,9)) {
  all_cohorts <- list()
  
  for (i in auc_target) {
    key <- as.integer(i)
    message("Processing AUC = ", key)
    
    message("  Loading 2016 data...")
    cohort_2016_min_xr <- rad_doses_2016_cohort_min_xr[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2016_min_ct <- rad_doses_2016_cohort_min_ct[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2016_max_xr <- rad_doses_2016_cohort_max_xr[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2016_max_ct <- rad_doses_2016_cohort_max_ct[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    
    message("  Loading 2017 data...")
    cohort_2017_min_xr <- rad_doses_2017_cohort_min_xr[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2017_min_ct <- rad_doses_2017_cohort_min_ct[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2017_max_xr <- rad_doses_2017_cohort_max_xr[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2017_max_ct <- rad_doses_2017_cohort_max_ct[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    
    message("  Loading 2018 data...")
    cohort_2018_min_xr <- rad_doses_2018_cohort_min_xr[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2018_min_ct <- rad_doses_2018_cohort_min_ct[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2018_max_xr <- rad_doses_2018_cohort_max_xr[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2018_max_ct <- rad_doses_2018_cohort_max_ct[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    
    message("  Loading 2019 data...")
    cohort_2019_min_xr <- rad_doses_2019_cohort_min_xr[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2019_min_ct <- rad_doses_2019_cohort_min_ct[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2019_max_xr <- rad_doses_2019_cohort_max_xr[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2019_max_ct <- rad_doses_2019_cohort_max_ct[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    
    message("  Loading 2020 data...")
    cohort_2020_min_xr <- rad_doses_2020_cohort_min_xr[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2020_min_ct <- rad_doses_2020_cohort_min_ct[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2020_max_xr <- rad_doses_2020_cohort_max_xr[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2020_max_ct <- rad_doses_2020_cohort_max_ct[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    
    message("  Combining cohorts for AUC = ", key)
    overall_cohort <- dplyr::bind_rows(
      cohort_2016_min_xr, cohort_2016_min_ct, cohort_2016_max_xr, cohort_2016_max_ct,
      cohort_2017_min_xr, cohort_2017_min_ct, cohort_2017_max_xr, cohort_2017_max_ct,
      cohort_2018_min_xr, cohort_2018_min_ct, cohort_2018_max_xr, cohort_2018_max_ct,
      cohort_2019_min_xr, cohort_2019_min_ct, cohort_2019_max_xr, cohort_2019_max_ct,
      cohort_2020_min_xr, cohort_2020_min_ct, cohort_2020_max_xr, cohort_2020_max_ct
    )
    
    all_cohorts[[key]] <- overall_cohort
    message(" Done with AUC = ", key, "\n")
  }
  
  message(" Binding all AUC cohorts together...")
  final_df <- dplyr::bind_rows(all_cohorts)
  message(" All done.")
  
  return(final_df)
}
```
\newpage

#### Run Aggregation function
##### AUC 0.55
```{r}
auc_0.55 <- aggregate_radiation_cohorts(auc_target = 1)
```
\newpage

##### AUC 0.6
```{r}
auc_0.6 <- aggregate_radiation_cohorts(auc_target = 2)
```
\newpage

##### AUC 0.65
```{r}
auc_0.65 <- aggregate_radiation_cohorts(auc_target = 3)
```
\newpage

##### AUC 0.7
```{r}
auc_0.7 <- aggregate_radiation_cohorts(auc_target = 4)
```
\newpage

##### AUC 0.75
```{r}
auc_0.75 <- aggregate_radiation_cohorts(auc_target = 5)
```
\newpage

##### AUC 0.8
```{r}
auc_0.8 <- aggregate_radiation_cohorts(auc_target = 6)
```
\newpage

##### AUC 0.85
```{r}
auc_0.85 <- aggregate_radiation_cohorts(auc_target = 7)
```
\newpage

##### AUC 0.9
```{r}
auc_0.9 <- aggregate_radiation_cohorts(auc_target = 8)
```
\newpage

##### AUC 0.95
```{r}
auc_0.95 <- aggregate_radiation_cohorts(auc_target = 9)
```
\newpage

#### Compare length of FU + type of imaging in terms of radiation dose
##### Combine datasets and calculate cumulative dose
```{r}
combine_auc_data <- function(data, auc_label) {
  data %>%
    mutate(
      auc_label = auc_label,
      risk_status = ifelse(risk_status == "LR", "Low Risk", "High Risk"),
      cumulative_rad_dose = rowSums(across(starts_with("rad_dose_year_")), na.rm = TRUE)
    ) %>%
    select(auc_label, cohort_type, stone_free_status, risk_status, cumulative_rad_dose, true_rec_5yr)
}
```
\newpage

#### Maximum FU
```{r}
# Combine all AUC datasets and filter cohort_types
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
) %>% filter(cohort_type %in% c("Maximum FU, XR", "Maximum FU, CT"))

data_for_plot$auc_label <- as.factor(data_for_plot$auc_label)
data_for_plot$cohort_type <- as.factor(data_for_plot$cohort_type)
data_for_plot$risk_status <- as.factor(data_for_plot$risk_status)
data_for_plot$true_rec_5yr <- as.factor(data_for_plot$true_rec_5yr)

# Summarise mean and SD by auc_label, risk_status, cohort_type
summary_df <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    .groups = "drop"
  )

# Summarise mean and SD for combined risk groups ("All")
summary_all <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(risk_status = "All") %>%
  select(auc_label, risk_status, cohort_type, mean_dose, sd)

# Combine all summaries
summary_df <- bind_rows(summary_df, summary_all)

# Factor levels for ordering
summary_df <- summary_df %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Maximum FU, XR", "Maximum FU, CT")),
    risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))
  )

# Prepare data_for_plot factors similarly
data_for_plot <- data_for_plot %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Maximum FU, XR", "Maximum FU, CT")),
    risk_status = factor(risk_status, levels = c("Low Risk", "High Risk"))
  )

# Function to run t-test comparing cohorts, optionally filtering by risk_status
run_pairwise_test <- function(df, auc_value, risk_filter = NULL) {
  df_sub <- df %>% filter(auc_label == auc_value)
  
  if (!is.null(risk_filter) && risk_filter != "All") {
    df_sub <- df_sub %>% filter(risk_status == risk_filter)
  }
  
  # If risk_filter is "All", do not filter by risk_status
  
  df_sub <- df_sub %>% filter(cohort_type %in% c("Maximum FU, XR", "Maximum FU, CT"))
  
  if(length(unique(df_sub$cohort_type)) < 2) {
    return(tibble(auc_label = auc_value, risk_status = risk_filter %||% "All",
                  group1 = "Maximum FU, XR", group2 = "Maximum FU, CT", p.value = NA))
  }
  
  test_res <- t.test(cumulative_rad_dose ~ cohort_type, data = df_sub) %>% tidy()
  
  tibble(
    auc_label = auc_value,
    risk_status = risk_filter %||% "All",
    group1 = "Maximum FU, XR",
    group2 = "Maximum FU, CT",
    p.value = test_res$p.value
  )
}

# All auc values
auc_values <- unique(data_for_plot$auc_label)

# Run tests for "All", "High Risk", and "Low Risk" groups per AUC
pvals_list <- lapply(auc_values, function(auc_val) {
  bind_rows(
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "All"),            # All combined
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "High Risk"),
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "Low Risk")
  )
})

pvals_df <- bind_rows(pvals_list) 

# Assign y.position staggered by risk_status within each auc_label
max_dose <- max(data_for_plot$cumulative_rad_dose, na.rm = TRUE)
pvals_df <- pvals_df %>%
  mutate(risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))) %>%
  group_by(auc_label) %>%
  arrange(risk_status) %>%
  mutate(
    y.position = max_dose + (row_number() - 2.2) * 0.1 * max_dose
  ) %>%
  ungroup()

# Assign xmin and xmax for pvalue brackets (always between the two cohorts)
pvals_df <- pvals_df %>%
  mutate(
    xmin = case_when(
      group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "All" ~ 0.7,
      group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "Low Risk" ~ 1,
      group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "High Risk" ~ 1.3,
      TRUE ~ NA
    ),
    xmax = case_when(group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "All" ~ 1.8,
    group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "Low Risk" ~ 2.1,
    group1 == "Maximum FU, XR" & group2 == "Maximum FU, CT" & risk_status == "High Risk" ~ 2.4,
    TRUE ~ NA),
    p.value_for_plot = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      p.value > 0.5 ~ "ns",
      TRUE ~ NA
    ),
    p.value_for_table = case_when(
      p.value < 0.001 ~ "< 0.001",
      p.value < 0.01 ~ "< 0.01",
      p.value < 0.05 ~ "< 0.05",
      p.value > 0.5 ~ "ns",
      TRUE ~ NA
    ),
    .keep = "all"
  )
```
\newpage

##### Plot
```{r}
summary_df %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = mean_dose, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(
    aes(ymin = mean_dose - sd, ymax = mean_dose + sd),
    position = position_dodge(width = 0.8),
    width = 0.2
  ) +
  stat_pvalue_manual(
    pvals_df,
    label = "p.value_for_plot",
    xmin = "xmin",
    xmax = "xmax",
    y.position = "y.position",
    tip.length = 0.02,
    bracket.shorten = 0.05
  ) +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose for Maximum EAU Follow-Up",
    x = "Cohort Type",
    y = "Mean Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  )
```
\newpage

##### Summary Table
```{r}
pvals_for_table <- pvals_df %>% subset(select = c(
  auc_label,
  risk_status,
  group1,
  group2,
  p.value_for_table
))  %>% group_by(
  auc_label) %>% pivot_wider(
    names_from = c(group1, group2),
    values_from = p.value_for_table)

summary_df$mean_dose <- round(summary_df$mean_dose, digits = 1)
summary_df$sd <- round(summary_df$sd, digits = 1)

summary_df %>%
  group_by(auc_label) %>%
  pivot_wider(
    names_from = cohort_type,
    values_from = c(mean_dose, sd)
  ) %>%
  left_join(
    pvals_for_table,
    by = c("risk_status" = "risk_status", "auc_label" = "auc_label")
  ) %>%
  rename(
    `Risk Status` = risk_status,
    mean_dose_ct = "mean_dose_Maximum FU, CT",
    mean_dose_xr = "mean_dose_Maximum FU, XR",
    sd_ct = "sd_Maximum FU, CT",
    sd_xr = "sd_Maximum FU, XR",
    "P (T-Test)" = "Maximum FU, XR_Maximum FU, CT"
  ) %>%
  gt() %>% cols_merge(
    columns = c(mean_dose_ct, sd_ct),
    pattern = "{1}{2}"
  ) %>% cols_merge(
    columns = c(mean_dose_xr, sd_xr),
    pattern = "{1}{2}"
  ) %>% cols_label(
    mean_dose_ct = "Mean Dose CT Follow-up (mSv)  SD",
    mean_dose_xr = "Mean Dose XR Follow-up (mSv)  SD"
  ) %>% tab_header(
    title = "Radiation doses over 5 years for XR or CT follow-up",
    subtitle = "Estimated for Patients with Clinically Significant Disease ascertained from HES data"
  ) %>% tab_footnote(
    footnote = "AUC's refer to modelled diagnostic accuracy of risk stratification",
    locations = cells_column_labels(columns = "Risk Status")
  ) %>% gt_theme_nytimes()
```
\newpage

#### Minimum FU
```{r}
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
) %>% filter(cohort_type %in% c("Minimum FU, XR", "Minimum FU, CT"))

data_for_plot$auc_label <- as.factor(data_for_plot$auc_label)
data_for_plot$cohort_type <- as.factor(data_for_plot$cohort_type)
data_for_plot$risk_status <- as.factor(data_for_plot$risk_status)

# Summarise mean and SD by auc_label, risk_status, cohort_type
summary_df <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type,) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    .groups = "drop"
  )

# Summarise mean and SD for combined risk groups ("All")
summary_all <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(risk_status = "All") %>%
  select(auc_label, risk_status, cohort_type, mean_dose, sd)

# Combine all summaries
summary_df <- bind_rows(summary_df, summary_all)

# Factor levels for ordering
summary_df <- summary_df %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", "Minimum FU, CT")),
    risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))
  )

# Prepare data_for_plot factors similarly
data_for_plot <- data_for_plot %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", "Minimum FU, CT")),
    risk_status = factor(risk_status, levels = c("Low Risk", "High Risk"))
  )

# Function to run t-test comparing cohorts, optionally filtering by risk_status
run_pairwise_test <- function(df, auc_value, risk_filter = NULL) {
  df_sub <- df %>% filter(auc_label == auc_value)
  
  if (!is.null(risk_filter) && risk_filter != "All") {
    df_sub <- df_sub %>% filter(risk_status == risk_filter)
  }
  
  # If risk_filter is "All", do not filter by risk_status
  
  df_sub <- df_sub %>% filter(cohort_type %in% c("Minimum FU, XR", "Minimum FU, CT"))
  
  if(length(unique(df_sub$cohort_type)) < 2) {
    return(tibble(auc_label = auc_value, risk_status = risk_filter %||% "All",
                  group1 = "Minimum FU, XR", group2 = "Minimum FU, CT", p.value = NA))
  }
  
  test_res <- t.test(cumulative_rad_dose ~ cohort_type, data = df_sub) %>% tidy()
  
  tibble(
    auc_label = auc_value,
    risk_status = risk_filter %||% "All",
    group1 = "Minimum FU, XR",
    group2 = "Minimum FU, CT",
    p.value = test_res$p.value
  )
}

# All auc values
auc_values <- unique(data_for_plot$auc_label)

# Run tests for "All", "High Risk", and "Low Risk" groups per AUC
pvals_list <- lapply(auc_values, function(auc_val) {
  bind_rows(
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "All"),            # All combined
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "High Risk"),
    run_pairwise_test(data_for_plot, auc_val, risk_filter = "Low Risk")
  )
})

pvals_df <- bind_rows(pvals_list) 

# Assign y.position staggered by risk_status within each auc_label
max_dose <- max(data_for_plot$cumulative_rad_dose, na.rm = TRUE)
pvals_df <- pvals_df %>%
  mutate(risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))) %>%
  group_by(auc_label) %>%
  arrange(risk_status) %>%
  mutate(
    y.position = max_dose + (row_number() - 2.2) * 0.1 * max_dose
  ) %>%
  ungroup()

# Assign xmin and xmax for pvalue brackets (always between the two cohorts)
pvals_df <- pvals_df %>%
  mutate(
    xmin = case_when(
      group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "All" ~ 0.7,
      group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "Low Risk" ~ 1,
      group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "High Risk" ~ 1.3,
      TRUE ~ NA
    ),
    xmax = case_when(group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "All" ~ 1.8,
                     group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "Low Risk" ~ 2.1,
                     group1 == "Minimum FU, XR" & group2 == "Minimum FU, CT" & risk_status == "High Risk" ~ 2.4,
                     TRUE ~ NA),
    p.value_for_plot = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      p.value > 0.5 ~ "ns",
      TRUE ~ NA
    ),
    p.value_for_table = case_when(
      p.value < 0.001 ~ "< 0.001",
      p.value < 0.01 ~ "< 0.01",
      p.value < 0.05 ~ "< 0.05",
      p.value > 0.5 ~ "ns",
      TRUE ~ NA
    ),
    .keep = "all"
  )
```
\newpage

##### Plot
```{r}
summary_df %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = mean_dose, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(
    aes(ymin = mean_dose - sd, ymax = mean_dose + sd),
    position = position_dodge(width = 0.8),
    width = 0.2
  ) +
  stat_pvalue_manual(
    pvals_df,
    label = "p.value_for_plot",
    xmin = "xmin",
    xmax = "xmax",
    y.position = "y.position",
    tip.length = 0.02,
    bracket.shorten = 0.05
  ) +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose for Minimum EAU FU",
    x = "Cohort Type",
    y = "Mean Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  )
```
\newpage

##### Summary table
```{r}
pvals_for_table <- pvals_df %>% subset(select = c(
  auc_label,
  risk_status,
  group1,
  group2,
  p.value_for_table
))  %>% group_by(
  auc_label) %>% pivot_wider(
    names_from = c(group1, group2),
    values_from = p.value_for_table)

summary_df$mean_dose <- round(summary_df$mean_dose, digits = 1)
summary_df$sd <- round(summary_df$sd, digits = 1)

summary_df %>%
  group_by(auc_label) %>%
  pivot_wider(
    names_from = cohort_type,
    values_from = c(mean_dose, sd)
  ) %>%
  left_join(
    pvals_for_table,
    by = c("risk_status" = "risk_status", "auc_label" = "auc_label")
  ) %>%
  rename(
    `Risk Status` = risk_status,
    mean_dose_ct = "mean_dose_Minimum FU, CT",
    mean_dose_xr = "mean_dose_Minimum FU, XR",
    sd_ct = "sd_Minimum FU, CT",
    sd_xr = "sd_Minimum FU, XR",
    "P (T-Test)" = "Minimum FU, XR_Minimum FU, CT"
  ) %>%
  gt() %>% cols_merge(
    columns = c(mean_dose_ct, sd_ct),
    pattern = "{1}{2}"
  ) %>% cols_merge(
    columns = c(mean_dose_xr, sd_xr),
    pattern = "{1}{2}"
  ) %>% cols_label(
    mean_dose_ct = "Mean Dose CT Follow-up (mSv)  SD",
    mean_dose_xr = "Mean Dose XR Follow-up (mSv)  SD"
  ) %>% tab_header(
    title = "Radiation doses over 5 years for XR or CT follow-up",
    subtitle = "Minimum Follow-up as per EAU",
  ) %>% tab_footnote(
    footnote = "AUC's refer to modelled diagnostic accuracy of risk stratification",
    locations = cells_column_labels(columns = "Risk Status")
    ) %>% tab_footnote(
      footnote = "Estimated for Patients with Clinically Significant Disease ascertained from HES data",
      locations = cells_column_labels(columns = "Risk Status")
  ) %>% gt_theme_nytimes()
```
\newpage

## Compare Radiation dose depending on Risk Stratification AUC
### Examine all patients
```{r}
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
)

summary_df2 <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    median = median(cumulative_rad_dose, na.rm = TRUE),
    lower_quartile = (quantile(cumulative_rad_dose, probs = 0.25) %>% tidy())$x,
    upper_quartile = (quantile(cumulative_rad_dose, probs = 0.75) %>% tidy())$x,
    .groups = "drop"
  )

summary_df2 %>% ggplot(aes(x = auc_label, y=mean_dose)) + 
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(
    aes(ymin = mean_dose - sd, ymax = mean_dose + sd),
    position = position_dodge(width = 0.8),
    width = 0.2
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose Regardless of Risk Stratification",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Mean Cumulative Radiation Dose (mSv)"
  ) 
```
\newpage

### Comment
No difference between AUC values within each cohort_type\
therefore the next question is what is the difference between cohort types\
Use AUC 0.55 as UKB surrogate\
Use AUC 0.6 as ROKS surrogate\

### Difference between cohort types
```{r}
data_for_plot$cohort_type <- factor(data_for_plot$cohort_type,
                                  levels= c(
                                    "Minimum FU, XR",
                                    "Maximum FU, XR",
                                    "Minimum FU, CT",
                                    "Maximum FU, CT"
                                  ))

data_for_pvals <- data_for_plot %>% filter(auc_label == "AUC 0.55")

data_for_pvals1 <- data_for_pvals %>% filter(cohort_type == "Minimum FU, XR" |
                                              cohort_type == "Maximum FU, XR")
data_for_pvals1$cohort_type <- factor(data_for_pvals1$cohort_type,
                                      levels = c("Minimum FU, XR",
                                                 "Maximum FU, XR"))

data_for_pvals2 <- data_for_pvals %>% filter(cohort_type == "Minimum FU, CT" |
                                              cohort_type == "Maximum FU, CT")
data_for_pvals2$cohort_type <- factor(data_for_pvals2$cohort_type,
                                      levels = c("Minimum FU, CT",
                                                 "Maximum FU, CT"))

data_for_pvals3 <- data_for_pvals %>% filter(cohort_type == "Minimum FU, XR" |
                                              cohort_type == "Minimum FU, CT")
data_for_pvals3$cohort_type <- factor(data_for_pvals3$cohort_type,
                                      levels = c("Minimum FU, XR",
                                                 "Minimum FU, CT"))

data_for_pvals4 <- data_for_pvals %>% filter(cohort_type == "Maximum FU, XR" |
                                              cohort_type == "Maximum FU, CT")
data_for_pvals4$cohort_type <- factor(data_for_pvals4$cohort_type,
                                      levels = c("Maximum FU, XR",
                                                 "Maximum FU, CT"))

pvals_for_overall_plot <- rbind(
  wilcox.test(cumulative_rad_dose ~ cohort_type, data = data_for_pvals1, exact = FALSE, alternative = "less") %>% tidy(),
  wilcox.test(cumulative_rad_dose ~ cohort_type, data = data_for_pvals2, exact = FALSE, alternative = "less") %>% tidy(),
  wilcox.test(cumulative_rad_dose ~ cohort_type, data = data_for_pvals3, exact = FALSE, alternative = "less") %>% tidy(),
  wilcox.test(cumulative_rad_dose ~ cohort_type, data = data_for_pvals4, exact = FALSE, alternative = "less") %>% tidy()
) %>% cbind(
  "group1" = c("Minimum FU, XR",
                   "Minimum FU, CT",
                   "Minimum FU, XR",
                   "Maximum FU, XR"),
  "group2" = c("Maximum FU, XR",
               "Maximum FU, CT",
               "Minimum FU, CT",
               "Maximum FU, CT"),
  "xmin" = c(1, 3, 1, 2),
  "xmax" = c(2, 4, 3, 4),
  "y.position" = c(30, 30, 32, 34)
) %>% mutate(
  p.value_for_plot = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    p.value > 0.5 ~ "ns",
    TRUE ~ NA
  )
)
```
\newpage

#### Plot
```{r}
data_for_plot %>% ggplot(aes(x = cohort_type, y=cumulative_rad_dose)) + geom_boxplot(
  fill = "slateblue", alpha=0.2
) +
  labs(
    title = "Cumulative 5 Year Radiation Dose Regardless of Risk Stratification",
    x = "Follow-up Length and Type of Imaging",
    y = "Median Cumulative Radiation Dose (mSv)"
  ) + stat_pvalue_manual(
    pvals_for_overall_plot,
    label = "p.value_for_plot",
    xmin = "xmin",
    xmax = "xmax",
    y.position = "y.position",
    tip.length = 0.02,
    bracket.shorten = 0.05,
    bracket.size = 0.7
  ) 
```
\newpage

#### Plot
```{r}
summary_df3 <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type,) %>%
  summarise(
    mean_dose = mean(cumulative_rad_dose, na.rm = TRUE),
    sd = sd(cumulative_rad_dose, na.rm = TRUE),
    median_dose = median(cumulative_rad_dose, na.rm = TRUE),
    .groups = "drop"
  )

summary_df3 %>% ggplot(aes(x = auc_label, y=mean_dose, fill = risk_status)) + 
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(
    aes(ymin = mean_dose - sd, ymax = mean_dose + sd),
    position = position_dodge(width = 0.8),
    width = 0.2
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Mean Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 
```
\newpage

#### Plot
```{r}
summary_df3 %>% ggplot(aes(x = auc_label, y=median_dose, fill = risk_status)) + 
  geom_col(position = position_dodge(width = 0.8), width = 0.7)  +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Median Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 
```
\newpage

#### Plot
```{r}
data_for_plot %>% ggplot(aes(x = auc_label, y=cumulative_rad_dose, fill = risk_status)) + 
  geom_boxplot(position = position_dodge(width = 0.8)) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 

```
\newpage

## Radiation Induced Malignancy
```{r}
source("~/Desktop/Sayer/Economics/Markov Modelling KSD/Radiation associated malignancy_1.R")
```
\newpage

### Overall plot
```{r}
malignancy_risk_plot
```
\newpage

### Organ Specific plot
```{r}
malignancy_data_grouped$auc <- as.factor(malignancy_data_grouped$auc)
organ_specific_ear_per_person <- malignancy_data_grouped %>%
  group_by(auc, age, sex, cohort_type, risk_status, organ) %>%
  summarise(
    five_year_ear      = sum(five_year_risk, na.rm = TRUE),
    ten_year_ear       = sum(ten_year_risk, na.rm = TRUE),
    fifteen_year_ear   = sum(fifteen_year_risk, na.rm = TRUE),
    twenty_year_ear    = sum(twenty_year_risk, na.rm = TRUE),
    twentyfive_year_ear = sum(twenty_five_year_risk, na.rm = TRUE),
    thirty_year_ear    = sum(thirty_year_risk, na.rm = TRUE),
    .groups = "drop"
  )

organ_specific_ear_per_person$organ <- as.factor(organ_specific_ear_per_person$organ)

organ_specific_ear_per_person_long <- organ_specific_ear_per_person %>%
  group_by(organ) %>%
  pivot_longer(
    cols = c(
      five_year_ear,
      ten_year_ear,
      fifteen_year_ear,
      twenty_year_ear,
      twentyfive_year_ear,
      thirty_year_ear
    ),
    names_to = "follow_up",
    values_to = "ear"
  )  %>%
  mutate(
    ear_per_1000 = case_when(
      sex == "male" ~ (ear / cohort_size_male) * 1000,
      sex == "female" ~ (ear / cohort_size_female) * 1000,
      TRUE ~ NA_integer_
    ),
    
    follow_up = recode(
      follow_up,
      "five_year_ear"        = "5",
      "ten_year_ear"         = "10",
      "fifteen_year_ear"     = "15",
      "twenty_year_ear"      = "20",
      "twentyfive_year_ear"  = "25",
      "thirty_year_ear"      = "30"
    ),
    yrs_after_first_scan = factor(follow_up, levels = c("5", "10", "15", "20", "25", "30")),
    organ = recode(
      organ,
      "bladder" = "Bladder",
      "colon" = "Colon",
      "kidney" = "Kidney",
      "liver" = "Liver",
      "ovary" = "Ovary",
      "pancreas" = "Pancreas",
      "prostate" = "Prostate",
      "rectum" = "Rectum",
      "stomach" = "Stomach",
      "uterus" = "Uterus"
    ),
    organ = factor(
      organ,
      levels = c(
        "Stomach",
        "Bladder",
        "Liver",
        "Colon",
        "Uterus",
        "Ovary",
        "Pancreas",
        "Rectum",
        "Kidney",
        "Prostate"
      )
    )
  )


ggplot(
  organ_specific_ear_per_person_long,
  aes(x = yrs_after_first_scan, y = ear_per_1000, fill = auc)
) +
  geom_col(position = position_dodge(width = 0.8)) +
  facet_grid(cohort_type ~ organ, scales = "free_y") +
  labs(title = "Estimated Excess Absolute Solid Cancer Incidence by Individual Exposed Organ", x = "Time from 1st Imaging (years)", y = "Estimated Excess Absolute Solid Cancer Incidence, n per 1000") +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "right",
    strip.text = element_text(face = "bold")
  ) + ylim(c(0, 11))
```
\newpage

### Lifetime Expected Additional Malignancies Table
```{r}
malignancy_grand_total %>%
  group_by(cohort_type,
           risk_status,
           auc_target) %>%
  gt() %>%
  fmt_number(
    columns = grand_total_expected_malignancies,
    decimals = 0
  ) %>%
  fmt_number(
    columns = grand_total_expected_malignancies_lower,
    decimals = 0
  ) %>%
  fmt_number(
    columns = grand_total_expected_malignancies_upper,
    decimals = 0
  ) %>%
  fmt_number(
    columns = total_patients,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  cols_label(
    auc_target = "AUC Target",
    cohort_type = "Cohort Type",
    risk_status = "Risk Status",
    grand_total_expected_malignancies = "Expected Lifetime Malignancies",
    grand_total_expected_malignancies_lower = "Lower CI",
    grand_total_expected_malignancies_upper = "Upper CI",
    total_patients = "Total Patients"
  )
```
\newpage

### Plot Lifetime expected malignancies - Cohort comparisons
```{r}
malignancy_plot_data <- malignancy_grand_total %>%
  mutate(
    percentage = (grand_total_expected_malignancies / total_patients) * 100,
    percentage_lower = (grand_total_expected_malignancies_lower / total_patients) * 100,
    percentage_upper = (grand_total_expected_malignancies_upper / total_patients) * 100
  )

comparisons <- list(
  c("Maximum FU, CT", "Maximum FU, XR"),
  c("Minimum FU, CT", "Minimum FU, XR"),
  c("Maximum FU, CT", "Minimum FU, CT"),
  c("Maximum FU, XR", "Minimum FU, XR")
)

calc_chisq_pvalue <- function(data, group1, group2) {
  d1 <- data %>% filter(cohort_type == group1)
  d2 <- data %>% filter(cohort_type == group2)
  
  if(nrow(d1) == 0 || nrow(d2) == 0) return(1)
  
  mat <- matrix(
    c(d1$grand_total_expected_malignancies, 
      d1$total_patients - d1$grand_total_expected_malignancies,
      d2$grand_total_expected_malignancies,
      d2$total_patients - d2$grand_total_expected_malignancies),
    nrow = 2,
    byrow = TRUE
  )
  
  tryCatch({
    chisq.test(mat)$p.value
  }, error = function(e) 1)
}

ggplot(malignancy_plot_data, 
       aes(x = cohort_type, 
           y = percentage,
           fill = cohort_type)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = percentage_lower, 
                    ymax = percentage_upper),
                width = 0.2) +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      # Get the current facet's data
      current_data <- malignancy_plot_data %>%
        filter(cohort_type %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) +
  facet_grid(risk_status ~ auc_target,
             labeller = labeller(
               auc_target = function(x) paste0("AUC: ", x),
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by AUC Target and Risk Status",
    x = "Cohort Type",
    y = "Expected Additional Lifetime Malignancies (%)",
    fill = "Cohort Type",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                     expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )
```
\newpage

### Plot Lifetime expected malignancies - AUC comparisons - Proportions
```{r}
# Get unique AUC target values for comparisons
auc_values <- unique(as.factor(malignancy_plot_data$auc_target))

ref_auc <- "0.55"

# Define pairwise comparisons for AUC targets
comparisons <- lapply(setdiff(auc_values, ref_auc), function(x) c(ref_auc, x))

# Updated function to compare by auc_target instead of cohort_type
calc_chisq_pvalue <- function(data, group1, group2) {
  d1 <- data %>% filter(auc_target == group1)
  d2 <- data %>% filter(auc_target == group2)
  
  if(nrow(d1) == 0 || nrow(d2) == 0) return(1)
  
  mat <- matrix(
    c(d1$grand_total_expected_malignancies, 
      d1$total_patients - d1$grand_total_expected_malignancies,
      d2$grand_total_expected_malignancies,
      d2$total_patients - d2$grand_total_expected_malignancies),
    nrow = 2,
    byrow = TRUE
  )
  
  tryCatch({
    chisq.test(mat)$p.value
  }, error = function(e) 1)
}

ggplot(malignancy_plot_data, 
       aes(x = as.factor(auc_target), 
           y = percentage,
           fill = auc_target)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = percentage_lower, 
                    ymax = percentage_upper),
                width = 0.2) +
  facet_grid(risk_status ~ cohort_type,
             labeller = labeller(
               cohort_type = function(x) x,
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by Cohort Type and Risk Status",
    x = "AUC Target",
    y = "Expected Additional Lifetime Malignancies (%)",
    fill = "AUC Target",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                     expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )  +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      current_data <- malignancy_plot_data %>%
        filter(auc_target %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) 
```
\newpage

### Plot Lifetime expected malignancies - AUC comparisons - Numbers
```{r}
ggplot(malignancy_plot_data, 
       aes(x = as.factor(auc_target), 
           y = grand_total_expected_malignancies,
           fill = auc_target)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = grand_total_expected_malignancies_lower, 
                    ymax = grand_total_expected_malignancies_upper),
                width = 0.2) +
  facet_grid(risk_status ~ cohort_type,
             labeller = labeller(
               cohort_type = function(x) x,
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by Cohort Type and Risk Status",
    x = "AUC Target",
    y = "Expected Additional Lifetime Malignancies, n",
    fill = "AUC Target",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )  +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      current_data <- malignancy_plot_data %>%
        filter(auc_target %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) 
```
\newpage

## Economic Costs
### Budget Impact Analysis - Economic cost calculation function
```{r}
calculate_economic_costs <- function(complete_pop_yr_fu,
                                     cutpoints_yr,
                                     year = 2016,
                                     auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                     fu_type = c("min", "max"),
                                     post_op_imaging = c("none", ct_cost, imaging_cost, us_cost),
                                     imaging_fu_type = c("ct", "xr", "xr_us"),
                                     xr_sens = 0.67, xr_spec = 0.98,
                                     us_sens = 0.54, us_spec = 0.91) {
  
  
  # Initialize list to store results for each AUC target
  results_list <- list()
  
  # Define post-operative imaging
  post_op_imaging <- ifelse(post_op_imaging == "none",
                            0,
                            post_op_imaging)
  
  if (imaging_fu_type == "xr" | imaging_fu_type == "ct") {
  # Assign follow-up costs
  fu_costs_1 <- fu_costs %>% filter(imaging_type == !!imaging_fu_type)
  
  year_1_lr_sf_fu_cost_xr <- fu_costs_1$cost[1] %>% as.integer()
  year_2_lr_sf_fu_cost_xr <- fu_costs_1$cost[2] %>% as.integer()
  year_3_lr_sf_fu_cost_xr <- fu_costs_1$cost[3] %>% as.integer()
  year_4_lr_sf_fu_cost_xr <- fu_costs_1$cost[4] %>% as.integer()
  year_5_lr_sf_fu_cost_xr  <- fu_costs_1$cost[5] %>% as.integer()
  year_1_lr_less4_fu_cost_xr <- fu_costs_1$cost[6] %>% as.integer()
  year_2_lr_less4_fu_cost_xr <- fu_costs_1$cost[7] %>% as.integer()
  year_3_lr_less4_fu_cost_xr <- fu_costs_1$cost[8] %>% as.integer()
  year_4_lr_less4_fu_cost_xr <- fu_costs_1$cost[9] %>% as.integer()
  year_5_lr_less4_fu_cost_xr <- fu_costs_1$cost[10] %>% as.integer()
  year_1_lr_more4_fu_cost_xr <- fu_costs_1$cost[11] %>% as.integer()
  year_2_lr_more4_fu_cost_xr <- fu_costs_1$cost[12] %>% as.integer()
  year_3_lr_more4_fu_cost_xr <- fu_costs_1$cost[13] %>% as.integer()
  year_4_lr_more4_fu_cost_xr <- fu_costs_1$cost[14] %>% as.integer()
  year_5_lr_more4_fu_cost_xr <- fu_costs_1$cost[15] %>% as.integer()
  year_1_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[16] %>% as.integer()
  year_1_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[17] %>% as.integer()
  year_2_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[18] %>% as.integer()
  year_2_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[19] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[20] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[21] %>% as.integer()
  year_3_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[22] %>% as.integer()
  year_3_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[23] %>% as.integer()
  year_4_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[24] %>% as.integer()
  year_5_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[25] %>% as.integer()
  year_1_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[26] %>% as.integer()
  year_2_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[27] %>% as.integer()
  year_3_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[28] %>% as.integer()
  year_4_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[29] %>% as.integer()
  year_5_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[30] %>% as.integer()
  year_1_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[31] %>% as.integer()
  year_2_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[32] %>% as.integer()
  year_3_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[33] %>% as.integer()
  year_4_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[34] %>% as.integer()
  year_5_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[35] %>% as.integer()
  
  year_1_lr_sf_fu_cost_us <- fu_costs_1$cost[1] %>% as.integer()
  year_2_lr_sf_fu_cost_us <- fu_costs_1$cost[2] %>% as.integer()
  year_3_lr_sf_fu_cost_us <- fu_costs_1$cost[3] %>% as.integer()
  year_4_lr_sf_fu_cost_us <- fu_costs_1$cost[4] %>% as.integer()
  year_5_lr_sf_fu_cost_us  <- fu_costs_1$cost[5] %>% as.integer()
  year_1_lr_less4_fu_cost_us <- fu_costs_1$cost[6] %>% as.integer()
  year_2_lr_less4_fu_cost_us <- fu_costs_1$cost[7] %>% as.integer()
  year_3_lr_less4_fu_cost_us <- fu_costs_1$cost[8] %>% as.integer()
  year_4_lr_less4_fu_cost_us <- fu_costs_1$cost[9] %>% as.integer()
  year_5_lr_less4_fu_cost_us <- fu_costs_1$cost[10] %>% as.integer()
  year_1_lr_more4_fu_cost_us <- fu_costs_1$cost[11] %>% as.integer()
  year_2_lr_more4_fu_cost_us <- fu_costs_1$cost[12] %>% as.integer()
  year_3_lr_more4_fu_cost_us <- fu_costs_1$cost[13] %>% as.integer()
  year_4_lr_more4_fu_cost_us <- fu_costs_1$cost[14] %>% as.integer()
  year_5_lr_more4_fu_cost_us <- fu_costs_1$cost[15] %>% as.integer()
  year_1_hr_sf_fu_cost_us_current <- fu_costs_1$cost[16] %>% as.integer()
  year_1_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[17] %>% as.integer()
  year_2_hr_sf_fu_cost_us_current <- fu_costs_1$cost[18] %>% as.integer()
  year_2_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[19] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_us_current <- fu_costs_1$cost[20] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[21] %>% as.integer()
  year_3_hr_sf_fu_cost_us_current <- fu_costs_1$cost[22] %>% as.integer()
  year_3_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[23] %>% as.integer()
  year_4_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[24] %>% as.integer()
  year_5_hr_sf_fu_cost_us_eau <- fu_costs_1$cost[25] %>% as.integer()
  year_1_hr_less4_fu_cost_us_eau <- fu_costs_1$cost[26] %>% as.integer()
  year_2_hr_less4_fu_cost_us_eau <- fu_costs_1$cost[27] %>% as.integer()
  year_3_hr_less4_fu_cost_us_eau <- fu_costs_1$cost[28] %>% as.integer()
  year_4_hr_less4_fu_cost_us_eau <- fu_costs_1$cost[29] %>% as.integer()
  year_5_hr_less4_fu_cost_us_eau <- fu_costs_1$cost[30] %>% as.integer()
  year_1_hr_more4_fu_cost_us_eau <- fu_costs_1$cost[31] %>% as.integer()
  year_2_hr_more4_fu_cost_us_eau <- fu_costs_1$cost[32] %>% as.integer()
  year_3_hr_more4_fu_cost_us_eau <- fu_costs_1$cost[33] %>% as.integer()
  year_4_hr_more4_fu_cost_us_eau <- fu_costs_1$cost[34] %>% as.integer()
  year_5_hr_more4_fu_cost_us_eau <- fu_costs_1$cost[35] %>% as.integer()
  
  }
  else {
    # Assign follow-up costs
  fu_costs_1 <- fu_costs %>% filter(imaging_type == "xr")
  
  year_1_lr_sf_fu_cost_xr <- fu_costs_1$cost[1] %>% as.integer()
  year_2_lr_sf_fu_cost_xr <- fu_costs_1$cost[2] %>% as.integer()
  year_3_lr_sf_fu_cost_xr <- fu_costs_1$cost[3] %>% as.integer()
  year_4_lr_sf_fu_cost_xr <- fu_costs_1$cost[4] %>% as.integer()
  year_5_lr_sf_fu_cost_xr  <- fu_costs_1$cost[5] %>% as.integer()
  year_1_lr_less4_fu_cost_xr <- fu_costs_1$cost[6] %>% as.integer()
  year_2_lr_less4_fu_cost_xr <- fu_costs_1$cost[7] %>% as.integer()
  year_3_lr_less4_fu_cost_xr <- fu_costs_1$cost[8] %>% as.integer()
  year_4_lr_less4_fu_cost_xr <- fu_costs_1$cost[9] %>% as.integer()
  year_5_lr_less4_fu_cost_xr <- fu_costs_1$cost[10] %>% as.integer()
  year_1_lr_more4_fu_cost_xr <- fu_costs_1$cost[11] %>% as.integer()
  year_2_lr_more4_fu_cost_xr <- fu_costs_1$cost[12] %>% as.integer()
  year_3_lr_more4_fu_cost_xr <- fu_costs_1$cost[13] %>% as.integer()
  year_4_lr_more4_fu_cost_xr <- fu_costs_1$cost[14] %>% as.integer()
  year_5_lr_more4_fu_cost_xr <- fu_costs_1$cost[15] %>% as.integer()
  year_1_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[16] %>% as.integer()
  year_1_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[17] %>% as.integer()
  year_2_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[18] %>% as.integer()
  year_2_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[19] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[20] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[21] %>% as.integer()
  year_3_hr_sf_fu_cost_xr_current <- fu_costs_1$cost[22] %>% as.integer()
  year_3_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[23] %>% as.integer()
  year_4_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[24] %>% as.integer()
  year_5_hr_sf_fu_cost_xr_eau <- fu_costs_1$cost[25] %>% as.integer()
  year_1_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[26] %>% as.integer()
  year_2_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[27] %>% as.integer()
  year_3_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[28] %>% as.integer()
  year_4_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[29] %>% as.integer()
  year_5_hr_less4_fu_cost_xr_eau <- fu_costs_1$cost[30] %>% as.integer()
  year_1_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[31] %>% as.integer()
  year_2_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[32] %>% as.integer()
  year_3_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[33] %>% as.integer()
  year_4_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[34] %>% as.integer()
  year_5_hr_more4_fu_cost_xr_eau <- fu_costs_1$cost[35] %>% as.integer()
  
  
  fu_costs_2 <- fu_costs %>% filter(imaging_type == "xr_us")
  year_1_lr_sf_fu_cost_us <- fu_costs_2$cost[1] %>% as.integer()
  year_2_lr_sf_fu_cost_us <- fu_costs_2$cost[2] %>% as.integer()
  year_3_lr_sf_fu_cost_us <- fu_costs_2$cost[3] %>% as.integer()
  year_4_lr_sf_fu_cost_us <- fu_costs_2$cost[4] %>% as.integer()
  year_5_lr_sf_fu_cost_us  <- fu_costs_2$cost[5] %>% as.integer()
  year_1_lr_less4_fu_cost_us <- fu_costs_2$cost[6] %>% as.integer()
  year_2_lr_less4_fu_cost_us <- fu_costs_2$cost[7] %>% as.integer()
  year_3_lr_less4_fu_cost_us <- fu_costs_2$cost[8] %>% as.integer()
  year_4_lr_less4_fu_cost_us <- fu_costs_2$cost[9] %>% as.integer()
  year_5_lr_less4_fu_cost_us <- fu_costs_2$cost[10] %>% as.integer()
  year_1_lr_more4_fu_cost_us <- fu_costs_2$cost[11] %>% as.integer()
  year_2_lr_more4_fu_cost_us <- fu_costs_2$cost[12] %>% as.integer()
  year_3_lr_more4_fu_cost_us <- fu_costs_2$cost[13] %>% as.integer()
  year_4_lr_more4_fu_cost_us <- fu_costs_2$cost[14] %>% as.integer()
  year_5_lr_more4_fu_cost_us <- fu_costs_2$cost[15] %>% as.integer()
  year_1_hr_sf_fu_cost_us_current <- fu_costs_2$cost[16] %>% as.integer()
  year_1_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[17] %>% as.integer()
  year_2_hr_sf_fu_cost_us_current <- fu_costs_2$cost[18] %>% as.integer()
  year_2_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[19] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_us_current <- fu_costs_2$cost[20] %>% as.integer()
  year_3_onwards_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[21] %>% as.integer()
  year_3_hr_sf_fu_cost_us_current <- fu_costs_2$cost[22] %>% as.integer()
  year_3_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[23] %>% as.integer()
  year_4_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[24] %>% as.integer()
  year_5_hr_sf_fu_cost_us_eau <- fu_costs_2$cost[25] %>% as.integer()
  year_1_hr_less4_fu_cost_us_eau <- fu_costs_2$cost[26] %>% as.integer()
  year_2_hr_less4_fu_cost_us_eau <- fu_costs_2$cost[27] %>% as.integer()
  year_3_hr_less4_fu_cost_us_eau <- fu_costs_2$cost[28] %>% as.integer()
  year_4_hr_less4_fu_cost_us_eau <- fu_costs_2$cost[29] %>% as.integer()
  year_5_hr_less4_fu_cost_us_eau <- fu_costs_2$cost[30] %>% as.integer()
  year_1_hr_more4_fu_cost_us_eau <- fu_costs_2$cost[31] %>% as.integer()
  year_2_hr_more4_fu_cost_us_eau <- fu_costs_2$cost[32] %>% as.integer()
  year_3_hr_more4_fu_cost_us_eau <- fu_costs_2$cost[33] %>% as.integer()
  year_4_hr_more4_fu_cost_us_eau <- fu_costs_2$cost[34] %>% as.integer()
  year_5_hr_more4_fu_cost_us_eau <- fu_costs_2$cost[35] %>% as.integer()
  }
  
  # Assign recurrence costs
  rec_cost_colic <- ifelse(imaging_fu_type == "ct",
                           rec_cost_colic,
                           rec_cost_colic + imaging_cost)
  rec_cost_eswl <- ifelse(imaging_fu_type == "ct",
                          rec_cost_eswl,
                          rec_cost_eswl + imaging_cost)
  rec_cost_urs <- ifelse(imaging_fu_type == "ct",
                         rec_cost_urs,
                         rec_cost_urs + imaging_cost)
  rec_cost_pcnl <- ifelse(imaging_fu_type == "ct",
                          rec_cost_pcnl,
                          rec_cost_pcnl + imaging_cost)
  
  for (auc_target in auc_targets) {
    message("Calculating costs for: ", year, ", AUC: ", auc_target, ", Follow-up Type: ", fu_type, ", Follow-up Imaging: ", imaging_fu_type, " and Post-Operative Imaging:", post_op_imaging)
    # Get cutpoint for current AUC target
    cutpoint <- (cutpoints_yr %>% filter(auc_target == !!auc_target))$cutpoint
    
    not_sf_props <- complete_pop_yr_fu %>%
      filter(stone_free_status %in% c("less4", "more4")) %>%
      count(stone_free_status) %>%
      mutate(prop = n / sum(n)) %>%
      select(stone_free_status, prop)
    
    less4_prob <- not_sf_props$prop[not_sf_props$stone_free_status == "less4"]
    
    # Distribute SF status as determined by imaging
    if (imaging_fu_type == "xr") {
      ct_cost <- ct_cost + imaging_cost
      
      # Generate random numbers once
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= xr_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > xr_sens ~ "SF", # FIXED: uppercase
            stone_free_status_original == "sf" & rand_spec <= xr_spec ~ "SF", # FIXED: uppercase
            stone_free_status_original == "sf" & rand_spec > xr_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original # Handle any other cases
          ),
          lucency = case_when(rand_sens > 0.8 ~ "lucent",
                    TRUE ~ "opaque"),
          .keep = "all"
        )
    } else if (imaging_fu_type == "xr_us") {
      ct_cost <- ct_cost + imaging_cost
      
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= us_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > us_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= us_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > us_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original
          ),
          lucency = case_when(rand_sens > 0.8 ~ "lucent",
                    TRUE ~ "opaque"),
          .keep = "all"
        )
    } else {
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      # For CT imaging, no sensitivity/specificity adjustment needed
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = stone_free_status,
          lucency = case_when(rand_sens > 0.8 ~ "lucent",
                    TRUE ~ "opaque"),
          .keep = "all"
        )
      
      ct_cost <- ct_cost
    }
    
    # SF patients with minimum follow-up strategy
    if (fu_type == "min") {
      xr_only_fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          cost_year_0 = case_when(
            # Cost of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          cost_year_1 = case_when(
            # Yr 1 FU divided by risk status - radio-opaque
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 1 FU divided by risk status - radio-lucent
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence - radio-opaque
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
            TRUE ~ NA_real_
          ),
          
          cost_year_2 = case_when(
            # Yr 2 FU divided by risk status - radio-opaque
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU divided by risk status - lucent
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            # Death
            death_year_2 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 1 - opaque
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 1 FU for Recurrence in Yr 1 - lucent
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_3 = case_when(
            # Yr 3 FU divided by risk status - opaque
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU divided by risk status - lucent
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_xr_eau,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 2 - opaque
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR"  & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 1 - opaque
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR"  & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR"  & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 1 FU for Recurrence in Yr 2 - lucent
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 1 - lucent
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_4 = case_when(
            # Yr 4 FU divided by risk status - opaque
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "opaque" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_sf_fu_cost_xr_eau,
            # Yr 4 FU divided by risk status - lucent
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "lucent" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_sf_fu_cost_us_eau,
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 3 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR"  & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR"  & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 2 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR"  & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU for Recurrence in Yr 1 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
            
            # Yr 1 FU for Recurrence in Yr 3 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR"  & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR"  & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 2 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR"  & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            # Yr 3 FU for Recurrence in Yr 1 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_5 = case_when(
            # Yr 5 FU divided by risk status - opaque
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "opaque" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_5_hr_sf_fu_cost_xr_eau,
            # Yr 5 FU divided by risk status - lucent
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR"  & lucency == "lucent" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR"  & lucency == "lucent" ~ year_5_hr_sf_fu_cost_us_eau,
            # Death
            death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 4 - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 3  - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU for Recurrence in Yr 2  - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
            # Yr 4 FU for Recurrence in Yr 1  - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_sf_fu_cost_xr_eau,
            
             # Yr 1 FU for Recurrence in Yr 4 - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 3  - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            # Yr 3 FU for Recurrence in Yr 2  - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
            # Yr 4 FU for Recurrence in Yr 1  - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          )
        )
    } else {
      # SF patients with maximum follow-up strategy
      xr_only_fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          cost_year_0 = case_when(
            # Cost of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          
          cost_year_1 = case_when(
            # Yr 1 FU divided by risk status - opaque
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 1 FU divided by risk status - lucent
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
            TRUE ~ NA_real_
          ),
          
          cost_year_2 = case_when(
            # Yr 2 FU divided by risk status - opaque
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU divided by risk status - lucent
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            # Death
            death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 1 - opaque
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            
            # Yr 1 FU for Recurrence in Yr 1 - lucent
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_3 = case_when(
            # Yr 3 FU divided by risk status - opaque
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU divided by risk status - lucent
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 2 - opaque
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 1 - opaque
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr_us,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            
            # Yr 1 FU for Recurrence in Yr 2 - lucent
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 1 - lucent
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_4 = case_when(
            # Yr 4 FU divided by risk status - opaque
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "opaque" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_sf_fu_cost_xr_eau,
            # Yr 4 FU divided by risk status - lucent
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "lucent" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_sf_fu_cost_us_eau,
            
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 3 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque"  ~ year_1_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque"  ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 2 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque"  ~ year_2_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque"  ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU for Recurrence in Yr 1 - opaque
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque"  ~ year_3_lr_sf_fu_cost_xr,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque"  ~ year_3_hr_sf_fu_cost_xr_eau,
            
            # Yr 1 FU for Recurrence in Yr 3 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent"  ~ year_1_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent"  ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 2 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent"  ~ year_2_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent"  ~ year_2_hr_sf_fu_cost_us_eau,
            # Yr 3 FU for Recurrence in Yr 1 - lucent
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent"  ~ year_3_lr_sf_fu_cost_us,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent"  ~ year_3_hr_sf_fu_cost_us_eau,
            
            TRUE ~ NA_real_
          ),
          
          cost_year_5 = case_when(
            # Yr 5 FU divided by risk status - opaque
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_5_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_5_hr_sf_fu_cost_xr_eau,
             # Yr 5 FU divided by risk status - lucent
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_5_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_5_hr_sf_fu_cost_us_eau,
            # Death
            death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            
            # Yr 1 FU for Recurrence in Yr 4 - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_sf_fu_cost_xr_eau,
            # Yr 2 FU for Recurrence in Yr 3 - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_sf_fu_cost_xr_eau,
            # Yr 3 FU for Recurrence in Yr 2 - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
            # Yr 4 FU for Recurrence in Yr 1 - opaque
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_4_lr_sf_fu_cost_xr,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_sf_fu_cost_xr_eau,
            
            # Yr 1 FU for Recurrence in Yr 4 - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_sf_fu_cost_us_eau,
            # Yr 2 FU for Recurrence in Yr 3 - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_sf_fu_cost_us_eau,
            # Yr 3 FU for Recurrence in Yr 2 - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
            # Yr 4 FU for Recurrence in Yr 1 - lucent
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_4_lr_sf_fu_cost_us,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_sf_fu_cost_us_eau,
            
            TRUE ~ NA_real_
          )
        )
    }
    
    # Less than 4mm stones
    xr_only_fu_less4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "less4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        cost_year_0 = case_when(
          # Cost of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        cost_year_1 = case_when(
          # Yr 1 FU divided by risk status - opaque
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_less4_fu_cost_xr,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_less4_fu_cost_xr_eau,
          # Yr 1 FU divided by risk status - lucent
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_less4_fu_cost_us,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_less4_fu_cost_us_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
          TRUE ~ NA_real_
        ),
        
        cost_year_2 = case_when(
          # Yr 2 FU divided by risk status - opaque
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_less4_fu_cost_xr,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_less4_fu_cost_xr_eau,
          # Yr 2 FU divided by risk status - lucent
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_less4_fu_cost_us,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_less4_fu_cost_us_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 1 - opaque
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_less4_fu_cost_xr,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_less4_fu_cost_xr_eau,
          # Yr 1 FU for Recurrence in Yr 1 - lucent
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_less4_fu_cost_us,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_less4_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        ),
        
        cost_year_3 = case_when(
          # Yr 3 FU divided by risk status - opaque
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_less4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_less4_fu_cost_xr_eau,
          # Yr 3 FU divided by risk status - lucent
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_less4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_less4_fu_cost_us_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 2 - opaque
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_less4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_less4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 1 - opaque
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_less4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_less4_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 2 - lucent
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_less4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_less4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 1 - lucent
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_less4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_less4_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        ),
        
        cost_year_4 = case_when(
          # Yr 4 FU divided by risk status - opaque
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "opaque" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "opaque"~ year_4_hr_less4_fu_cost_xr_eau,
          # Yr 4 FU divided by risk status - lucent
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR"  & lucency == "lucent" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR"  & lucency == "lucent" ~ year_4_hr_less4_fu_cost_us_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 3 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_less4_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_less4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 2 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_less4_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_less4_fu_cost_xr_eau,
          # Yr 3 FU for Recurrence in Yr 1 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 3 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_less4_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_less4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 2 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_less4_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_less4_fu_cost_us_eau,
          # Yr 3 FU for Recurrence in Yr 1 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        ),
        
        cost_year_5 = case_when(
          # Yr 5 FU divided by risk status - opaque
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_5_lr_less4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_5_hr_less4_fu_cost_xr_eau,
           # Yr 5 FU divided by risk status - lucent
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "lucent"  ~ year_5_lr_less4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "lucent"  ~ year_5_hr_less4_fu_cost_us_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 4 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_less4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_less4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 3 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_less4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_less4_fu_cost_xr_eau,
          # Yr 3 FU for Recurrence in Yr 2 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_less4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_less4_fu_cost_xr_eau,
          # Yr 4 FU for Recurrence in Yr 1 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_4_lr_less4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_less4_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 4 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_less4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_less4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 3 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_less4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_less4_fu_cost_us_eau,
          # Yr 3 FU for Recurrence in Yr 2 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_less4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_less4_fu_cost_us_eau,
          # Yr 4 FU for Recurrence in Yr 1 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_4_lr_less4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_less4_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        )
      )
    
    # More than 4mm stones
    xr_only_fu_more4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "more4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        cost_year_0 = case_when(
          # Cost of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        cost_year_1 = case_when(
          # Yr 1 FU divided by risk status - opaque
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_more4_fu_cost_xr,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_more4_fu_cost_xr_eau,
          # Yr 1 FU divided by risk status - lucent
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_more4_fu_cost_us,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_more4_fu_cost_us_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
          TRUE ~ NA_real_
        ),
        
        cost_year_2 = case_when(
          # Yr 2 FU divided by risk status - opaque
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_more4_fu_cost_xr,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_more4_fu_cost_xr_eau,
          # Yr 2 FU divided by risk status - lucent
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_more4_fu_cost_us,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_more4_fu_cost_us_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 1 - opaque
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_more4_fu_cost_xr,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_more4_fu_cost_xr_eau,
          # Yr 1 FU for Recurrence in Yr 1 - lucent
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_more4_fu_cost_us,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_more4_fu_cost_us_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_3 = case_when(
          # Yr 3 FU divided by risk status - opaque
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_more4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_more4_fu_cost_xr_eau,
          # Yr 3 FU divided by risk status - lucent
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_more4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_more4_fu_cost_us_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 2 - opaque
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_more4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_more4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 1 - opaque
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_more4_fu_cost_xr,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_more4_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 2 - lucent
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_more4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_more4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 1 - lucent
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_more4_fu_cost_us,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_more4_fu_cost_us_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_4 = case_when(
          # Yr 4 FU divided by risk status - opaque
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "opaque" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_more4_fu_cost_xr_eau,
          # Yr 4 FU divided by risk status - lucent
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" & lucency == "lucent" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_more4_fu_cost_us_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 3 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_more4_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_more4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 2 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_more4_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_more4_fu_cost_xr_eau,
          # Yr 3 FU for Recurrence in Yr 1 - opaque
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_sf_fu_cost_xr,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_sf_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 3 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_more4_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_more4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 2 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_more4_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_more4_fu_cost_us_eau,
          # Yr 3 FU for Recurrence in Yr 1 - lucent
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_sf_fu_cost_us,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_sf_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        ),
        
        cost_year_5 = case_when(
          # Yr 5 FU divided by risk status - opaque
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_5_lr_more4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "opaque"  ~ year_5_hr_more4_fu_cost_xr_eau,
          # Yr 5 FU divided by risk status - lucent
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_5_lr_more4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" & lucency == "lucent"  ~ year_5_hr_more4_fu_cost_us_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          
          # Yr 1 FU for Recurrence in Yr 4 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_1_lr_more4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_1_hr_more4_fu_cost_xr_eau,
          # Yr 2 FU for Recurrence in Yr 3 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_2_lr_more4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_2_hr_more4_fu_cost_xr_eau,
          # Yr 3 FU for Recurrence in Yr 2 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "opaque" ~ year_3_lr_more4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "opaque" ~ year_3_hr_more4_fu_cost_xr_eau,
          # Yr 4 FU for Recurrence in Yr 1 - opaque
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "opaque" ~ year_4_lr_more4_fu_cost_xr,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "opaque" ~ year_4_hr_more4_fu_cost_xr_eau,
          
          # Yr 1 FU for Recurrence in Yr 4 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_1_lr_more4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_1_hr_more4_fu_cost_us_eau,
          # Yr 2 FU for Recurrence in Yr 3 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_2_lr_more4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_2_hr_more4_fu_cost_us_eau,
          # Yr 3 FU for Recurrence in Yr 2 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" & lucency == "lucent" ~ year_3_lr_more4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" & lucency == "lucent" ~ year_3_hr_more4_fu_cost_us_eau,
          # Yr 4 FU for Recurrence in Yr 1 - lucent
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" & lucency == "lucent" ~ year_4_lr_more4_fu_cost_us,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" & lucency == "lucent" ~ year_4_hr_more4_fu_cost_us_eau,
          
          TRUE ~ NA_real_
        )
      )
    
    # Combine all stone status groups for this AUC target
    combined_result <- rbind(xr_only_fu_sf, xr_only_fu_less4, xr_only_fu_more4) %>% 
      as_tibble() %>%
      mutate(auc_target = auc_target, 
             cutpoint = cutpoint, 
             post_op_imaging = post_op_imaging,
             imaging_fu_type = imaging_fu_type,
             year = year)
    
    # Store result in list with named element
    results_list[[paste0("auc_", auc_target)]] <- combined_result
  }
  
  # Return results
  if (length(auc_targets) == 1) {
    return(results_list[[1]])
  } else {
    return(results_list)
  }
}
```
\newpage

### Run BIA function for each year
#### 2016
```{r}
costs_2016_xr_min <- calculate_economic_costs(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2016_xr_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2016_fu,
                                              cutpoints_yr = cutpoints_2016,
                                              year = 2016,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2016_xr_us_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2016_fu,
                                              cutpoints_yr = cutpoints_2016,
                                              year = 2016,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr_us")

costs_2016_xr_us_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2016_fu,
                                              cutpoints_yr = cutpoints_2016,
                                              year = 2016,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr_us")

costs_2016_ct_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2016_fu,
                                              cutpoints_yr = cutpoints_2016,
                                              year = 2016,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")

costs_2016_ct_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2016_fu,
                                              cutpoints_yr = cutpoints_2016,
                                              year = 2016,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")
```
\newpage

#### 2017
```{r}
costs_2017_xr_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                              cutpoints_yr = cutpoints_2017,
                                              year = 2017,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2017_xr_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                              cutpoints_yr = cutpoints_2017,
                                              year = 2017,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2017_xr_us_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                                 cutpoints_yr = cutpoints_2017,
                                                 year = 2017,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "min",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2017_xr_us_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                                 cutpoints_yr = cutpoints_2017,
                                                 year = 2017,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "max",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2017_ct_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                              cutpoints_yr = cutpoints_2017,
                                              year = 2017,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")

costs_2017_ct_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2017_fu,
                                              cutpoints_yr = cutpoints_2017,
                                              year = 2017,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")
```
\newpage

#### 2018
```{r}
costs_2018_xr_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                              cutpoints_yr = cutpoints_2018,
                                              year = 2018,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2018_xr_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                              cutpoints_yr = cutpoints_2018,
                                              year = 2018,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2018_xr_us_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                                 cutpoints_yr = cutpoints_2018,
                                                 year = 2018,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "min",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2018_xr_us_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                                 cutpoints_yr = cutpoints_2018,
                                                 year = 2018,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "max",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2018_ct_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                              cutpoints_yr = cutpoints_2018,
                                              year = 2018,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")

costs_2018_ct_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2018_fu,
                                              cutpoints_yr = cutpoints_2018,
                                              year = 2018,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")
```
\newpage

#### 2019
```{r}
costs_2019_xr_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                              cutpoints_yr = cutpoints_2019,
                                              year = 2019,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2019_xr_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                              cutpoints_yr = cutpoints_2019,
                                              year = 2019,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2019_xr_us_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                                 cutpoints_yr = cutpoints_2019,
                                                 year = 2019,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "min",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2019_xr_us_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                                 cutpoints_yr = cutpoints_2019,
                                                 year = 2019,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "max",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2019_ct_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                              cutpoints_yr = cutpoints_2019,
                                              year = 2019,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")

costs_2019_ct_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2019_fu,
                                              cutpoints_yr = cutpoints_2019,
                                              year = 2019,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")
```
\newpage

#### 2020
```{r}
costs_2020_xr_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                              cutpoints_yr = cutpoints_2020,
                                              year = 2020,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2020_xr_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                              cutpoints_yr = cutpoints_2020,
                                              year = 2020,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "xr")

costs_2020_xr_us_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                                 cutpoints_yr = cutpoints_2020,
                                                 year = 2020,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "min",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2020_xr_us_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                                 cutpoints_yr = cutpoints_2020,
                                                 year = 2020,
                                                 auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                                 fu_type = "max",
                                                 post_op_imaging = "none",
                                                 imaging_fu_type = "xr_us")

costs_2020_ct_min <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                              cutpoints_yr = cutpoints_2020,
                                              year = 2020,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "min",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")

costs_2020_ct_max <- calculate_economic_costs(complete_pop_yr_fu = complete_pop_2020_fu,
                                              cutpoints_yr = cutpoints_2020,
                                              year = 2020,
                                              auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                              fu_type = "max",
                                              post_op_imaging = "none",
                                              imaging_fu_type = "ct")
```
\newpage

### Amalgamate Each Year and Plot each AUC
#### Aggregation function
```{r}
aggregate_cost_cohorts <- function(auc_target = c(1,2,3,4,5,6,7,8,9)) {
  all_cohorts <- list()
  
  for (i in auc_target) {
    key <- as.integer(i)
    message("Processing AUC = ", key)
    
    message("  Loading 2016 data...")
    cohort_2016_min_xr <- costs_2016_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2016_min_ct <- costs_2016_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2016_max_xr <- costs_2016_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2016_max_ct <- costs_2016_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2016_min_xr_us <- costs_2016_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2016_max_xr_us <- costs_2016_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2017 data...")
    cohort_2017_min_xr <- costs_2017_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2017_min_ct <- costs_2017_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2017_max_xr <- costs_2017_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2017_max_ct <- costs_2017_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2017_min_xr_us <- costs_2017_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2017_max_xr_us <- costs_2017_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2018 data...")
    cohort_2018_min_xr <- costs_2018_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2018_min_ct <- costs_2018_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2018_max_xr <- costs_2018_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2018_max_ct <- costs_2018_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2018_min_xr_us <- costs_2018_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2018_max_xr_us <- costs_2018_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2019 data...")
    cohort_2019_min_xr <- costs_2019_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2019_min_ct <- costs_2019_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2019_max_xr <- costs_2019_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2019_max_ct <- costs_2019_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2019_min_xr_us <- costs_2019_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2019_max_xr_us <- costs_2019_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2020 data...")
    cohort_2020_min_xr <- costs_2020_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2020_min_ct <- costs_2020_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2020_max_xr <- costs_2020_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2020_max_ct <- costs_2020_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2020_min_xr_us <- costs_2020_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2020_max_xr_us <- costs_2020_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Combining cohorts for AUC = ", key)
    overall_cohort <- dplyr::bind_rows(
      cohort_2016_min_xr, cohort_2016_min_ct, cohort_2016_max_xr, cohort_2016_max_ct, cohort_2016_min_xr_us, cohort_2016_max_xr_us,
      cohort_2017_min_xr, cohort_2017_min_ct, cohort_2017_max_xr, cohort_2017_max_ct, cohort_2017_min_xr_us, cohort_2017_max_xr_us,
      cohort_2018_min_xr, cohort_2018_min_ct, cohort_2018_max_xr, cohort_2018_max_ct, cohort_2018_min_xr_us, cohort_2018_max_xr_us,
      cohort_2019_min_xr, cohort_2019_min_ct, cohort_2019_max_xr, cohort_2019_max_ct, cohort_2019_min_xr_us, cohort_2019_max_xr_us,
      cohort_2020_min_xr, cohort_2020_min_ct, cohort_2020_max_xr, cohort_2020_max_ct, cohort_2020_min_xr_us, cohort_2020_max_xr_us
    )
    
    all_cohorts[[key]] <- overall_cohort
    message(" Done with AUC = ", key, "\n")
  }
  
  message(" Binding all AUC cohorts together...")
  final_df <- dplyr::bind_rows(all_cohorts)
  message(" All done.")
  
  return(final_df)
}
```
\newpage

#### AUC 0.55
```{r}
auc_0.55 <- aggregate_cost_cohorts(auc_target = 1)
```
\newpage

#### AUC 0.6
```{r}
auc_0.6 <- aggregate_cost_cohorts(auc_target = 2)
```
\newpage

#### AUC 0.65
```{r}
auc_0.65 <- aggregate_cost_cohorts(auc_target = 3)
```
\newpage

#### AUC 0.7
```{r}
auc_0.7 <- aggregate_cost_cohorts(auc_target = 4)
```
\newpage

#### AUC 0.75
```{r}
auc_0.75 <- aggregate_cost_cohorts(auc_target = 5)
```
\newpage

#### AUC 0.8
```{r}
auc_0.8 <- aggregate_cost_cohorts(auc_target = 6)
```
\newpage

#### AUC 0.85
```{r}
auc_0.85 <- aggregate_cost_cohorts(auc_target = 7)
```
\newpage

#### AUC 0.9
```{r}
auc_0.9 <- aggregate_cost_cohorts(auc_target = 8)
```
\newpage

#### AUC 0.95
```{r}
auc_0.95 <- aggregate_cost_cohorts(auc_target = 9)
```
\newpage

### Compare length of FU + type of imaging in terms of cost
```{r}
# Combine datasets and calculate cumulative dose
combine_auc_data <- function(data, auc_label) {
  data %>%
    mutate(
      auc_label = auc_label,
      risk_status = ifelse(risk_status == "LR", "Low Risk", "High Risk"),
      annual_costs = case_when(
        year == 2020 ~ cost_year_1,
        year == 2019 ~ cost_year_2,
        year == 2018 ~ cost_year_3,
        year == 2017 ~ cost_year_4,
        year == 2016 ~ cost_year_5,
        TRUE ~ NA_real_
      )
    ) %>%
    select(auc_label, cohort_type, stone_free_status, risk_status, annual_costs, true_rec_5yr)
}

# Combine all AUC datasets and filter cohort_types
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
)

data_for_plot$auc_label <- as.factor(data_for_plot$auc_label)
data_for_plot$cohort_type <- as.factor(data_for_plot$cohort_type)
data_for_plot$risk_status <- as.factor(data_for_plot$risk_status)
data_for_plot$true_rec_5yr <- as.factor(data_for_plot$true_rec_5yr)

# Summarise mean and SD by auc_label, risk_status, cohort_type
summary_df_cost <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type) %>%
  summarise(
    total_cost = sum(annual_costs, na.rm = TRUE),
    .groups = "drop"
  )

# Summarise mean and SD for combined risk groups ("All")
summary_all <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    total_cost = sum(annual_costs, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(risk_status = "All") %>%
  select(auc_label, risk_status, cohort_type, total_cost)

# Combine all summaries
summary_df_cost <- bind_rows(summary_df_cost, summary_all)
summary_df_cost <- summary_df_cost %>% mutate(
  total_cost = total_cost / 1000000
)

# Factor levels for ordering
summary_df_full_cost_data <- summary_df_cost %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US"
                                                 )),
    risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))
  )

# Prepare data_for_plot factors similarly
data_for_plot <- data_for_plot %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US")),
    risk_status = factor(risk_status, levels = c("Low Risk", "High Risk"))
  )

# All auc values
auc_values <- unique(data_for_plot$auc_label)
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by FU type
```{r}
summary_df_full_cost_data %>% group_by(auc_label) %>% ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by auc
```{r}
summary_df_full_cost_data %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual  Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by risk status
```{r}
summary_df_full_cost_data %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = auc_label)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Summary table
```{r}
summary_df_full_cost_data %>% subset(risk_status == "All") %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()
```
\newpage

#### Summary table by risk status
```{r}
summary_df_full_cost_data %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()

summary_df_full_cost_data_all_patients <- summary_df_full_cost_data
```
\newpage

## Examine costs associated with just recurrence
### Recurrence only function 
```{r}
calculate_economic_costs_rec_only <- function(complete_pop_yr_fu,
                                     cutpoints_yr,
                                     year,
                                     auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                     fu_type = c("min", "max"),
                                     post_op_imaging = c("none", ct_cost, imaging_cost, us_cost),
                                     imaging_fu_type = c("ct", "xr", "xr_us"),
                                     xr_sens = 0.67, xr_spec = 0.98,
                                     us_sens = 0.54, us_spec = 0.91) {
  
  
  # Initialize list to store results for each AUC target
  results_list <- list()
  
  # Define post-operative imaging
  post_op_imaging <- ifelse(post_op_imaging == "none",
                            0,
                            post_op_imaging)
  
  # Assign follow-up costs
  year_1_lr_sf_fu_cost <- 0
  year_2_lr_sf_fu_cost <- 0
  year_3_lr_sf_fu_cost <- 0
  year_4_lr_sf_fu_cost <- 0
  year_5_lr_sf_fu_cost  <- 0
  year_1_lr_less4_fu_cost <- 0
  year_2_lr_less4_fu_cost <- 0
  year_3_lr_less4_fu_cost <- 0
  year_4_lr_less4_fu_cost <- 0
  year_5_lr_less4_fu_cost <- 0
  year_1_lr_more4_fu_cost <- 0
  year_2_lr_more4_fu_cost <- 0
  year_3_lr_more4_fu_cost <- 0
  year_4_lr_more4_fu_cost <- 0
  year_5_lr_more4_fu_cost <- 0
  year_1_hr_sf_fu_cost_current <- 0
  year_1_hr_sf_fu_cost_eau <- 0
  year_2_hr_sf_fu_cost_current <- 0
  year_2_hr_sf_fu_cost_eau <- 0
  year_3_onwards_hr_sf_fu_cost_current <- 0
  year_3_onwards_hr_sf_fu_cost_eau <- 0
  year_3_hr_sf_fu_cost_current <- 0
  year_3_hr_sf_fu_cost_eau <- 0
  year_4_hr_sf_fu_cost_eau <- 0
  year_5_hr_sf_fu_cost_eau <- 0
  year_1_hr_less4_fu_cost_eau <- 0
  year_2_hr_less4_fu_cost_eau <- 0
  year_3_hr_less4_fu_cost_eau <- 0
  year_4_hr_less4_fu_cost_eau <- 0
  year_5_hr_less4_fu_cost_eau <- 0
  year_1_hr_more4_fu_cost_eau <- 0
  year_2_hr_more4_fu_cost_eau <- 0
  year_3_hr_more4_fu_cost_eau <- 0
  year_4_hr_more4_fu_cost_eau <- 0
  year_5_hr_more4_fu_cost_eau <- 0
  
  # Assign recurrence costs
  # Assign recurrence costs
  rec_cost_colic <- ifelse(imaging_fu_type == "ct",
                           rec_cost_colic,
                           rec_cost_colic + imaging_cost)
  rec_cost_eswl <- ifelse(imaging_fu_type == "ct",
                          rec_cost_eswl,
                          rec_cost_eswl + imaging_cost)
  rec_cost_urs <- ifelse(imaging_fu_type == "ct",
                         rec_cost_urs,
                         rec_cost_urs + imaging_cost)
  rec_cost_pcnl <- ifelse(imaging_fu_type == "ct",
                          rec_cost_pcnl,
                          rec_cost_pcnl + imaging_cost)
  
  for (auc_target in auc_targets) {
    message("Calculating costs for: ", year, ", AUC: ", auc_target, ", Follow-up Type: ", fu_type, ", Follow-up Imaging: ", imaging_fu_type, " and Post-Operative Imaging:", post_op_imaging)
    # Get cutpoint for current AUC target
    cutpoint <- (cutpoints_yr %>% filter(auc_target == !!auc_target))$cutpoint
    
    not_sf_props <- complete_pop_yr_fu %>%
      filter(stone_free_status %in% c("less4", "more4")) %>%
      count(stone_free_status) %>%
      mutate(prop = n / sum(n)) %>%
      select(stone_free_status, prop)
    
    less4_prob <- not_sf_props$prop[not_sf_props$stone_free_status == "less4"]
    
    # Distribute SF status as determined by imaging
    if (imaging_fu_type == "xr") {
      ct_cost <- ct_cost + imaging_cost
      
      # Generate random numbers once
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= xr_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > xr_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= xr_spec ~ "SF",
            stone_free_status_original == "sf" & rand_spec > xr_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original 
          ),
          .keep = "all"
        )
    } else if (imaging_fu_type == "xr_us") {
      ct_cost <- ct_cost + imaging_cost
      
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= us_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > us_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= us_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > us_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original
          ),
          .keep = "all"
        )
    } else {
      # For CT imaging, no sensitivity/specificity adjustment needed
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = stone_free_status,
          .keep = "all"
        )
      
      ct_cost <- ct_cost
    }
    
    # SF patients with minimum follow-up strategy
    if (fu_type == "min") {
      fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          cost_year_0 = case_when(
            # Cost of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          cost_year_1 = case_when(
            # Yr 1 FU divided by risk status
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
            TRUE ~ NA_real_
          ),
          
          cost_year_2 = case_when(
            # Yr 2 FU divided by risk status
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Death
            death_year_2 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 1
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_3 = case_when(
            # Yr 3 FU divided by risk status
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            # Death
            death_year_3 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 2
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 1
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_4 = case_when(
            # Yr 4 FU divided by risk status
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_sf_fu_cost_eau,
            # Death
            death_year_4 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 3
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 2
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Yr 3 FU for Recurrence in Yr 1
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_5 = case_when(
            # Yr 5 FU divided by risk status
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_sf_fu_cost_eau,
            # Death
            death_year_5 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 4 
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 3
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Yr 3 FU for Recurrence in Yr 2
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            # Yr 4 FU for Recurrence in Yr 1
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          )
        )
    } else {
      # SF patients with maximum follow-up strategy
      fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          cost_year_0 = case_when(
            # Cost of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          
          cost_year_1 = case_when(
            # Yr 1 FU divided by risk status
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
            TRUE ~ NA_real_
          ),
          
          cost_year_2 = case_when(
            # Yr 2 FU divided by risk status
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Death
            death_year_2 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 1
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_3 = case_when(
            # Yr 3 FU divided by risk status
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            # Death
            death_year_3 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 2
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 1
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_4 = case_when(
            # Yr 4 FU divided by risk status
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_sf_fu_cost_eau,
            # Death
            death_year_4 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 3
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 2
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Yr 3 FU for Recurrence in Yr 1
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          ),
          
          cost_year_5 = case_when(
            # Yr 5 FU divided by risk status
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_sf_fu_cost_eau,
            # Death
            death_year_5 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
            # Yr 1 FU for Recurrence in Yr 4 
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_cost_eau,
            # Yr 2 FU for Recurrence in Yr 3
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_cost_eau,
            # Yr 3 FU for Recurrence in Yr 2
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
            # Yr 4 FU for Recurrence in Yr 1
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_sf_fu_cost,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_sf_fu_cost_eau,
            TRUE ~ NA_real_
          )
        )
    }
    
    # Less than 4mm stones
    fu_less4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "less4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        cost_year_0 = case_when(
          # Cost of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        cost_year_1 = case_when(
          # Yr 1 FU divided by risk status
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_cost,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_cost_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
          TRUE ~ NA_real_
        ),
        
        cost_year_2 = case_when(
          # Yr 2 FU divided by risk status
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_cost,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_cost_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 1
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_less4_fu_cost,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_less4_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_3 = case_when(
          # Yr 3 FU divided by risk status
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_less4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_less4_fu_cost_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 2
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 1
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_less4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_less4_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_4 = case_when(
          # Yr 4 FU divided by risk status
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_less4_fu_cost_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 3
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 2
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_cost_eau,
          # Yr 3 FU for Recurrence in Yr 1
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_5 = case_when(
          # Yr 5 FU divided by risk status
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_less4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_less4_fu_cost_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 4 
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 3
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_cost_eau,
          # Yr 3 FU for Recurrence in Yr 2
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_less4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_less4_fu_cost_eau,
          # Yr 4 FU for Recurrence in Yr 1
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_less4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_less4_fu_cost_eau,
          TRUE ~ NA_real_
        )
      )
    
    # More than 4mm stones
    fu_more4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "more4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        cost_year_0 = case_when(
          # Cost of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        cost_year_1 = case_when(
          # Yr 1 FU divided by risk status
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_cost,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_cost_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_cost_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_cost_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_cost_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_cost_pcnl,
          TRUE ~ NA_real_
        ),
        
        cost_year_2 = case_when(
          # Yr 2 FU divided by risk status
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_cost,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_cost_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_cost_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_cost_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_cost_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 1
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_more4_fu_cost,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_more4_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_3 = case_when(
          # Yr 3 FU divided by risk status
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_more4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_more4_fu_cost_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_cost_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_cost_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_cost_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 2
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 1
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_more4_fu_cost,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_more4_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_4 = case_when(
          # Yr 4 FU divided by risk status
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_more4_fu_cost_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 3
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 2
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_cost_eau,
          # Yr 3 FU for Recurrence in Yr 1
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_cost,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_cost_eau,
          TRUE ~ NA_real_
        ),
        
        cost_year_5 = case_when(
          # Yr 5 FU divided by risk status
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_more4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_more4_fu_cost_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_cost_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_cost_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_cost_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_cost_pcnl,
          # Yr 1 FU for Recurrence in Yr 4 
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_cost_eau,
          # Yr 2 FU for Recurrence in Yr 3
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_cost_eau,
          # Yr 3 FU for Recurrence in Yr 2
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_more4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_more4_fu_cost_eau,
          # Yr 4 FU for Recurrence in Yr 1
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_more4_fu_cost,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_more4_fu_cost_eau,
          TRUE ~ NA_real_
        )
      )
    
    # Combine all stone status groups for this AUC target
    combined_result <- rbind(fu_sf, 
                             fu_less4, 
                             fu_more4) %>% 
      as_tibble() %>%
      mutate(auc_target = auc_target, 
             cutpoint = cutpoint, 
             post_op_imaging = post_op_imaging,
             imaging_fu_type = imaging_fu_type,
             year = year)
    
    # Store result in list with named element
    results_list[[paste0("auc_", auc_target)]] <- combined_result
  }
  
  # Return results
  if (length(auc_targets) == 1) {
    return(results_list[[1]])
  } else {
    return(results_list)
  }
}
```
\newpage

### Run function for each year
#### 2016
```{r}
costs_2016_xr_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2016_xr_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2016_xr_us_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2016_xr_us_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2016_ct_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

costs_2016_ct_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)
```
\newpage

#### 2017
```{r}
costs_2017_xr_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2017_xr_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2017_xr_us_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2017_xr_us_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2017_ct_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

costs_2017_ct_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)
```
\newpage

#### 2018
```{r}
costs_2018_xr_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2018_xr_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2018_xr_us_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2018_xr_us_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2018_ct_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

costs_2018_ct_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)
```
\newpage

#### 2019
```{r}
costs_2019_xr_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2019_xr_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2019_xr_us_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2019_xr_us_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2019_ct_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

costs_2019_ct_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)
```
\newpage

#### 2020
```{r}
costs_2020_xr_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2020_xr_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr"
)

costs_2020_xr_us_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2020_xr_us_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "xr_us"
)

costs_2020_ct_min <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

costs_2020_ct_max <- calculate_economic_costs_rec_only(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  post_op_imaging = "none",
  imaging_fu_type = "ct"
)

```
\newpage

### Amalgamate Each Year and Plot each AUC
#### Aggregation function
```{r}
aggregate_cost_cohorts <- function(auc_target = c(1,2,3,4,5,6,7,8,9)) {
  all_cohorts <- list()
  
  for (i in auc_target) {
    key <- as.integer(i)
    message("Processing AUC = ", key)
    
    message("  Loading 2016 data...")
    cohort_2016_min_xr <- costs_2016_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2016_min_ct <- costs_2016_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2016_max_xr <- costs_2016_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2016_max_ct <- costs_2016_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2016_min_xr_us <- costs_2016_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2016_max_xr_us <- costs_2016_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2017 data...")
    cohort_2017_min_xr <- costs_2017_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2017_min_ct <- costs_2017_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2017_max_xr <- costs_2017_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2017_max_ct <- costs_2017_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2017_min_xr_us <- costs_2017_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2017_max_xr_us <- costs_2017_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2018 data...")
    cohort_2018_min_xr <- costs_2018_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2018_min_ct <- costs_2018_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2018_max_xr <- costs_2018_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2018_max_ct <- costs_2018_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2018_min_xr_us <- costs_2018_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2018_max_xr_us <- costs_2018_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2019 data...")
    cohort_2019_min_xr <- costs_2019_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2019_min_ct <- costs_2019_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2019_max_xr <- costs_2019_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2019_max_ct <- costs_2019_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2019_min_xr_us <- costs_2019_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2019_max_xr_us <- costs_2019_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2020 data...")
    cohort_2020_min_xr <- costs_2020_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2020_min_ct <- costs_2020_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2020_max_xr <- costs_2020_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2020_max_ct <- costs_2020_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2020_min_xr_us <- costs_2020_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2020_max_xr_us <- costs_2020_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Combining cohorts for AUC = ", key)
    overall_cohort <- dplyr::bind_rows(
      cohort_2016_min_xr, cohort_2016_min_ct, cohort_2016_max_xr, cohort_2016_max_ct, cohort_2016_min_xr_us, cohort_2016_max_xr_us,
      cohort_2017_min_xr, cohort_2017_min_ct, cohort_2017_max_xr, cohort_2017_max_ct, cohort_2017_min_xr_us, cohort_2017_max_xr_us,
      cohort_2018_min_xr, cohort_2018_min_ct, cohort_2018_max_xr, cohort_2018_max_ct, cohort_2018_min_xr_us, cohort_2018_max_xr_us,
      cohort_2019_min_xr, cohort_2019_min_ct, cohort_2019_max_xr, cohort_2019_max_ct, cohort_2019_min_xr_us, cohort_2019_max_xr_us,
      cohort_2020_min_xr, cohort_2020_min_ct, cohort_2020_max_xr, cohort_2020_max_ct, cohort_2020_min_xr_us, cohort_2020_max_xr_us
    )
    
    all_cohorts[[key]] <- overall_cohort
    message(" Done with AUC = ", key, "\n")
  }
  
  message(" Binding all AUC cohorts together...")
  final_df <- dplyr::bind_rows(all_cohorts)
  message(" All done.")
  
  return(final_df)
}
```
\newpage

#### AUC 0.55
```{r}
auc_0.55 <- aggregate_cost_cohorts(auc_target = 1)
```
\newpage

#### AUC 0.6
```{r}
auc_0.6 <- aggregate_cost_cohorts(auc_target = 2)
```
\newpage

#### AUC 0.65
```{r}
auc_0.65 <- aggregate_cost_cohorts(auc_target = 3)
```
\newpage

#### AUC 0.7
```{r}
auc_0.7 <- aggregate_cost_cohorts(auc_target = 4)
```
\newpage

#### AUC 0.75
```{r}
auc_0.75 <- aggregate_cost_cohorts(auc_target = 5)
```
\newpage

#### AUC 0.8
```{r}
auc_0.8 <- aggregate_cost_cohorts(auc_target = 6)
```
\newpage

#### AUC 0.85
```{r}
auc_0.85 <- aggregate_cost_cohorts(auc_target = 7)
```
\newpage

#### AUC 0.9
```{r}
auc_0.9 <- aggregate_cost_cohorts(auc_target = 8)
```
\newpage

#### AUC 0.95
```{r}
auc_0.95 <- aggregate_cost_cohorts(auc_target = 9)
```
\newpage

### Compare length of FU + type of imaging in terms of cost
```{r}
# Combine datasets and calculate cumulative dose
combine_auc_data <- function(data, auc_label) {
  data %>%
    mutate(
      auc_label = auc_label,
      risk_status = ifelse(risk_status == "LR", "Low Risk", "High Risk"),
      annual_costs = case_when(
        year == 2020 ~ cost_year_1,
        year == 2019 ~ cost_year_2,
        year == 2018 ~ cost_year_3,
        year == 2017 ~ cost_year_4,
        year == 2016 ~ cost_year_5,
        TRUE ~ NA_real_
      )
    ) %>%
    select(auc_label, cohort_type, stone_free_status, risk_status, annual_costs, true_rec_5yr)
}

# Combine all AUC datasets and filter cohort_types
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
)

data_for_plot$auc_label <- as.factor(data_for_plot$auc_label)
data_for_plot$cohort_type <- as.factor(data_for_plot$cohort_type)
data_for_plot$risk_status <- as.factor(data_for_plot$risk_status)
data_for_plot$true_rec_5yr <- as.factor(data_for_plot$true_rec_5yr)

# Summarise mean and SD by auc_label, risk_status, cohort_type
summary_df <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type) %>%
  summarise(
    total_cost = sum(annual_costs, na.rm = TRUE),
    .groups = "drop"
  )

# Summarise mean and SD for combined risk groups ("All")
summary_all <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    total_cost = sum(annual_costs, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(risk_status = "All") %>%
  select(auc_label, risk_status, cohort_type, total_cost)

# Combine all summaries
summary_df <- bind_rows(summary_df, summary_all)
summary_df <- summary_df %>% mutate(
  total_cost = total_cost / 1000000
)

# Factor levels for ordering
summary_df <- summary_df %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US"
                                                 )),
    risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))
  )

# Prepare data_for_plot factors similarly
data_for_plot <- data_for_plot %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US")),
    risk_status = factor(risk_status, levels = c("Low Risk", "High Risk"))
  )

# All auc values
auc_values <- unique(data_for_plot$auc_label)
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by FU type
```{r}
summary_df %>% group_by(auc_label) %>% ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Total Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by auc
```{r}
summary_df %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Total Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Plot total cost by cohort_type within risk groups - facet by risk status
```{r}
summary_df %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = auc_label)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Total Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```
\newpage

#### Plot total cost by auc - facet by risk status and cohort_type
```{r}
summary_df %>% 
  group_by(auc_label) %>% 
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_grid(risk_status ~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease in those with Disease Recurrence",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up ( Millions)",
    fill = "Risk Status"
  )
```


#### Summary table
```{r}
summary_df %>% subset(risk_status == "All") %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()
```
\newpage

# Clinician Time
## Function to calculate number of appointments
```{r}
calculate_no_appts <- function(complete_pop_yr_fu,
                                     cutpoints_yr,
                                     year = 2016,
                                     auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
                                     fu_type = c("min", "max"),
                                     imaging_fu_type = c("ct", "xr", "xr_us"),
                                     xr_sens = 0.67, xr_spec = 0.98,
                                     us_sens = 0.54, us_spec = 0.91) {
  
  
  # Initialize list to store results for each AUC target
  results_list <- list()
  
  # Define post-operative imaging
  post_op_imaging <- ifelse(imaging_fu_type == "ct",
                            1,
                            2)
  
  # Assign follow-up appts
  fu_appts_1 <- fu_appts %>% filter(imaging_type == imaging_fu_type)
  
  year_1_lr_sf_fu_appts <- fu_appts_1$appts[1] %>% as.integer()
  year_2_lr_sf_fu_appts <- fu_appts_1$appts[2] %>% as.integer()
  year_3_lr_sf_fu_appts <- fu_appts_1$appts[3] %>% as.integer()
  year_4_lr_sf_fu_appts <- fu_appts_1$appts[4] %>% as.integer()
  year_5_lr_sf_fu_appts  <- fu_appts_1$appts[5] %>% as.integer()
  year_1_lr_less4_fu_appts <- fu_appts_1$appts[6] %>% as.integer()
  year_2_lr_less4_fu_appts <- fu_appts_1$appts[7] %>% as.integer()
  year_3_lr_less4_fu_appts <- fu_appts_1$appts[8] %>% as.integer()
  year_4_lr_less4_fu_appts <- fu_appts_1$appts[9] %>% as.integer()
  year_5_lr_less4_fu_appts <- fu_appts_1$appts[10] %>% as.integer()
  year_1_lr_more4_fu_appts <- fu_appts_1$appts[11] %>% as.integer()
  year_2_lr_more4_fu_appts <- fu_appts_1$appts[12] %>% as.integer()
  year_3_lr_more4_fu_appts <- fu_appts_1$appts[13] %>% as.integer()
  year_4_lr_more4_fu_appts <- fu_appts_1$appts[14] %>% as.integer()
  year_5_lr_more4_fu_appts <- fu_appts_1$appts[15] %>% as.integer()
  year_1_hr_sf_fu_appts_current <- fu_appts_1$appts[16] %>% as.integer()
  year_1_hr_sf_fu_appts_eau <- fu_appts_1$appts[17] %>% as.integer()
  year_2_hr_sf_fu_appts_current <- fu_appts_1$appts[18] %>% as.integer()
  year_2_hr_sf_fu_appts_eau <- fu_appts_1$appts[19] %>% as.integer()
  year_3_onwards_hr_sf_fu_appts_current <- fu_appts_1$appts[20] %>% as.integer()
  year_3_onwards_hr_sf_fu_appts_eau <- fu_appts_1$appts[21] %>% as.integer()
  year_3_hr_sf_fu_appts_current <- fu_appts_1$appts[22] %>% as.integer()
  year_3_hr_sf_fu_appts_eau <- fu_appts_1$appts[23] %>% as.integer()
  year_4_hr_sf_fu_appts_eau <- fu_appts_1$appts[24] %>% as.integer()
  year_5_hr_sf_fu_appts_eau <- fu_appts_1$appts[25] %>% as.integer()
  year_1_hr_less4_fu_appts_eau <- fu_appts_1$appts[26] %>% as.integer()
  year_2_hr_less4_fu_appts_eau <- fu_appts_1$appts[27] %>% as.integer()
  year_3_hr_less4_fu_appts_eau <- fu_appts_1$appts[28] %>% as.integer()
  year_4_hr_less4_fu_appts_eau <- fu_appts_1$appts[29] %>% as.integer()
  year_5_hr_less4_fu_appts_eau <- fu_appts_1$appts[30] %>% as.integer()
  year_1_hr_more4_fu_appts_eau <- fu_appts_1$appts[31] %>% as.integer()
  year_2_hr_more4_fu_appts_eau <- fu_appts_1$appts[32] %>% as.integer()
  year_3_hr_more4_fu_appts_eau <- fu_appts_1$appts[33] %>% as.integer()
  year_4_hr_more4_fu_appts_eau <- fu_appts_1$appts[34] %>% as.integer()
  year_5_hr_more4_fu_appts_eau <- fu_appts_1$appts[35] %>% as.integer()
  
  # Assign recurrence times
  rec_appts_colic <- 1 + post_op_imaging
  rec_appts_eswl <- 2 + post_op_imaging
  rec_appts_urs <- 1 + post_op_imaging
  rec_appts_pcnl <- 1 + post_op_imaging
  
  for (auc_target in auc_targets) {
    message("Calculating times for: ", year, ", AUC: ", auc_target, ", Follow-up Type: ", fu_type, ", Follow-up Imaging: ", imaging_fu_type, " and Post-Operative Imaging:", post_op_imaging)
    # Get cutpoint for current AUC target
    cutpoint <- (cutpoints_yr %>% filter(auc_target == !!auc_target))$cutpoint
    
    not_sf_props <- complete_pop_yr_fu %>%
      filter(stone_free_status %in% c("less4", "more4")) %>%
      count(stone_free_status) %>%
      mutate(prop = n / sum(n)) %>%
      select(stone_free_status, prop)
    
    less4_prob <- not_sf_props$prop[not_sf_props$stone_free_status == "less4"]
    
    # Distribute SF status as determined by imaging
    if (imaging_fu_type == "xr") {
      
      
      # Generate random numbers once
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= xr_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > xr_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= xr_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > xr_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original # Handle any other cases
          ),
          .keep = "all"
        )
    } else if (imaging_fu_type == "xr_us") {
      rand_sens <- runif(nrow(complete_pop_yr_fu))
      rand_spec <- runif(nrow(complete_pop_yr_fu))
      
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = case_when(
            stone_free_status_original %in% c("less4", "more4") & rand_sens <= us_sens ~ stone_free_status_original,
            stone_free_status_original %in% c("less4", "more4") & rand_sens > us_sens ~ "SF", 
            stone_free_status_original == "sf" & rand_spec <= us_spec ~ "SF", 
            stone_free_status_original == "sf" & rand_spec > us_spec ~ ifelse(
              runif(n()) <= less4_prob, "less4", "more4"
            ),
            TRUE ~ stone_free_status_original
          ),
          .keep = "all"
        )
    } else {
      # For CT imaging, no sensitivity/specificity adjustment needed
      complete_pop_yr_fu1 <- complete_pop_yr_fu %>%
        mutate(
          stone_free_status_original = stone_free_status,
          stone_free_status1 = stone_free_status,
          .keep = "all"
        )
    }
    
    # SF patients with minimum follow-up strategy
    if (fu_type == "min") {
      xr_only_fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          appt_year_0 = case_when(
            # time of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          appt_year_1 = case_when(
            # Yr 1 FU divided by risk status
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_appts_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_appts_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_appts_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_appts_pcnl,
            TRUE ~ NA_real_
          ),
          
          appt_year_2 = case_when(
            # Yr 2 FU divided by risk status
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Death
            death_year_2 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_appts_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_appts_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_appts_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 1
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_3 = case_when(
            # Yr 3 FU divided by risk status
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_appts_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_appts_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_appts_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 2
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 1
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_4 = case_when(
            # Yr 4 FU divided by risk status
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_sf_fu_appts_eau,
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 3
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 2
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Yr 3 FU for Recurrence in Yr 1
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_5 = case_when(
            # Yr 5 FU divided by risk status
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_sf_fu_appts_eau,
            # Death
            death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 4 
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 3
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Yr 3 FU for Recurrence in Yr 2
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            # Yr 4 FU for Recurrence in Yr 1
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ 0,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          )
        )
    } else {
      # SF patients with maximum follow-up strategy
      xr_only_fu_sf <- complete_pop_yr_fu1 %>%
        filter(stone_free_status1 == "SF" & auc_target == !!auc_target) %>%
        mutate(
          risk_status = case_when(
            score < cutpoint ~ "LR",
            score >= cutpoint ~ "HR"
          ),
          appt_year_0 = case_when(
            # time of post-operative CT
            death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
            TRUE ~ NA_real_
          ),
          
          appt_year_1 = case_when(
            # Yr 1 FU divided by risk status
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Death
            death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_appts_colic, 
            death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_appts_eswl,
            death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_appts_urs,
            death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_appts_pcnl,
            TRUE ~ NA_real_
          ),
          
          appt_year_2 = case_when(
            # Yr 2 FU divided by risk status
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Death
            death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_appts_colic, 
            death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_appts_eswl,
            death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_appts_urs,
            death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 1
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_3 = case_when(
            # Yr 3 FU divided by risk status
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            # Death
            death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_appts_colic, 
            death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_appts_eswl,
            death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_appts_urs,
            death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 2
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 1
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_4 = case_when(
            # Yr 4 FU divided by risk status
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
            death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_sf_fu_appts_eau,
            # Death
            death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 3
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 2
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Yr 3 FU for Recurrence in Yr 1
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_4 == "No" & recurrence_year_4 == "Yes" &
              recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          ),
          
          appt_year_5 = case_when(
            # Yr 5 FU divided by risk status
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_sf_fu_appts_eau,
            # Death
            death_year_5 == "Yes" | death_year_4 == "Yes" | death_year_3 == "Yes" | death_year_2 == "Yes" | death_year_1 == "Yes" ~ 0,
            # Recurrence
            death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
            death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
            death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
            death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
            # Yr 1 FU for Recurrence in Yr 4 
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_sf_fu_appts_eau,
            # Yr 2 FU for Recurrence in Yr 3
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_sf_fu_appts_eau,
            # Yr 3 FU for Recurrence in Yr 2
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
            # Yr 4 FU for Recurrence in Yr 1
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_sf_fu_appts,
            death_year_5 == "No" & recurrence_year_5 == "Yes" &
              recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_sf_fu_appts_eau,
            TRUE ~ NA_real_
          )
        )
    }
    
    # Less than 4mm stones
    xr_only_fu_less4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "less4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        appt_year_0 = case_when(
          # time of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        appt_year_1 = case_when(
          # Yr 1 FU divided by risk status
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_appts,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_appts_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_appts_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_appts_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_appts_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_appts_pcnl,
          TRUE ~ NA_real_
        ),
        
        appt_year_2 = case_when(
          # Yr 2 FU divided by risk status
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_appts,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_appts_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_appts_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_appts_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_appts_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 1
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_less4_fu_appts,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_less4_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_3 = case_when(
          # Yr 3 FU divided by risk status
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_less4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_less4_fu_appts_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_appts_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_appts_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_appts_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 2
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 1
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_less4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_less4_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_4 = case_when(
          # Yr 4 FU divided by risk status
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_less4_fu_appts_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 3
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 2
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_appts_eau,
          # Yr 3 FU for Recurrence in Yr 1
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_5 = case_when(
          # Yr 5 FU divided by risk status
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_less4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_less4_fu_appts_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 4 
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_less4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_less4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 3
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_less4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_less4_fu_appts_eau,
          # Yr 3 FU for Recurrence in Yr 2
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_less4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_less4_fu_appts_eau,
          # Yr 4 FU for Recurrence in Yr 1
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_less4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_less4_fu_appts_eau,
          TRUE ~ NA_real_
        )
      )
    
    # More than 4mm stones
    xr_only_fu_more4 <- complete_pop_yr_fu1 %>% 
      filter(stone_free_status1 == "more4" & auc_target == !!auc_target) %>%
      mutate(
        risk_status = case_when(
          score < cutpoint ~ "LR",
          score >= cutpoint ~ "HR"
        ),
        appt_year_0 = case_when(
          # time of post-operative CT
          death_year_0 == "No" & recurrence_year_0 == "No" ~ post_op_imaging,
          TRUE ~ NA_real_
        ),
        
        appt_year_1 = case_when(
          # Yr 1 FU divided by risk status
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_appts,
          death_year_1 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_appts_eau,
          # Death
          death_year_1 == "Yes" ~ 0,
          # Recurrence
          death_year_1 == "No" & colic_intervention_type_year_1 == "Colic" ~ rec_appts_colic, 
          death_year_1 == "No" & colic_intervention_type_year_1 == "ESWL" ~ rec_appts_eswl,
          death_year_1 == "No" & colic_intervention_type_year_1 == "URS" ~ rec_appts_urs,
          death_year_1 == "No" & colic_intervention_type_year_1 == "PCNL" ~ rec_appts_pcnl,
          TRUE ~ NA_real_
        ),
        
        appt_year_2 = case_when(
          # Yr 2 FU divided by risk status
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_appts,
          death_year_2 == "No" & recurrence_year_2 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_appts_eau,
          # Death
          death_year_2 == "Yes" ~ 0,
          # Recurrence
          death_year_2 == "No" & colic_intervention_type_year_2 == "Colic" & recurrence_year_1 == "No" ~ rec_appts_colic, 
          death_year_2 == "No" & colic_intervention_type_year_2 == "ESWL" & recurrence_year_1 == "No" ~ rec_appts_eswl,
          death_year_2 == "No" & colic_intervention_type_year_2 == "URS" & recurrence_year_1 == "No"  ~ rec_appts_urs,
          death_year_2 == "No" & colic_intervention_type_year_2 == "PCNL" & recurrence_year_1 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 1
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_1_lr_more4_fu_appts,
          death_year_2 == "No" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_1_hr_more4_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_3 = case_when(
          # Yr 3 FU divided by risk status
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "LR" ~ year_3_lr_more4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "No" & risk_status == "HR" ~ year_3_hr_more4_fu_appts_eau,
          # Death
          death_year_3 == "Yes" ~ 0,
          # Recurrence
          death_year_3 == "No" & colic_intervention_type_year_3 == "Colic" & recurrence_year_2 == "No" ~ rec_appts_colic, 
          death_year_3 == "No" & colic_intervention_type_year_3 == "ESWL" & recurrence_year_2 == "No" ~ rec_appts_eswl,
          death_year_3 == "No" & colic_intervention_type_year_3 == "URS" & recurrence_year_2 == "No"  ~ rec_appts_urs,
          death_year_3 == "No" & colic_intervention_type_year_3 == "PCNL" & recurrence_year_2 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 2
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 1
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_2_lr_more4_fu_appts,
          death_year_3 == "No" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_2_hr_more4_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_4 = case_when(
          # Yr 4 FU divided by risk status
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "LR" ~ 0,
          death_year_4 == "No" & recurrence_year_4 == "No" & risk_status == "HR" ~ year_4_hr_more4_fu_appts_eau,
          # Death
          death_year_4 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 3
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 2
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_appts_eau,
          # Yr 3 FU for Recurrence in Yr 1
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_3_lr_sf_fu_appts,
          death_year_4 == "No" & recurrence_year_4 == "Yes" &
            recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_3_hr_sf_fu_appts_eau,
          TRUE ~ NA_real_
        ),
        
        appt_year_5 = case_when(
          # Yr 5 FU divided by risk status
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "LR" ~ year_5_lr_more4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "No" & risk_status == "HR" ~ year_5_hr_more4_fu_appts_eau,
          # Death
          death_year_5 == "Yes" ~ 0,
          # Recurrence
          death_year_4 == "No" & colic_intervention_type_year_4 == "Colic" & recurrence_year_3 == "No" ~ rec_appts_colic, 
          death_year_4 == "No" & colic_intervention_type_year_4 == "ESWL" & recurrence_year_3 == "No" ~ rec_appts_eswl,
          death_year_4 == "No" & colic_intervention_type_year_4 == "URS" & recurrence_year_3 == "No"  ~ rec_appts_urs,
          death_year_4 == "No" & colic_intervention_type_year_4 == "PCNL" & recurrence_year_3 == "No" ~ rec_appts_pcnl,
          # Yr 1 FU for Recurrence in Yr 4 
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_1_lr_more4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "No" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_1_hr_more4_fu_appts_eau,
          # Yr 2 FU for Recurrence in Yr 3
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_2_lr_more4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "No" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_2_hr_more4_fu_appts_eau,
          # Yr 3 FU for Recurrence in Yr 2
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "LR" ~ year_3_lr_more4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "No" & risk_status == "HR" ~ year_3_hr_more4_fu_appts_eau,
          # Yr 4 FU for Recurrence in Yr 1
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "LR" ~ year_4_lr_more4_fu_appts,
          death_year_5 == "No" & recurrence_year_5 == "Yes" &
            recurrence_year_4 == "Yes" & recurrence_year_3 == "Yes" & recurrence_year_2 == "Yes" & recurrence_year_1 == "Yes" & risk_status == "HR" ~ year_4_hr_more4_fu_appts_eau,
          TRUE ~ NA_real_
        )
      )
    
    # Combine all stone status groups for this AUC target
    combined_result <- rbind(xr_only_fu_sf, xr_only_fu_less4, xr_only_fu_more4) %>% 
      as_tibble() %>%
      mutate(auc_target = auc_target, 
             cutpoint = cutpoint, 
             post_op_imaging = post_op_imaging,
             imaging_fu_type = imaging_fu_type,
             year = year)
    
    # Store result in list with named element
    results_list[[paste0("auc_", auc_target)]] <- combined_result
  }
  
  # Return results
  if (length(auc_targets) == 1) {
    return(results_list[[1]])
  } else {
    return(results_list)
  }
}
```
\newpage

### Run function for each year
#### 2016
```{r}
appts_2016_xr_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  imaging_fu_type = "xr"
)

appts_2016_xr_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  imaging_fu_type = "xr"
)

appts_2016_xr_us_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  imaging_fu_type = "xr_us"
)

appts_2016_xr_us_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  imaging_fu_type = "xr_us"
)

appts_2016_ct_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  imaging_fu_type = "ct"
)

appts_2016_ct_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2016_fu,
  cutpoints_yr = cutpoints_2016,
  year = 2016,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  imaging_fu_type = "ct"
)
```
\newpage

#### 2017
```{r}
appts_2017_xr_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr"
)

appts_2017_xr_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr"
)

appts_2017_xr_us_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr_us"
)

appts_2017_xr_us_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr_us"
)

appts_2017_ct_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "ct"
)

appts_2017_ct_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2017_fu,
  cutpoints_yr = cutpoints_2017,
  year = 2017,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "ct"
)
```
\newpage

#### 2018
```{r}
appts_2018_xr_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr"
)

appts_2018_xr_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr"
)

appts_2018_xr_us_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr_us"
)

appts_2018_xr_us_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr_us"
)

appts_2018_ct_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "ct"
)

appts_2018_ct_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2018_fu,
  cutpoints_yr = cutpoints_2018,
  year = 2018,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "ct"
)
```
\newpage

#### 2019
```{r}
appts_2019_xr_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr"
)

appts_2019_xr_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr"
)

appts_2019_xr_us_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr_us"
)

appts_2019_xr_us_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr_us"
)

appts_2019_ct_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "ct"
)

appts_2019_ct_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2019_fu,
  cutpoints_yr = cutpoints_2019,
  year = 2019,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "ct"
)
```
\newpage

#### 2020
```{r}
appts_2020_xr_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr"
)

appts_2020_xr_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr"
)

appts_2020_xr_us_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "xr_us"
)

appts_2020_xr_us_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "xr_us"
)

appts_2020_ct_min <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "min",
  
  imaging_fu_type = "ct"
)

appts_2020_ct_max <- calculate_no_appts(
  complete_pop_yr_fu = complete_pop_2020_fu,
  cutpoints_yr = cutpoints_2020,
  year = 2020,
  auc_targets = c(0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95),
  fu_type = "max",
  
  imaging_fu_type = "ct"
)

```
\newpage

### Amalgamate Each Year and Plot each AUC
#### Aggregation function
```{r}
aggregate_appt_cohorts <- function(auc_target = c(1,2,3,4,5,6,7,8,9)) {
  all_cohorts <- list()
  
  for (i in auc_target) {
    key <- as.integer(i)
    message("Processing AUC = ", key)
    
    message("  Loading 2016 data...")
    cohort_2016_min_xr <- appts_2016_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2016_min_ct <- appts_2016_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2016_max_xr <- appts_2016_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2016_max_ct <- appts_2016_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2016_min_xr_us <- appts_2016_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2016_max_xr_us <- appts_2016_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2017 data...")
    cohort_2017_min_xr <- appts_2017_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2017_min_ct <- appts_2017_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2017_max_xr <- appts_2017_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2017_max_ct <- appts_2017_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2017_min_xr_us <- appts_2017_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2017_max_xr_us <- appts_2017_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2018 data...")
    cohort_2018_min_xr <- appts_2018_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2018_min_ct <- appts_2018_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2018_max_xr <- appts_2018_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2018_max_ct <- appts_2018_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2018_min_xr_us <- appts_2018_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2018_max_xr_us <- appts_2018_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2019 data...")
    cohort_2019_min_xr <- appts_2019_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2019_min_ct <- appts_2019_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2019_max_xr <- appts_2019_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2019_max_ct <- appts_2019_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2019_min_xr_us <- appts_2019_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2019_max_xr_us <- appts_2019_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Loading 2020 data...")
    cohort_2020_min_xr <- appts_2020_xr_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR", auc = i)
    cohort_2020_min_ct <- appts_2020_ct_min[[key]] %>% mutate(cohort_type = "Minimum FU, CT", auc = i)
    cohort_2020_max_xr <- appts_2020_xr_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR", auc = i)
    cohort_2020_max_ct <- appts_2020_ct_max[[key]] %>% mutate(cohort_type = "Maximum FU, CT", auc = i)
    cohort_2020_min_xr_us <- appts_2020_xr_us_min[[key]] %>% mutate(cohort_type = "Minimum FU, XR + US", auc = i)
    cohort_2020_max_xr_us <- appts_2020_xr_us_max[[key]] %>% mutate(cohort_type = "Maximum FU, XR + US", auc = i)
    
    message("  Combining cohorts for AUC = ", key)
    overall_cohort <- dplyr::bind_rows(
      cohort_2016_min_xr, cohort_2016_min_ct, cohort_2016_max_xr, cohort_2016_max_ct, cohort_2016_min_xr_us, cohort_2016_max_xr_us,
      cohort_2017_min_xr, cohort_2017_min_ct, cohort_2017_max_xr, cohort_2017_max_ct, cohort_2017_min_xr_us, cohort_2017_max_xr_us,
      cohort_2018_min_xr, cohort_2018_min_ct, cohort_2018_max_xr, cohort_2018_max_ct, cohort_2018_min_xr_us, cohort_2018_max_xr_us,
      cohort_2019_min_xr, cohort_2019_min_ct, cohort_2019_max_xr, cohort_2019_max_ct, cohort_2019_min_xr_us, cohort_2019_max_xr_us,
      cohort_2020_min_xr, cohort_2020_min_ct, cohort_2020_max_xr, cohort_2020_max_ct, cohort_2020_min_xr_us, cohort_2020_max_xr_us
    )
    
    all_cohorts[[key]] <- overall_cohort
    message(" Done with AUC = ", key, "\n")
  }
  
  message(" Binding all AUC cohorts together...")
  final_df <- dplyr::bind_rows(all_cohorts)
  message(" All done.")
  
  return(final_df)
}
```
\newpage

#### AUC 0.55
```{r}
auc_0.55 <- aggregate_appt_cohorts(auc_target = 1)
```
\newpage

#### AUC 0.6
```{r}
auc_0.6 <- aggregate_appt_cohorts(auc_target = 2)
```
\newpage



#### AUC 0.65
```{r}
auc_0.65 <- aggregate_appt_cohorts(auc_target = 3)
```
\newpage

#### AUC 0.7
```{r}
auc_0.7 <- aggregate_appt_cohorts(auc_target = 4)
```
\newpage

#### AUC 0.75
```{r}
auc_0.75 <- aggregate_appt_cohorts(auc_target = 5)
```
\newpage

#### AUC 0.8
```{r}
auc_0.8 <- aggregate_appt_cohorts(auc_target = 6)
```
\newpage

#### AUC 0.85
```{r}
auc_0.85 <- aggregate_appt_cohorts(auc_target = 7)
```
\newpage

#### AUC 0.9
```{r}
auc_0.9 <- aggregate_appt_cohorts(auc_target = 8)
```
\newpage

#### AUC 0.95
```{r}
auc_0.95 <- aggregate_appt_cohorts(auc_target = 9)
```
\newpage

### Compare length of FU + type of imaging in terms of number of appts
```{r}
# Combine datasets and calculate cumulative dose
combine_auc_data <- function(data, auc_label) {
  data %>%
    mutate(
      auc_label = auc_label,
      risk_status = ifelse(risk_status == "LR", "Low Risk", "High Risk"),
      annual_appts = case_when(
        year == 2020 ~ appt_year_1,
        year == 2019 ~ appt_year_2,
        year == 2018 ~ appt_year_3,
        year == 2017 ~ appt_year_4,
        year == 2016 ~ appt_year_5,
        TRUE ~ NA_real_
      )
    ) %>%
    select(auc_label, cohort_type, stone_free_status, risk_status, annual_appts, true_rec_5yr)
}

# Combine all AUC datasets and filter cohort_types
data_for_plot <- bind_rows(
  combine_auc_data(auc_0.55, "AUC 0.55"),
  combine_auc_data(auc_0.6,  "AUC 0.6"),
  combine_auc_data(auc_0.65, "AUC 0.65"),
  combine_auc_data(auc_0.7,  "AUC 0.7"),
  combine_auc_data(auc_0.75, "AUC 0.75"),
  combine_auc_data(auc_0.8,  "AUC 0.8"),
  combine_auc_data(auc_0.85, "AUC 0.85"),
  combine_auc_data(auc_0.9,  "AUC 0.9"),
  combine_auc_data(auc_0.95, "AUC 0.95")
)

data_for_plot$auc_label <- as.factor(data_for_plot$auc_label)
data_for_plot$cohort_type <- as.factor(data_for_plot$cohort_type)
data_for_plot$risk_status <- as.factor(data_for_plot$risk_status)
data_for_plot$true_rec_5yr <- as.factor(data_for_plot$true_rec_5yr)

# Summarise number of appts for single year by auc_label, risk_status, cohort_type
summary_df <- data_for_plot %>%
  group_by(auc_label, risk_status, cohort_type) %>%
  summarise(
    total_appts = sum(annual_appts, na.rm = TRUE),
    .groups = "drop"
  )

# Summarise mean and SD for combined risk groups ("All")
summary_all <- data_for_plot %>%
  group_by(auc_label, cohort_type) %>%
  summarise(
    total_appts = sum(annual_appts, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(risk_status = "All") %>%
  select(auc_label, risk_status, cohort_type, total_appts)

# Combine all summaries
summary_df_appts <- bind_rows(summary_df, summary_all)
summary_df_appts <- summary_df_appts %>% mutate(
  total_appts = total_appts / 1000
)

# Factor levels for ordering
summary_df_appts <- summary_df_appts %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US"
                                                 )),
    risk_status = factor(risk_status, levels = c("All", "Low Risk", "High Risk"))
  )

# Prepare data_for_plot factors similarly
data_for_plot <- data_for_plot %>%
  mutate(
    cohort_type = factor(cohort_type, levels = c("Minimum FU, XR", 
                                                 "Minimum FU, CT", 
                                                 "Minimum FU, XR + US",
                                                 "Maximum FU, XR", 
                                                 "Maximum FU, CT", 
                                                 "Maximum FU, XR + US")),
    risk_status = factor(risk_status, levels = c("Low Risk", "High Risk"))
  )

# All auc values
auc_values <- unique(data_for_plot$auc_label)
```
\newpage

#### Plot total number of appointments for 2020 by cohort_type within risk groups - facet by FU type
```{r}
summary_df_appts %>% group_by(auc_label) %>% ggplot(aes(x = auc_label, y = total_appts, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Number of Appointments for EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Total Follow-up Appointments, n (000's)",
    fill = "Risk Status"
  )
```

#### Tabulate number of appointments
```{r}
summary_df_appts %>% 
  filter(risk_status == "All") %>%
  group_by(auc_label,
           cohort_type) %>% 
  summarise(
    total_appts = sum(round(total_appts, 0))
  ) %>%
  gt()
```
\newpage

# Optimisation of Risk Stratification
## Question 1: At what AUC does the low risk group have a <= 20% recurrence rate?
### Aggregate FU datasets
```{r}
process_auc_group <- function(df) {
  cp <- cutpointr(df, x = score, class = recurrence_year_5, 
                  method = maximize_metric, metric = sum_sens_spec)
  cutpoint <- cp$optimal_cutpoint
  
  df <- df %>%
    mutate(risk_status = if_else(score >= cutpoint, "HR", "LR"))
  
  # Pivot to long format for recurrence and death
  long_df <- df %>%
    pivot_longer(
      cols = starts_with("recurrence_year_"),
      names_to = "year",
      names_pattern = "recurrence_year_(\\d)",
      values_to = "recurrence"
    ) %>%
    left_join(
      df %>%
        pivot_longer(
          cols = starts_with("death_year_"),
          names_to = "year_death",
          names_pattern = "death_year_(\\d)",
          values_to = "death"
        ),
      by = c("risk_status", "year" = "year_death", "sex", "age", "score", "stone_free_status", "prediction", "true_rec_5yr", "age_band", "auc_target")
    ) %>%
    mutate(
      year = as.integer(year),
      survivor = if_else(death == "No", "Yes", "No")
    )
  
  # Summarize recurrence and survivors by year and risk group
  summary_data <- long_df %>%
    group_by(risk_status, year) %>%
    summarise(
      recurrence = sum(recurrence == "Yes"),
      survivors = sum(survivor == "Yes"),
      total = n(),
      .groups = "drop"
    ) %>%
    group_by(risk_status) %>%
    mutate(
      initial_n = total[year == 0],
      recurrence_pct = recurrence / initial_n * 100,
      survivors_pct = survivors / initial_n * 100,
      auc_target = unique(df$auc_target)
    ) %>%
    pivot_longer(
      cols = c(recurrence_pct, survivors_pct),
      names_to = "status",
      values_to = "percentage"
    ) %>%
    mutate(
      status = recode(status,
                      "recurrence_pct" = "Recurrence",
                      "survivors_pct" = "Survivors")
    )
  
  return(summary_data)
}
```
\newpage

### Global Recurrence Rates
#### Run results function
```{r}
# 2016
final_summary_2016 <- (complete_pop_2016_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)) 

final_summary_2016 <- final_summary_2016 %>% 
  ungroup() %>% 
  mutate(start_year = "2016")

# 2017
final_summary_2017 <- (complete_pop_2017_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)) 

final_summary_2017 <- final_summary_2017 %>% 
  ungroup() %>%
  mutate(start_year = "2017")

# 2018
final_summary_2018 <- (complete_pop_2018_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)) 

final_summary_2018 <- final_summary_2018 %>% 
  ungroup() %>% 
  mutate(start_year = "2018")

# 2019
final_summary_2019 <- (complete_pop_2019_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)) 

final_summary_2019 <- final_summary_2019 %>% 
  ungroup() %>% 
  mutate(start_year = "2019")

# 2020
final_summary_2020 <- (complete_pop_2020_fu %>%
  group_split(auc_target) %>%
  map_dfr(process_auc_group)) 
final_summary_2020 <- final_summary_2020 %>% 
  ungroup() %>%
  mutate(start_year = "2020")


all_years_summary_global <- rbind(final_summary_2016,
                           final_summary_2017,
                           final_summary_2018,
                           final_summary_2019,
                           final_summary_2020) 
```
\newpage

#### Tabulate 
```{r}
all_years_summary_global$percentage <- round(all_years_summary_global$percentage,
                                             digits = 1)


all_years_summary_global %>% 
  filter(risk_status == "LR" & year == 5 & status == "Recurrence") %>%
  select(risk_status, start_year, auc_target, percentage) %>%
  group_by(risk_status) %>%
  pivot_wider(
    names_from = auc_target,
    values_from = percentage
  ) %>% 
  mutate(
    "Risk Status" = risk_status,
    "Start Year" = start_year,
    .keep = "unused"
  ) %>% 
  select("Risk Status",
         "Start Year",
         everything()) %>%
  gt() %>% 
  tab_header(title = "Percentage of Patients with Recurrence over 5 years per AUC",
             subtitle = "For Low Risk Patients only") %>%
  gt_theme_nytimes()
```

### Recurrence rates stratified by fragment size
#### Run results function
```{r}
# 2016
grouped_data_2016 <- complete_pop_2016_fu %>% 
  group_by(auc_target, stone_free_status)

keys_2016 <- grouped_data_2016 %>% group_keys()
split_data_2016 <- grouped_data_2016 %>% group_split()

results_list_2016 <- map(split_data_2016, process_auc_group)

final_summary_2016 <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)  %>% 
  mutate(start_year = "2016")

# 2017
grouped_data_2017 <- complete_pop_2017_fu %>% 
  group_by(auc_target, stone_free_status)

keys_2017 <- grouped_data_2017 %>% group_keys()
split_data_2017 <- grouped_data_2017 %>% group_split()

results_list_2017 <- map(split_data_2017, process_auc_group)

final_summary_2017 <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)  %>% 
  mutate(start_year = "2017")

# 2018
grouped_data_2018 <- complete_pop_2018_fu %>% 
  group_by(auc_target, stone_free_status)

keys_2018 <- grouped_data_2018 %>% group_keys()
split_data_2018 <- grouped_data_2018 %>% group_split()

results_list_2018 <- map(split_data_2018, process_auc_group)

final_summary_2018 <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)  %>% 
  mutate(start_year = "2018")

# 2019
grouped_data_2019 <- complete_pop_2019_fu %>% 
  group_by(auc_target, stone_free_status)

keys_2019 <- grouped_data_2019 %>% group_keys()
split_data_2019 <- grouped_data_2019 %>% group_split()

results_list_2019 <- map(split_data_2019, process_auc_group)

final_summary_2019 <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)  %>% 
  mutate(start_year = "2019")

# 2020
grouped_data_2020 <- complete_pop_2020_fu %>% 
  group_by(auc_target, stone_free_status)

keys_2020 <- grouped_data_2020 %>% group_keys()
split_data_2020 <- grouped_data_2020 %>% group_split()

results_list_2020 <- map(split_data_2020, process_auc_group)

final_summary_2020 <- map2_dfr(
  .x = results_list,
  .y = 1:length(results_list),
  .f = function(result, index) {
    result$summary_data %>%
      mutate(
        auc_target = keys$auc_target[index],
        stone_free_status = keys$stone_free_status[index],
        # Create combined risk group identifier
        combined_risk_group = paste(stone_free_status, risk_status, sep = "_")
      )
  }
)  %>% 
  mutate(start_year = "2020")

all_years_summary <- rbind(final_summary_2016,
                           final_summary_2017,
                           final_summary_2018,
                           final_summary_2019,
                           final_summary_2020)
```
\newpage

#### Tabulate 
```{r}
all_years_summary %>% 
  filter(risk_status == "LR"  & year == 5 & status == "Cumulative Recurrence") %>%
  select(start_year, auc_target, percentage, stone_free_status) %>%
  group_by(stone_free_status) %>%
  pivot_wider(
    names_from = auc_target,
    values_from = percentage
  ) %>% 
  mutate(
    "Risk Status" = risk_status,
    "Start Year" = start_year,
    `0.55` = round(`0.55`, digits = 1),
    `0.6` = round(`0.6`, digits = 1),
    `0.65` = round(`0.65`, digits = 1),
    `0.7` = round(`0.7`, digits = 1),
    `0.75` = round(`0.75`, digits = 1),
    `0.8` = round(`0.85`, digits = 1),
    `0.85` = round(`0.85`, digits = 1),
    `0.9` = round(`0.9`, digits = 1),
    `0.95` = round(`0.95`, digits = 1),
    .keep = "unused"
  ) %>% 
  select("Risk Status",
         "Start Year",
         everything()) %>%
  gt() %>% 
  tab_header(title = "Percentage of Patients with Recurrence over 5 years per AUC",
             subtitle = "For Low Risk Patients only, and stratified by Stone Free Status") %>%
  gt_theme_nytimes()
```
\newpage

#### Plot
```{r}
# separate facets for stone_free_status
all_years_summary$start_year <- factor(all_years_summary$start_year,
                                  levels = c("2016",
                                             "2017",
                                             "2018",
                                             "2019",
                                             "2020"))

ggplot(all_years_summary, 
       aes(x = year, y = percentage, 
           color = status, 
           shape = risk_status,
           linetype = risk_status,
           fill = start_year)) +
  geom_point(size = 2.5) +
  geom_line(linewidth = 0.8) +
  facet_grid(stone_free_status ~ auc_target, 
             labeller = labeller(
               stone_free_status = function(x) tools::toTitleCase(gsub("_", " ", x)),
      auc_target = function(x) tools::toTitleCase(gsub("_", " ", x))
             )) +
  scale_color_manual(values = c("Cumulative Recurrence" = "#D55E00", "Survivors" = "#0072B2")) +
  labs(
    title = "All Years Cumulative Recurrence and Survivors by Stone-Free Status and Risk Group",
    subtitle = "Stratified by Stone-Free Status and AUC Target",
    x = "Year of Follow-up",
    y = "% of Initial Population",
    color = "Outcome",
    shape = "Risk Group",
    linetype = "Risk Group",
    fill = "Start Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text = element_text(face = "bold", size = 10),
    legend.position = "bottom"
  )
```
\newpage

## Question 2: With a model that gives the low risk group a <= 20% recurrence rate what is the cost difference between the current standard of care (AUC 0.55 + XR & US FU) and this?
### Define annual cost of minimum current standard of care for simulated dataset
```{r}
current_cost <- summary_df_full_cost_data %>%
  mutate(total_cost = total_cost * 1000000) %>% 
  filter(auc_label == "AUC 0.55" & cohort_type == "Minimum FU, XR" & risk_status == "All") 

current_cost %>%
  gt() %>% gt_theme_nytimes()
```
\newpage

### Costs for FU of LR patients in AUC >= 0.7 in Current Standard of FU (Min / Max)
```{r}
auc_0.65_all <- summary_df_full_cost_data_all_patients %>%
  mutate(total_cost = total_cost * 1000000) %>% 
  filter(auc_label == "AUC 0.65" & cohort_type == "Minimum FU, XR" | auc_label == "AUC 0.65" & cohort_type == "Maximum FU, XR") 

auc_0.65_all %>%
  gt() %>% gt_theme_nytimes()
```
\newpage

### Calculate cost differences between current standard of care and AUC 0.7 but maintaining EAU Follow-up algorithm
```{r}
auc_0.65_all %>% 
  filter(risk_status == "All") %>%
  mutate(cost_saving = current_cost$total_cost - total_cost,
         .keep = "all") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage

### Calculate cost differences between current standard of care and AUC 0.65 but removing FU for those who are LR
```{r}
auc_0.65_lr <- auc_0.65_all %>% 
  filter(risk_status == "Low Risk" & cohort_type == "Minimum FU, XR") %>% 
  mutate(lr_cost = total_cost) %>% subset(select = lr_cost)

auc_0.65_all %>% 
  filter(risk_status == "All" & cohort_type == "Minimum FU, XR") %>%
  mutate(new_total_cost = total_cost - auc_0.65_lr$lr_cost,
         cost_saving = total_cost - new_total_cost,
         .keep = "all") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage


### Calculate cost differences between current standard of care and AUC 0.7 but removing FU for those who are LR and stone free
```{r}
# Get Recurrence costs
lr_rec_only_auc_0.7 <- summary_df_full_cost_data %>% 
  filter(auc_label == "AUC 0.7" & cohort_type == "Minimum FU, XR" & risk_status == "Low Risk" |
           auc_label == "AUC 0.7" & cohort_type == "Maximum FU, XR" & risk_status == "Low Risk") %>%
  mutate(lr_rec_cost = total_cost * 1000000) %>% 
  subset(select = lr_rec_cost
  )

auc_0.7_all %>% 
  filter(risk_status == "All") %>%
  cbind(auc_0.7_lr,
        lr_rec_only_auc_0.7) %>%
  mutate(cost_saving = current_cost$total_cost - (total_cost - lr_cost + lr_rec_cost), 
  .keep = "all") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage

## Calculate difference in number of appointments between current standard of care vs AUC=0.7
```{r}
auc_0.55_all_appts <- summary_df_appts %>%
  mutate(total_appts = total_appts * 1000) %>%
  filter(auc_label == "AUC 0.55" & cohort_type == "Minimum FU, XR" | 
           auc_label == "AUC 0.55" & cohort_type == "Maximum FU, XR") %>% 
  filter(risk_status == "All")

auc_0.7_all_appts <- summary_df_appts %>%
  mutate(total_appts = total_appts * 1000) %>%
  filter(auc_label == "AUC 0.7" & cohort_type == "Minimum FU, XR" |
           auc_label == "AUC 0.7" & cohort_type == "Maximum FU, XR") 

auc_0.7_all_appts %>%
  gt() %>% gt_theme_nytimes()

auc_0.7_all_appts %>% 
  filter(risk_status == "All") %>%
  cbind(total_appts_auc_0.55 = auc_0.55_all_appts$total_appts) %>%
  mutate(appt_saving = total_appts_auc_0.55 - total_appts,
         .keep = "all") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage

## Calculate difference in number of appointments between current standard of care vs AUC=0.7 and remove LR patients
```{r}
auc_0.55_all_appts <- summary_df_appts %>%
  mutate(total_appts = total_appts * 1000) %>%
  filter(auc_label == "AUC 0.55" & cohort_type == "Minimum FU, XR" | 
           auc_label == "AUC 0.55" & cohort_type == "Maximum FU, XR") %>% 
  filter(risk_status == "High Risk")

auc_0.7_all_appts <- summary_df_appts %>%
  mutate(total_appts = total_appts * 1000) %>%
  filter(auc_label == "AUC 0.7" & cohort_type == "Minimum FU, XR" |
           auc_label == "AUC 0.7" & cohort_type == "Maximum FU, XR") 

auc_0.7_all_appts %>%
  gt() %>% gt_theme_nytimes()

auc_0.7_all_appts %>% 
  filter(risk_status == "High Risk") %>%
  cbind(total_appts_auc_0.55 = auc_0.55_all_appts$total_appts) %>%
  mutate(appt_saving = total_appts_auc_0.55 - total_appts,
         .keep = "all") %>%
  gt() %>%
  gt_theme_nytimes()
```
\newpage
