---
title: "kidney_stone_economics_full_model"
author: "R Geraghty"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 10
    fig_height: 10
    number_sections: true
    code_folding: TRUE
---
# Setup
```{r, include = FALSE, warning=FALSE}
library(knitr)
library(gt)
library(gtExtras)
library(tidyverse)
library(DiagrammeR)
library(data.table)
library(janitor)
library(DataExplorer)
library(pROC)
library(ggplot2)
library(pracma)
library(glue)
library(cutpointr)
library(caret)
library(cowplot)
library(cutpointr)
library(ggsignif)
library(ggpubr)
library(broom)
library(patchwork)
```
\newpage

# 1. Define Inputs
```{r}
source("Model/1. Define Inputs.R")
```
\newpage

# 2. Total Cost Calculation for Stone Free Patients
```{r}
source("Model/2. Total Cost Calculation for Stone Free Patients.R")
```
\newpage

# 3. Visualise Model 
```{r}
source("Model/3. Visualise Model.R")
```
\newpage

# 4. Distribution of Scores - Pick one!
## 4.1 Beta Distribution - e.g modelling a machine learning model output
```{r}
source("Model/4. Model - Beta Distribution for Scores.R")
```
\newpage

## 4.2 Normal Distribution - e.g modelling a blood test output
<br> **uncomment to run** <br>
```{r}
#source("Model/4. Model - Normal Distribution for Scores.R")
```
\newpage

# 5. Run Model
```{r}
source("Model/5. Run Model.R")
```
\newpage

## Summary plot of model 
```{r}
top_row <- plot_grid(roc_plot, density_plots,
                     labels = c("A",
                                "B"),
                     label_x = 0, label_y = 0,
                     hjust = -0.5, vjust = -0.5)

overall_simulation_plot <- plot_grid(top_row, simulation_over_time_plot,
                        labels = c("",
                                   "C"),
                        nrow = 2,
                        label_x = 0, label_y = 0,
                        hjust = -0.5, vjust = -0.5)

overall_simulation_plot
```

# 6. Radiation Dose
```{r}
source("Model/6. Radiation Dose.R")
```
\newpage

## Plot
```{r}
summary_df3 %>% ggplot(aes(x = auc_label, y=mean_dose, fill = risk_status)) + 
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(
    aes(ymin = mean_dose - sd, ymax = mean_dose + sd),
    position = position_dodge(width = 0.8),
    width = 0.2
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Mean Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 
```
\newpage

## Plot
```{r}
summary_df3 %>% ggplot(aes(x = auc_label, y=median_dose, fill = risk_status)) + 
  geom_col(position = position_dodge(width = 0.8), width = 0.7)  +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Median Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 
```
\newpage

## Plot
```{r}
data_for_plot %>% ggplot(aes(x = auc_label, y=cumulative_rad_dose, fill = risk_status)) + 
  geom_boxplot(position = position_dodge(width = 0.8)) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Cumulative 5 Year Radiation Dose",
    x = "Modelled Risk Stratification AUC-ROC",
    y = "Cumulative Radiation Dose (mSv)",
    fill = "Risk Status"
  ) 
```
\newpage

# 7. Radiation Induced Malignancy
```{r}
source("Model/7. Radiation Induced Malignancy.R")
```
\newpage

## Overall plot
```{r}
malignancy_risk_plot
```
\newpage

## Organ Specific plot
```{r}
malignancy_data_grouped$auc <- as.factor(malignancy_data_grouped$auc)
organ_specific_ear_per_person <- malignancy_data_grouped %>%
  group_by(auc, age, sex, cohort_type, risk_status, organ) %>%
  summarise(
    five_year_ear      = sum(five_year_risk, na.rm = TRUE),
    ten_year_ear       = sum(ten_year_risk, na.rm = TRUE),
    fifteen_year_ear   = sum(fifteen_year_risk, na.rm = TRUE),
    twenty_year_ear    = sum(twenty_year_risk, na.rm = TRUE),
    twentyfive_year_ear = sum(twenty_five_year_risk, na.rm = TRUE),
    thirty_year_ear    = sum(thirty_year_risk, na.rm = TRUE),
    .groups = "drop"
  )

organ_specific_ear_per_person$organ <- as.factor(organ_specific_ear_per_person$organ)


ggplot(
  organ_specific_ear_per_person_long,
  aes(x = yrs_after_first_scan, y = ear_per_1000, fill = auc)
) +
  geom_col(position = position_dodge(width = 0.8)) +
  facet_grid(cohort_type ~ organ, scales = "free_y") +
  labs(title = "Estimated Excess Absolute Solid Cancer Incidence by Individual Exposed Organ", x = "Time from 1st Imaging (years)", y = "Estimated Excess Absolute Solid Cancer Incidence, n per 1000") +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "right",
    strip.text = element_text(face = "bold")
  ) + ylim(c(0, 11))
```
\newpage

## Lifetime Expected Additional Malignancies Table
```{r}
malignancy_grand_total %>%
  group_by(cohort_type,
           risk_status,
           auc_target) %>%
  gt() %>%
  fmt_number(
    columns = grand_total_expected_malignancies,
    decimals = 0
  ) %>%
  fmt_number(
    columns = grand_total_expected_malignancies_lower,
    decimals = 0
  ) %>%
  fmt_number(
    columns = grand_total_expected_malignancies_upper,
    decimals = 0
  ) %>%
  fmt_number(
    columns = total_patients,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  cols_label(
    auc_target = "AUC Target",
    cohort_type = "Cohort Type",
    risk_status = "Risk Status",
    grand_total_expected_malignancies = "Expected Lifetime Malignancies",
    grand_total_expected_malignancies_lower = "Lower CI",
    grand_total_expected_malignancies_upper = "Upper CI",
    total_patients = "Total Patients"
  )
```
\newpage

## Plot Lifetime expected malignancies - Cohort comparisons
```{r}
malignancy_plot_data <- malignancy_grand_total %>%
  mutate(
    percentage = (grand_total_expected_malignancies / total_patients) * 100,
    percentage_lower = (grand_total_expected_malignancies_lower / total_patients) * 100,
    percentage_upper = (grand_total_expected_malignancies_upper / total_patients) * 100
  )

comparisons <- list(
  c("Maximum FU, CT", "Maximum FU, XR"),
  c("Minimum FU, CT", "Minimum FU, XR"),
  c("Maximum FU, CT", "Minimum FU, CT"),
  c("Maximum FU, XR", "Minimum FU, XR")
)

calc_chisq_pvalue <- function(data, group1, group2) {
  d1 <- data %>% filter(cohort_type == group1)
  d2 <- data %>% filter(cohort_type == group2)
  
  if(nrow(d1) == 0 || nrow(d2) == 0) return(1)
  
  mat <- matrix(
    c(d1$grand_total_expected_malignancies, 
      d1$total_patients - d1$grand_total_expected_malignancies,
      d2$grand_total_expected_malignancies,
      d2$total_patients - d2$grand_total_expected_malignancies),
    nrow = 2,
    byrow = TRUE
  )
  
  tryCatch({
    chisq.test(mat)$p.value
  }, error = function(e) 1)
}

ggplot(malignancy_plot_data, 
       aes(x = cohort_type, 
           y = percentage,
           fill = cohort_type)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = percentage_lower, 
                    ymax = percentage_upper),
                width = 0.2) +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      # Get the current facet's data
      current_data <- malignancy_plot_data %>%
        filter(cohort_type %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) +
  facet_grid(risk_status ~ auc_target,
             labeller = labeller(
               auc_target = function(x) paste0("AUC: ", x),
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by AUC Target and Risk Status",
    x = "Cohort Type",
    y = "Expected Additional Lifetime Malignancies (%)",
    fill = "Cohort Type",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                     expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )
```
\newpage

## Plot Lifetime expected malignancies - AUC comparisons - Proportions
```{r}
# Get unique AUC target values for comparisons
auc_values <- unique(as.factor(malignancy_plot_data$auc_target))

ref_auc <- "0.55"

# Define pairwise comparisons for AUC targets
comparisons <- lapply(setdiff(auc_values, ref_auc), function(x) c(ref_auc, x))

# Updated function to compare by auc_target instead of cohort_type
calc_chisq_pvalue <- function(data, group1, group2) {
  d1 <- data %>% filter(auc_target == group1)
  d2 <- data %>% filter(auc_target == group2)
  
  if(nrow(d1) == 0 || nrow(d2) == 0) return(1)
  
  mat <- matrix(
    c(d1$grand_total_expected_malignancies, 
      d1$total_patients - d1$grand_total_expected_malignancies,
      d2$grand_total_expected_malignancies,
      d2$total_patients - d2$grand_total_expected_malignancies),
    nrow = 2,
    byrow = TRUE
  )
  
  tryCatch({
    chisq.test(mat)$p.value
  }, error = function(e) 1)
}

ggplot(malignancy_plot_data, 
       aes(x = as.factor(auc_target), 
           y = percentage,
           fill = auc_target)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = percentage_lower, 
                    ymax = percentage_upper),
                width = 0.2) +
  facet_grid(risk_status ~ cohort_type,
             labeller = labeller(
               cohort_type = function(x) x,
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by Cohort Type and Risk Status",
    x = "AUC Target",
    y = "Expected Additional Lifetime Malignancies (%)",
    fill = "AUC Target",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                     expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )  +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      current_data <- malignancy_plot_data %>%
        filter(auc_target %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) 
```
\newpage

## Plot Lifetime expected malignancies - AUC comparisons - Numbers
```{r}
ggplot(malignancy_plot_data, 
       aes(x = as.factor(auc_target), 
           y = grand_total_expected_malignancies,
           fill = auc_target)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = grand_total_expected_malignancies_lower, 
                    ymax = grand_total_expected_malignancies_upper),
                width = 0.2) +
  facet_grid(risk_status ~ cohort_type,
             labeller = labeller(
               cohort_type = function(x) x,
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies by Cohort Type and Risk Status",
    x = "AUC Target",
    y = "Expected Additional Lifetime Malignancies, n",
    fill = "AUC Target",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  )  +
  geom_signif(
    comparisons = comparisons,
    test = function(x, y) {
      current_data <- malignancy_plot_data %>%
        filter(auc_target %in% c(x, y))
      
      if(nrow(current_data) < 2) return(list(p.value = 1))
      
      p_val <- calc_chisq_pvalue(current_data, unique(x), unique(y))
      list(p.value = p_val)
    },
    map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
    step_increase = 0.08,
    tip_length = 0.01,
    size = 0.4,
    textsize = 3
  ) 
```
\newpage

## Plot Relative Lifetime expected malignancies Compared to Baseline - AUC comparisons - Numbers
```{r}
baseline_malignancies <- malignancy_plot_data %>%
  filter(auc_target == 0.55) %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  select(
    risk_status,
    grand_total_expected_malignancies,
    grand_total_expected_malignancies_lower,
    grand_total_expected_malignancies_upper
  )

baseline_malignancies_hr <- (baseline_malignancies %>%
                               filter(risk_status == "High Risk"))$grand_total_expected_malignancies

baseline_malignancies_hr_upper <- (baseline_malignancies %>%
                               filter(risk_status == "High Risk"))$grand_total_expected_malignancies_upper

baseline_malignancies_hr_lower <- (baseline_malignancies %>%
                               filter(risk_status == "High Risk"))$grand_total_expected_malignancies_lower

baseline_malignancies_lr <- (baseline_malignancies %>%
                               filter(risk_status == "Low Risk"))$grand_total_expected_malignancies

baseline_malignancies_lr_upper <- (baseline_malignancies %>%
                               filter(risk_status == "Low Risk"))$grand_total_expected_malignancies_upper

baseline_malignancies_lr_lower <- (baseline_malignancies %>%
                               filter(risk_status == "Low Risk"))$grand_total_expected_malignancies_lower
  

malignancy_plot_data %>%
  mutate(grand_total_expected_malignancies = case_when(
    risk_status == "High Risk" ~ grand_total_expected_malignancies - baseline_malignancies_hr,
    risk_status == "Low Risk" ~  grand_total_expected_malignancies - baseline_malignancies_lr
  ),
  grand_total_expected_malignancies_lower = case_when(
    risk_status == "High Risk" ~ grand_total_expected_malignancies_lower - baseline_malignancies_hr_lower,
    risk_status == "Low Risk" ~  grand_total_expected_malignancies_lower - baseline_malignancies_lr_lower
  ),
  grand_total_expected_malignancies_upper = case_when(
    risk_status == "High Risk" ~ grand_total_expected_malignancies_upper - baseline_malignancies_hr_upper,
    risk_status == "Low Risk" ~  grand_total_expected_malignancies_upper - baseline_malignancies_lr_upper
  )
  ) %>%
  ggplot(aes(x = as.factor(auc_target), 
           y = grand_total_expected_malignancies,
           fill = auc_target)) +
  geom_col(color = "black", linewidth = 0.3) +
  geom_errorbar(aes(ymin = grand_total_expected_malignancies_lower, 
                    ymax = grand_total_expected_malignancies_upper),
                width = 0.2) +
  facet_grid(risk_status ~ cohort_type,
             labeller = labeller(
               cohort_type = function(x) x,
               risk_status = function(x) paste0("Risk: ", x)
             )) +
  labs(
    title = "Expected Lifetime Malignancies Compared to Baseline by Cohort Type and Risk Status",
    x = "AUC Target",
    y = "Difference in Expected Additional Lifetime Malignancies, n",
    fill = "AUC Target",
    caption = "Pairwise chi-squared tests; * p<0.05, ** p<0.01, *** p<0.001, ns = not significant"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.25))) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.background = element_rect(fill = "lightblue", color = "black"),
    strip.text = element_text(face = "bold", size = 10),
    panel.border = element_rect(color = "grey80", fill = NA, linewidth = 0.5),
    panel.spacing = unit(0.5, "lines"),
    legend.position = "bottom"
  ) 
```
\newpage

## Plot Relative Lifetime expected malignancies Compared to Baseline - AUC comparisons - Proportions
```{r}
all_malignancies <- malignancy_plot_data %>%
  group_by(auc_target,
           cohort_type
           ) %>%
  summarise(
    grand_total_expected_malignancies = sum(grand_total_expected_malignancies),
    grand_total_expected_malignancies_lower = sum(grand_total_expected_malignancies_lower),
    grand_total_expected_malignancies_upper = sum(grand_total_expected_malignancies_upper),
    total_patients = sum(total_patients),
    percentage = (grand_total_expected_malignancies / total_patients) * 100,
    percentage_lower = (grand_total_expected_malignancies_lower / total_patients) * 100,
    percentage_upper = (grand_total_expected_malignancies_upper / total_patients) * 100
  ) %>% 
  ungroup() %>%
  mutate(
    risk_status = as.factor("All")
  ) %>% select(
    risk_status, auc_target, cohort_type, grand_total_expected_malignancies, grand_total_expected_malignancies_lower,
    grand_total_expected_malignancies_upper,
    total_patients,
    percentage,
    percentage_lower,
    percentage_upper
  )

baseline_malignancies_perc <- malignancy_plot_data %>%
  rbind(all_malignancies) %>%
  mutate(
    risk_status = factor(risk_status,
                         levels = c("All",
                                    "High Risk",
                                    "Low Risk"))
  ) %>%
  filter(auc_target == 0.55) %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  select(
    risk_status,
    percentage,
    percentage_lower,
    percentage_upper
  )

baseline_malignancies_perc_hr <- (baseline_malignancies_perc %>%
                               filter(risk_status == "High Risk"))$percentage

baseline_malignancies_perc_hr_upper <- (baseline_malignancies_perc %>%
                               filter(risk_status == "High Risk"))$percentage_upper

baseline_malignancies_perc_hr_lower <- (baseline_malignancies_perc %>%
                               filter(risk_status == "High Risk"))$percentage_lower

baseline_malignancies_perc_lr <- (baseline_malignancies_perc %>%
                               filter(risk_status == "Low Risk"))$percentage

baseline_malignancies_perc_lr_upper <- (baseline_malignancies_perc %>%
                               filter(risk_status == "Low Risk"))$percentage_upper

baseline_malignancies_perc_lr_lower <- (baseline_malignancies_perc %>%
                               filter(risk_status == "Low Risk"))$percentage_lower


baseline_malignancies_perc_all <- (baseline_malignancies_perc %>%
                               filter(risk_status == "All"))$percentage

baseline_malignancies_perc_all_upper <- (baseline_malignancies_perc %>%
                               filter(risk_status == "All"))$percentage_upper

baseline_malignancies_perc_all_lower <- (baseline_malignancies_perc %>%
                               filter(risk_status == "All"))$percentage_lower
  

baseline_malignancies_perc_plot <- malignancy_plot_data %>%
  rbind(all_malignancies) %>%
  mutate(
    auc_target = as.factor(paste0("AUC ", auc_target)),
    cohort_type = factor(
      cohort_type,
      levels = c(
        "Minimum FU, XR",
        "Minimum FU, XR + US",
        "Minimum FU, CT",
        "Maximum FU, XR",
        "Maximum FU, XR + US",
        "Maximum FU, CT"
      )
    ),
    risk_status = factor(risk_status,
                         levels = c("All",
                                    "Low Risk",
                                    "High Risk")),
    percentage = case_when(
      risk_status == "High Risk" ~ percentage - baseline_malignancies_perc_hr,
      risk_status == "Low Risk" ~ percentage - baseline_malignancies_perc_lr,
      risk_status == "All" ~ percentage - baseline_malignancies_perc_all,
    ),
    percentage_lower = case_when(
      risk_status == "High Risk" ~ percentage_lower - baseline_malignancies_perc_hr_lower,
      risk_status == "Low Risk" ~ percentage_lower - baseline_malignancies_perc_lr_lower,
      risk_status == "All" ~ percentage_lower - baseline_malignancies_perc_all_lower
    ),
    percentage_upper = case_when(
      risk_status == "High Risk" ~ percentage_upper - baseline_malignancies_perc_hr_upper,
      risk_status == "Low Risk" ~ percentage_upper - baseline_malignancies_perc_lr_upper,
      risk_status == "All" ~ percentage_upper - baseline_malignancies_perc_all_upper
    )
  ) %>%
  ggplot(aes(
    x = as.factor(auc_target),
    y = percentage,
    fill = risk_status
  )) +
  geom_col(color = "black") +
  geom_errorbar(aes(ymin = percentage_lower,
                    ymax = percentage_upper),
                width = 0.2) +
  facet_grid(
    risk_status ~ cohort_type,
    labeller = labeller(
      cohort_type = function(x)
        x,
      risk_status = function(x)
        x
    )
  ) +
  labs(title = "Lifetime Malignancies",
       x = "AUC Target",
       y = "Additional Malignancies vs Baseline (%)",
       fill = "Risk Status") +
  scale_y_continuous(
    labels = function(x)
      paste0(x, "%"),
    expand = expansion(mult = c(0, 0.25))
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10))

baseline_malignancies_perc_plot
```
\newpage

# 8. Economic Costs - All Patients
```{r}
source("Model/8. Economic Costs - All Patients.R")
```
\newpage

## Plot total cost by cohort_type within risk groups - facet by FU type
```{r}
summary_df_full_cost_data %>% 
  group_by(auc_label) %>% 
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Plot cost compared to baseline by cohort_type within risk groups - facet by FU type
```{r}
baseline_costs <- summary_df_full_cost_data %>%
  filter(auc_label == "AUC 0.55") %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  mutate(auc_label == "Baseline")

baseline_cost_all <- baseline_costs %>%
  filter(risk_status == "All") %>%
  select(total_cost)
baseline_cost_all <- baseline_cost_all$total_cost

baseline_cost_hr <- baseline_costs %>%
  filter(risk_status == "High Risk") %>%
  select(total_cost)
baseline_cost_hr <- baseline_cost_hr$total_cost

baseline_cost_lr <- baseline_costs %>%
  filter(risk_status == "Low Risk") %>%
  select(total_cost)
baseline_cost_lr <- baseline_cost_lr$total_cost

summary_df_full_cost_plot <- summary_df_full_cost_data %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR",
                           "Minimum FU, XR + US",
                           "Minimum FU, CT",
                           "Maximum FU, XR",
                           "Maximum FU, XR + US",
                           "Maximum FU, CT"
                         )),
    total_cost = case_when(
    risk_status == "All" ~ (total_cost - baseline_cost_all),
    risk_status == "High Risk" ~ (total_cost - baseline_cost_hr),
    risk_status == "Low Risk" ~ (total_cost - baseline_cost_lr),
  )) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost",
    x = "Cohort Type",
    y = "Cost Difference (£ Millions)",
    fill = "Risk Status"
  )

summary_df_full_cost_plot
```
\newpage

## Plot total cost by cohort_type within risk groups - facet by auc
```{r}
summary_df_full_cost_data %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual  Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Plot total cost by cohort_type within risk groups - facet by risk status
```{r}
summary_df_full_cost_data %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = auc_label)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Summary table
```{r}
summary_df_full_cost_data %>% subset(risk_status == "All") %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()
```
\newpage

## Summary table by risk status
```{r}
summary_df_full_cost_data %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()

summary_df_full_cost_data_all_patients <- summary_df_full_cost_data
```
\newpage

# 9. Economic Costs - Recurrence only
```{r}
source("Model/9. Economic Costs - Recurrence only.R")
```
\newpage

## Plot total cost by cohort_type within risk groups - facet by FU type
```{r}
summary_df_rec_only %>% 
  group_by(auc_label) %>% 
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for EAU Follow-Up of those with Clinically Significant Disease - Recurrence Only",
    x = "Cohort Type",
    y = "Total Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Plot cost compared to baseline by cohort_type within risk groups - facet by FU type
```{r}
baseline_costs_rec_only <- summary_df_rec_only %>%
  filter(auc_label == "AUC 0.55") %>%
  filter(cohort_type == "Minimum FU, XR") %>%
  mutate(auc_label == "Baseline")

baseline_cost_all_rec_only <- baseline_costs_rec_only %>%
  filter(risk_status == "All") %>%
  select(total_cost)
baseline_cost_all_rec_only <- baseline_cost_all_rec_only$total_cost

baseline_cost_hr_rec_only <- baseline_costs_rec_only %>%
  filter(risk_status == "High Risk") %>%
  select(total_cost)
baseline_cost_hr_rec_only <- baseline_cost_hr_rec_only$total_cost

baseline_cost_lr_rec_only <- baseline_costs_rec_only %>%
  filter(risk_status == "Low Risk") %>%
  select(total_cost)
baseline_cost_lr_rec_only <- baseline_cost_lr_rec_only$total_cost

summary_df_rec_only %>%
  mutate(total_cost = case_when(
    risk_status == "All" ~ (baseline_cost_all_rec_only - total_cost),
    risk_status == "High Risk" ~ (baseline_cost_hr_rec_only - total_cost),
    risk_status == "Low Risk" ~ (baseline_cost_lr_rec_only - total_cost),
  )) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost Difference for EAU Follow-Up of those with Clinically Significant Disease - Recurrence Only",
    x = "Cohort Type",
    y = "Annual Cost Difference compared to baseline (£ Millions)",
    fill = "Risk Status"
  )
```

## Plot total cost by cohort_type within risk groups - facet by auc
```{r}
summary_df_rec_only %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ auc_label) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease - Recurrence Only",
    x = "Cohort Type",
    y = "Total Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Plot total cost by cohort_type within risk groups - facet by risk status
```{r}
summary_df_rec_only %>% group_by(cohort_type) %>% ggplot(aes(x = cohort_type, y = total_cost, fill = auc_label)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease - Recurrence Only",
    x = "Cohort Type",
    y = "Total Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```
\newpage

## Plot total cost by auc - facet by risk status and cohort_type
```{r}
summary_df_rec_only %>% 
  group_by(auc_label) %>% 
  ggplot(aes(x = auc_label, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_grid(risk_status ~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost for Maximum EAU Follow-Up of those with Clinically Significant Disease - Recurrence Only",
    x = "Cohort Type",
    y = "Annual Cost of Follow-up (£ Millions)",
    fill = "Risk Status"
  )
```


## Summary table for Recurrence Only
```{r}
summary_df_rec_only %>% subset(risk_status == "All") %>% group_by(auc_label,
                        risk_status) %>% gt() %>% gt_theme_nytimes()
```
\newpage

# 10. Clinician Time - Number of Appointments
```{r}
source("Model/10. Clinician Time.R")
```
\newpage

## Plot total number of appointments for 2020 by cohort_type within risk groups - facet by FU type
```{r}
summary_df_appts %>% group_by(auc_label) %>% ggplot(aes(x = auc_label, y = total_appts, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Number of Appointments for EAU Follow-Up of those with Clinically Significant Disease",
    x = "Cohort Type",
    y = "Total Follow-up Appointments, n (000's)",
    fill = "Risk Status"
  )
```
\newpage

## Plot  number of appointments for 2020 compared to baseline by cohort_type within risk groups - facet by FU type
```{r}
baseline_appts <- summary_df_appts %>%
  filter(auc_label == "AUC 0.55") %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  mutate(auc_label == "Baseline")

baseline_appt_all <- baseline_appts %>%
  filter(risk_status == "All") %>%
  select(total_appts)
baseline_appt_all <- baseline_appt_all$total_appts

baseline_appt_hr <- baseline_appts %>%
  filter(risk_status == "High Risk") %>%
  select(total_appts)
baseline_appt_hr <- baseline_appt_hr$total_appts

baseline_appt_lr <- baseline_appts %>%
  filter(risk_status == "Low Risk") %>%
  select(total_appts)
baseline_appt_lr <- baseline_appt_lr$total_appts

summary_df_appts_plot <- summary_df_appts %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR",
                           "Minimum FU, XR + US",
                           "Minimum FU, CT",
                           "Maximum FU, XR",
                           "Maximum FU, XR + US",
                           "Maximum FU, CT"
                         )),
    total_appts = case_when(
    risk_status == "All" ~ (total_appts - baseline_appt_all),
    risk_status == "High Risk" ~ (total_appts - baseline_appt_hr),
    risk_status == "Low Risk" ~ (total_appts - baseline_appt_lr),
  )) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = total_appts, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Appointments",
    x = "Cohort Type",
    y = "Appointments Difference (n, 000s)",
    fill = "Risk Status"
  )
```


## Tabulate number of appointments
```{r}
summary_df_appts %>% 
  filter(risk_status == "All") %>%
  group_by(auc_label,
           cohort_type) %>% 
  summarise(
    total_appts = sum(round(total_appts, 0))
  ) %>%
  gt()
```
\newpage


# 11. Quality of Life
```{r}
source("Model/11. Quality of Life.R")
```
\newpage

## Plot QALYs
```{r}
summary_df_full_qol_data %>% 
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = mean_qaly_5yr, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr, ymax = upper_qaly_5yr),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "USIQoL Adjusted Life Years for EAU Follow-Up of those with Clinically Significant Disease",
       x = "Cohort Type",
       y = "Mean QALYs over 5yrs follow-up",
       fill = "Risk Status") + ylim(0,3.2)
```
\newpage

## Plot QALYs vs baseline
```{r}
baseline_qaly_all1 <- summary_df_full_qol_data %>%
  filter(auc_label == "AUC 0.55") %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  select(
    risk_status,
    mean_qaly_5yr,
    lower_qaly_5yr,
    upper_qaly_5yr
  )

baseline_qaly_all <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$mean_qaly_5yr 
baseline_qaly_hr <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$mean_qaly_5yr 
baseline_qaly_lr <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$mean_qaly_5yr 

baseline_qaly_all_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$upper_qaly_5yr 
baseline_qaly_hr_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$upper_qaly_5yr 
baseline_qaly_lr_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$upper_qaly_5yr 

baseline_qaly_all_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$lower_qaly_5yr 
baseline_qaly_hr_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$lower_qaly_5yr 
baseline_qaly_lr_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$lower_qaly_5yr 


summary_df_full_qol_plot <- summary_df_full_qol_data %>% 
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR",
                           "Minimum FU, XR + US",
                           "Minimum FU, CT",
                           "Maximum FU, XR",
                           "Maximum FU, XR + US",
                           "Maximum FU, CT"
                         )),
    mean_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (mean_qaly_5yr - baseline_qaly_all),
      risk_status == "High Risk" ~ (mean_qaly_5yr - baseline_qaly_hr),
      risk_status == "Low Risk" ~ (mean_qaly_5yr - baseline_qaly_lr),
      TRUE ~ NA_integer_
    ),
    lower_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (upper_qaly_5yr - baseline_qaly_all_upper),
      risk_status == "High Risk" ~ (upper_qaly_5yr - baseline_qaly_hr_upper),
      risk_status == "Low Risk" ~ (upper_qaly_5yr - baseline_qaly_lr_upper),
      TRUE ~ NA_integer_
    ),
    upper_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (lower_qaly_5yr - baseline_qaly_all_lower),
      risk_status == "High Risk" ~ (lower_qaly_5yr - baseline_qaly_hr_lower),
      risk_status == "Low Risk" ~ (lower_qaly_5yr - baseline_qaly_lr_lower),
      TRUE ~ NA_integer_
    ),
    .keep = "all"
  ) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = mean_qaly_5yr_comp, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr_comp, ymax = upper_qaly_5yr_comp),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Quality of Life",
       x = "Cohort Type",
       y = "5yr QALYs Difference",
       fill = "Risk Status") + ylim(-0.09,0.07)

summary_df_full_qol_plot
```
\newpage


# 12. Calculate ICER 
```{r}
source("Model/12. Calculate ICER.R")
```
\newpage

## ICER Results:
*Comparison to Minimum Length of Follow-up with XR or US* \n

### AUC 0.55 only
```{r}
icer_0.55 %>% 
  gt() %>%
  gt_theme_nytimes()
```
\newpage

### All AUCs
```{r}
icer_results %>% 
  gt() %>% 
  gt_theme_nytimes()
```
\newpage

# 13. CO2 Emissions
```{r}
source("Model/13. Calculate CO2 emissions.R")
```
\newpage

# 14. Summary plots 
## Paper 1
### Collate data
```{r}
# Costs
summary_df_full_cost_plot_paper1 <- summary_df_full_cost_data %>%
  filter(auc_label == "AUC 0.55") %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         )),
    total_cost = case_when(
    risk_status == "All" ~ (total_cost - baseline_cost_all),
    risk_status == "High Risk" ~ (total_cost - baseline_cost_hr),
    risk_status == "Low Risk" ~ (total_cost - baseline_cost_lr),
  )) %>%
  group_by(cohort_type) %>%
  ggplot(aes(x = cohort_type, y = total_cost, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Cost",
    x = "Cohort Type",
    y = "Cost Difference (£ Millions)",
    fill = "Risk Status"
  )


# Appts 
summary_df_appts_plot_paper1 <- summary_df_appts %>% 
  filter(auc_label == "AUC 0.55") %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         )),
    total_appts = case_when(
      risk_status == "All" ~ (total_appts - baseline_appt_all),
      risk_status == "High Risk" ~ (total_appts - baseline_appt_hr),
      risk_status == "Low Risk" ~ (total_appts - baseline_appt_lr),
    )
  ) %>%
  ggplot(aes(x = cohort_type, y = total_appts, fill = risk_status)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  facet_wrap(~ risk_status) +  
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 10)
  ) +
  labs(
    title = "Annual Appointments",
    x = "Cohort Type",
    y = "Appointments Difference (n, 000s)",
    fill = "Risk Status"
  ) 


# Malignancies
baseline_malignancies_perc_plot_paper1 <- malignancy_plot_data %>%
  rbind(all_malignancies) %>%
  mutate(
    auc_target = as.factor(paste0("AUC ", auc_target))
  ) %>%
  filter(auc_target == "AUC 0.55") %>%
  mutate(
    cohort_type = factor(
      cohort_type,
      levels = c(
        "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
      )
    ),
    risk_status = factor(risk_status,
                         levels = c(
                           "All",
                           "Low Risk",
                           "High Risk"
                         )),
    percentage = case_when(
      risk_status == "High Risk" ~ percentage - baseline_malignancies_perc_hr,
      risk_status == "Low Risk" ~ percentage - baseline_malignancies_perc_lr,
      risk_status == "All" ~ percentage - baseline_malignancies_perc_all,
    ),
    percentage_lower = case_when(
      risk_status == "High Risk" ~ percentage_lower - baseline_malignancies_perc_hr_lower,
      risk_status == "Low Risk" ~ percentage_lower - baseline_malignancies_perc_lr_lower,
      risk_status == "All" ~ percentage_lower - baseline_malignancies_perc_all_lower
    ),
    percentage_upper = case_when(
      risk_status == "High Risk" ~ percentage_upper - baseline_malignancies_perc_hr_upper,
      risk_status == "Low Risk" ~ percentage_upper - baseline_malignancies_perc_lr_upper,
      risk_status == "All" ~ percentage_upper - baseline_malignancies_perc_all_upper
    )
  ) %>%
  ggplot(aes(
    x = cohort_type,
    y = percentage,
    fill = risk_status
  )) +
  geom_col(color = "black") +
  geom_errorbar(aes(
    ymin = percentage_lower,
    ymax = percentage_upper
  ), width = 0.2) +
  facet_wrap(
    ~ risk_status
  ) +
  labs(
    title = "Lifetime Malignancies",
    x = "Cohort Type",
    y = "Additional Malignancies Difference (%)",
    fill = "Risk Status"
  ) +
  scale_y_continuous(
    labels = function(x) paste0(x, "%"),
    expand = expansion(mult = c(0, 0.25))
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10))


# QoL
summary_df_full_qol_plot_paper1 <- summary_df_full_qol_data %>% 
  filter(auc_label == "AUC 0.55") %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         )),
    mean_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (mean_qaly_5yr - baseline_qaly_all),
      risk_status == "High Risk" ~ (mean_qaly_5yr - baseline_qaly_hr),
      risk_status == "Low Risk" ~ (mean_qaly_5yr - baseline_qaly_lr),
      TRUE ~ NA_integer_
    ),
    lower_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (upper_qaly_5yr - baseline_qaly_all_upper),
      risk_status == "High Risk" ~ (upper_qaly_5yr - baseline_qaly_hr_upper),
      risk_status == "Low Risk" ~ (upper_qaly_5yr - baseline_qaly_lr_upper),
      TRUE ~ NA_integer_
    ),
    upper_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (lower_qaly_5yr - baseline_qaly_all_lower),
      risk_status == "High Risk" ~ (lower_qaly_5yr - baseline_qaly_hr_lower),
      risk_status == "Low Risk" ~ (lower_qaly_5yr - baseline_qaly_lr_lower),
      TRUE ~ NA_integer_
    ),
    .keep = "all"
  ) %>%
  ggplot(aes(x = cohort_type, y = mean_qaly_5yr_comp, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr_comp, ymax = upper_qaly_5yr_comp),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Quality of Life",
       x = "Cohort Type",
       y = "5yr QALYs Difference",
       fill = "Risk Status") + ylim(-0.05,0.02) 
```
\newpage

### Plot
```{r}
paper_1_plot <- (
  summary_df_full_cost_plot_paper1 +
    summary_df_appts_plot_paper1 +
    baseline_malignancies_perc_plot_paper1 +
    summary_df_full_qol_plot_paper1
) +
  plot_layout(nrow = 2, ncol = 2) +
  plot_annotation(tag_levels = "A",
                  title = "Variations in Length/Imaging Modality of Follow-up Compared to Current Minimum Standard of Care") + plot_layout(axis_titles = "collect",
                                                                                                                                           guides = "collect")

paper_1_plot
```
\newpage

## Paper 2
```{r}
paper_2_plot <- (
  summary_df_full_cost_plot +
    summary_df_appts_plot +
    baseline_malignancies_perc_plot +
    summary_df_full_qol_plot
) +
  plot_layout(nrow = 2, ncol = 2) +
  plot_annotation(tag_levels = "A",
                  title = "Variations in Length/Imaging Modality of Follow-up Compared to Current Minimum Standard of Care") + plot_layout(axis_titles = "collect",
                                                                                                                                           guides = "collect")

paper_2_plot
```
\newpage

# 15. QoL - EQ-5D
```{r}
source("Model/11. Quality of Life - EQ-5D.R")
```
\newpage

## Plot EQ-5D scores
```{r}
summary_df_full_qol_data_eq_5d %>% 
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = total_qol, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = total_qol_lower, ymax = total_qol_upper),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Annual Mean EQ-5D-5L score for EAU Follow-Up of those with Clinically Significant Disease",
       x = "Cohort Type",
       y = "EQ-5D-5L score",
       fill = "Risk Status")
```
\newpage

## Plot QALYs
```{r}
summary_df_full_qol_data_eq_5d %>% 
  mutate(cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         ))) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = mean_qaly_5yr, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr, ymax = upper_qaly_5yr),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Mean Quality Adjusted Life Years for EAU Follow-Up of those with Clinically Significant Disease",
       x = "Cohort Type",
       y = "Mean 5yr QALYs (EQ-5D-5L)",
       fill = "Risk Status") + ylim(0,1)
```
\newpage

## Plot QALYs vs baseline
```{r}
baseline_qaly_all1 <- summary_df_full_qol_data %>%
  filter(auc_label == "AUC 0.55") %>%
  filter(cohort_type == "Minimum FU, XR + US") %>%
  select(
    risk_status,
    mean_qaly_5yr,
    lower_qaly_5yr,
    upper_qaly_5yr
  )

baseline_qaly_all <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$mean_qaly_5yr 
baseline_qaly_hr <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$mean_qaly_5yr 
baseline_qaly_lr <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$mean_qaly_5yr 

baseline_qaly_all_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$upper_qaly_5yr 
baseline_qaly_hr_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$upper_qaly_5yr 
baseline_qaly_lr_upper <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$upper_qaly_5yr 

baseline_qaly_all_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "All"))$lower_qaly_5yr 
baseline_qaly_hr_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "High Risk"))$lower_qaly_5yr 
baseline_qaly_lr_lower <- (baseline_qaly_all1 %>%
  filter(risk_status == "Low Risk"))$lower_qaly_5yr 


summary_df_full_qol_plot <- summary_df_full_qol_data %>% 
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         )),
    mean_qaly_5yr_comp = case_when(
      risk_status == "All"       ~ mean_qaly_5yr - baseline_qaly_all,
      risk_status == "High Risk" ~ mean_qaly_5yr - baseline_qaly_hr,
      risk_status == "Low Risk"  ~ mean_qaly_5yr - baseline_qaly_lr,
      TRUE ~ NA_real_
    ),
    lower_qaly_5yr_comp = case_when(
      risk_status == "All"       ~ lower_qaly_5yr - baseline_qaly_all,
      risk_status == "High Risk" ~ lower_qaly_5yr - baseline_qaly_hr,
      risk_status == "Low Risk"  ~ lower_qaly_5yr - baseline_qaly_lr,
      TRUE ~ NA_real_
    ),
    upper_qaly_5yr_comp = case_when(
      risk_status == "All"       ~ upper_qaly_5yr - baseline_qaly_all,
      risk_status == "High Risk" ~ upper_qaly_5yr - baseline_qaly_hr,
      risk_status == "Low Risk"  ~ upper_qaly_5yr - baseline_qaly_lr,
      TRUE ~ NA_real_
    ),
    .keep = "all"
  ) %>%
  group_by(auc_label) %>%
  ggplot(aes(x = auc_label, y = mean_qaly_5yr_comp, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr_comp, ymax = upper_qaly_5yr_comp),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ cohort_type) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Quality of Life",
       x = "Cohort Type",
       y = "5yr QALYs Difference",
       fill = "Risk Status") 

summary_df_full_qol_plot
```
\newpage

# 16. Calculate ICER with EQ-5D data
```{r}
source("Model/12. Calculate ICER.R")
```
\newpage

## ICER Results:
*Comparison to Minimum Length of Follow-up with XR or US* \n

### AUC 0.55 only
```{r}
icer_0.55 %>% 
  gt() %>%
  gt_theme_nytimes()
```
\newpage

### All AUCs
*Baseline = AUC 0.55, Minimum FU, XR + US* <br>
```{r}
icer_results %>% 
  group_by(auc) %>%
  gt() %>% 
  gt_theme_nytimes()
```
\newpage

# 17. Summary plots with EQ-5D data
## Paper 1
### Collate data
```{r}
# QoL
summary_df_full_qol_plot_eq5d_paper1 <- summary_df_full_qol_data_eq_5d %>% 
  filter(auc_label == "AUC 0.55") %>%
  mutate(
    cohort_type = factor(cohort_type,
                         levels = c(
                           "Minimum FU, XR + US",
                           "Minimum FU, XR",
                           "Minimum FU, CT",
                           "Maximum FU, XR + US",
                           "Maximum FU, XR",
                           "Maximum FU, CT"
                         )),
    mean_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (mean_qaly_5yr - baseline_qaly_all),
      risk_status == "High Risk" ~ (mean_qaly_5yr - baseline_qaly_hr),
      risk_status == "Low Risk" ~ (mean_qaly_5yr - baseline_qaly_lr),
      TRUE ~ NA_integer_
    ),
    lower_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (upper_qaly_5yr - baseline_qaly_all_upper),
      risk_status == "High Risk" ~ (upper_qaly_5yr - baseline_qaly_hr_upper),
      risk_status == "Low Risk" ~ (upper_qaly_5yr - baseline_qaly_lr_upper),
      TRUE ~ NA_integer_
    ),
    upper_qaly_5yr_comp = case_when(
      risk_status == "All" ~ (lower_qaly_5yr - baseline_qaly_all_lower),
      risk_status == "High Risk" ~ (lower_qaly_5yr - baseline_qaly_hr_lower),
      risk_status == "Low Risk" ~ (lower_qaly_5yr - baseline_qaly_lr_lower),
      TRUE ~ NA_integer_
    ),
    .keep = "all"
  ) %>%
  ggplot(aes(x = cohort_type, y = mean_qaly_5yr_comp, fill = risk_status)) +
  geom_col(
    position = position_dodge(width = 0.8),
    width = 0.7,
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = lower_qaly_5yr_comp, ymax = upper_qaly_5yr_comp),
    position = position_dodge(width = 0.8),
    width = 0.3
  ) +
  facet_wrap(~ risk_status) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10)) +
  labs(title = "Quality of Life",
       x = "Cohort Type",
       y = "5yr QALYs Difference",
       fill = "Risk Status") 
```
\newpage

### Plot Overall Results
```{r}
paper_1_plot <- (
  summary_df_full_cost_plot_paper1 +
    summary_df_appts_plot_paper1 +
    baseline_malignancies_perc_plot_paper1 +
    summary_df_full_qol_plot_eq5d_paper1
) +
  plot_layout(nrow = 2, ncol = 2) +
  plot_annotation(tag_levels = "A", title = "Variations in Length/Imaging Modality of Follow-up Compared to Current Minimum Standard of Care") + plot_layout(axis_titles = "collect", guides = "collect")

paper_1_plot
```
\newpage

### Cost-effectiveness Analyses
```{r}
auc_0.55_icer_plots & theme_bw()
```
\newpage

## Paper 2
### Plot overall results
```{r}
paper_2_plot <- (
  summary_df_full_cost_plot +
    summary_df_appts_plot +
    baseline_malignancies_perc_plot +
    summary_df_full_qol_plot
) +
  plot_layout(nrow = 2, ncol = 2) +
  plot_annotation(tag_levels = "A", title = "Variations in Length/Imaging Modality of Follow-up Compared to Current Minimum Standard of Care") + plot_layout(axis_titles = "collect", guides = "collect")

paper_2_plot
```
\newpage
